<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Jianlessçš„åšå®¢">
<meta property="og:url" content="http://coderzhou.com/index.html">
<meta property="og:site_name" content="Jianlessçš„åšå®¢">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jianlessçš„åšå®¢">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>




  <link rel="canonical" href="http://coderzhou.com/"/>

  <title> Jianlessçš„åšå®¢ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jianlessçš„åšå®¢</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">ä¸“æ³¨äºiOSå¼€å‘</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/02/YYCacheä¸­çš„ç»†èŠ‚/" itemprop="url">
                  YYCacheä¸­çš„ç»†èŠ‚
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-08-02T22:36:33+08:00" content="2018-08-02">
              2018-08-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/08/02/YYCacheä¸­çš„ç»†èŠ‚/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/08/02/YYCacheä¸­çš„ç»†èŠ‚/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/08/02/YYCacheä¸­çš„ç»†èŠ‚/" class="leancloud_visitors" data-flag-title="YYCacheä¸­çš„ç»†èŠ‚">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ€è¿‘èŠ±äº†ç‚¹æ—¶é—´çœ‹äº†ä¸‹<a href="https://github.com/ibireme/YYCache" target="_blank" rel="external">YYCache</a>çš„æºç ï¼Œè§‰å¾—å…¶ä¸­çš„ä¸€äº›ä»£ç ç»†èŠ‚éå¸¸å¥½ï¼Œé‚è®°å½•ä¹‹ï¼Œè™½ç„¶è¿™äº›çŸ¥è¯†å¯èƒ½è¢«åˆ«äººå†™çƒ‚äº†ï¼Œä½†è‡ªå·±æ€»ç»“ä¸‹æ€»å½’æ˜¯å¥½çš„ã€‚</p>
<h3 id="dispatch-semaphoreä¸-pthread-mutex-lockçš„ä½¿ç”¨"><a href="#dispatch-semaphoreä¸-pthread-mutex-lockçš„ä½¿ç”¨" class="headerlink" title="dispatch_semaphoreä¸ pthread_mutex_lockçš„ä½¿ç”¨"></a><code>dispatch_semaphore</code>ä¸ <code>pthread_mutex_lock</code>çš„ä½¿ç”¨</h3><p>ä½œè€…åœ¨YYMemoryCacheä¸­ä½¿ç”¨äº†Cè¯­è¨€ä¸­çš„<code>pthread_mutex_t</code>æ¥åŠ é”è§£é”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè€Œåœ¨YYDiskCacheä¸­ä½¿ç”¨<code>dispatch_semaphoreä¿¡å·é‡</code>ï¼Œ<code>dispatch_semaphore</code>ä¸ç®—é”ï¼Œä½†å¯ä»¥å®ç°é”çš„åŠŸèƒ½ã€‚</p>
<p>YYMemoryCacheä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (id)objectForKey:(id)key &#123;</div><div class="line">    if (!key) return nil;</div><div class="line">    pthread_mutex_lock(&amp;_lock);</div><div class="line">    _YYLinkedMapNode *node = CFDictionaryGetValue(_lru-&gt;_dic, (__bridge const void *)(key));</div><div class="line">    if (node) &#123;</div><div class="line">        node-&gt;_time = CACurrentMediaTime();</div><div class="line">        [_lru bringNodeToHead:node];</div><div class="line">    &#125;</div><div class="line">    pthread_mutex_unlock(&amp;_lock);</div><div class="line">    return node ? node-&gt;_value : nil;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>YYDiskCacheä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">- (id&lt;NSCoding&gt;)objectForKey:(NSString *)key &#123;</div><div class="line">    if (!key) return nil;</div><div class="line">    dispatch_semaphore_wait(self-&gt;_lock, DISPATCH_TIME_FOREVER);</div><div class="line">    YYKVStorageItem *item = [_kv getItemForKey:key];</div><div class="line">    dispatch_semaphore_signal(self-&gt;_lock);</div><div class="line">    if (!item.value) return nil;</div><div class="line">    </div><div class="line">    id object = nil;</div><div class="line">    if (_customUnarchiveBlock) &#123;</div><div class="line">        object = _customUnarchiveBlock(item.value);</div><div class="line">    &#125; else &#123;</div><div class="line">        @try &#123;</div><div class="line">            object = [NSKeyedUnarchiver unarchiveObjectWithData:item.value];</div><div class="line">        &#125;</div><div class="line">        @catch (NSException *exception) &#123;</div><div class="line">            // nothing to do...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (object &amp;&amp; item.extendedData) &#123;</div><div class="line">        [YYDiskCache setExtendedData:item.extendedData toObject:object];</div><div class="line">    &#125;</div><div class="line">    return object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨YYMemoryCacheä¸­ï¼Œä½œè€…åŸå…ˆæ˜¯ä½¿ç”¨è‡ªæ—‹é”OSSpinLockæ¥å®ç°çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸç†å°±æ˜¯do while å¿™ç­‰ï¼Œç¼ºç‚¹æ˜¯ç­‰å¾…æ—¶é—´ä¼šæ¶ˆè€—å¤§é‡ CPU èµ„æºï¼Œæ‰€ä»¥å®ƒä¸é€‚ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ï¼Œå›ºåœ¨YYDiskCacheä¸­ç”¨<code>dispatch_semaphore</code>ï¼Œ<code>dispatch_semaphore</code>ä¼˜åŠ¿åœ¨äºç­‰å¾…æ—¶ä¸ä¼šæ¶ˆè€— CPU èµ„æºã€‚å¯¹ç£ç›˜ç¼“å­˜æ¥è¯´ï¼Œå®ƒæ¯”è¾ƒåˆé€‚ã€‚</p>
<p>ä½†æ˜¯ç”±äºOSSpinLockæœ‰å®‰å…¨é—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹è·å¾—é”å¹¶è®¿é—®å…±äº«èµ„æºï¼Œè¿™æ—¶ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¹Ÿå°è¯•è·å¾—è¿™ä¸ªé”ï¼Œå®ƒä¼šå¤„äº spin lock çš„å¿™ç­‰çŠ¶æ€ä»è€Œå ç”¨å¤§é‡ CPUã€‚æ­¤æ—¶ä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•ä¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹äº‰å¤º CPU æ—¶é—´ï¼Œä»è€Œå¯¼è‡´ä»»åŠ¡è¿Ÿè¿Ÿå®Œä¸æˆã€æ— æ³•é‡Šæ”¾ lockã€‚å…·ä½“è§<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="external">ä¸å†å®‰å…¨çš„ OSSpinLock</a>ã€‚æ‰€ä»¥å°±æ¢æˆäº†<code>pthread_mutex_lock</code>äº’æ–¥é”ã€‚</p>
<h3 id="GCDä¸­ä½¿ç”¨-weak"><a href="#GCDä¸­ä½¿ç”¨-weak" class="headerlink" title="GCDä¸­ä½¿ç”¨__weak"></a>GCDä¸­ä½¿ç”¨__weak</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)_trimRecursively &#123;</div><div class="line">    __weak typeof(self) _self = self;</div><div class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(_autoTrimInterval * NSEC_PER_SEC)), dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0), ^&#123;</div><div class="line">        __strong typeof(_self) self = _self;</div><div class="line">        if (!self) return;</div><div class="line">        [self _trimInBackground];</div><div class="line">        [self _trimRecursively];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯YYDiskCacheä¸­çš„ä¸€æ®µä»£ç ï¼Œç›®çš„æ˜¯å¾ªç¯è°ƒç”¨<code>_trimInBackground</code>æ–¹æ³•æ¥æ£€æŸ¥ç£ç›˜ä¸­çš„å­˜å‚¨æ˜¯å¦å¤§äºé™åˆ¶ï¼Œå¤§äºé™åˆ¶çš„è¯å°±åˆ é™¤æ•°æ®ç›´åˆ°ç¬¦åˆé™åˆ¶ã€‚è¿™é‡Œä½œè€…ä½¿ç”¨äº†<code>__weak</code>æ¥é˜²æ­¢BlockæŒæœ‰selfã€‚åˆšå¼€å§‹çœ‹åˆ°è¿™å¥ä»£ç ï¼Œæˆ‘ä¹Ÿä¸ç†è§£ä¸ºä»€ä¹ˆè¦ä½¿ç”¨<code>__weak</code>ï¼ŒæŒ‰ç†æ¥è¯´GCDä¸­Blockæ‰§è¡Œå®Œåä¼šé‡Šæ”¾selfï¼Œä¸ä¼šå­˜åœ¨å†…å­˜æ³„éœ²ï¼Œåœ¨<a href="https://github.com/ibireme/YYKit/issues/41" target="_blank" rel="external">issues</a>ä¹Ÿæœ‰å…³äºè¿™ä¸ªé—®é¢˜çš„è®¨è®ºã€‚çœ‹äº†issuesä¸­çš„è®¨è®ºï¼Œåæ¥æƒ³äº†æƒ³ï¼Œå› ä¸ºè¿™æ˜¯ä¸ªé€’å½’è°ƒç”¨ï¼Œè‡ªå·±è°ƒç”¨è‡ªå·±ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (!self) return;</div></pre></td></tr></table></figure>
<p>å‡å¦‚blockä¸­çš„selfä¸€ç›´æœ‰å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå¾ªç¯ä¼šä¸€ç›´è°ƒç”¨ä¸‹å»ã€‚é‚£ä»€ä¹ˆæƒ…å†µä¸‹blockä¸­selfä¸ºnilå‘¢ã€‚è¯·çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">YYCache *cache = [[YYCache alloc] initWithPath:path];</div><div class="line">[cache setObject:@&quot;ZhangSan&quot; forKey:@&quot;name&quot;];</div></pre></td></tr></table></figure>
<p>å‡å¦‚æˆ‘ä»¬åœ¨ViewControllerä¸­ä½¿ç”¨YYCacheè¿›è¡Œå­˜å‚¨æ•°æ®ï¼Œä½†ViewControllerå¹¶æ²¡æœ‰æŒæœ‰YYCacheå®ä¾‹ï¼Œé‚£ä¹ˆè¿™ä¸¤è¡Œä»£ç æ‰§è¡Œå®Œï¼Œcacheè¿™ä¸ªå¯¹è±¡å°±é‡Šæ”¾äº†ï¼Œè¿™æ˜¯å®Œç¾çš„ç»“æœã€‚</p>
<p>ä½†æ˜¯å‡å¦‚åœ¨ä¸Šè¿°çš„æºç é‡Œï¼Œæ²¡æœ‰ä½¿ç”¨<code>__weak</code>ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨äº†selfï¼Œå³ä½¿ViewControlleræ²¡æœ‰æŒæœ‰YYCacheå®ä¾‹ï¼Œcacheè¿™ä¸ªå¯¹è±¡ä¹Ÿä¸ä¼šé‡Šæ”¾ï¼ŒYYDiskCacheä¸­çš„deallocæ–¹æ³•ä¸€ç›´ä¸ä¼šè°ƒç”¨ã€‚å› ä¸ºBlockä¸€ç›´åœ¨æŒæœ‰cacheå¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æ˜¯é€’å½’æ–¹æ³•ï¼Œæ‰€ä»¥å°±å‘ç”Ÿäº†â€œå‡çš„å†…å­˜æ³„éœ²â€ã€‚</p>
<p>æ—¢ç„¶æˆ‘ä»¬åœ¨ViewControllerä¸­æ²¡æœ‰å¼ºå¼•ç”¨cacheï¼Œå°±å¸Œæœ›ä½¿ç”¨å®ƒåè‡ªå·±é‡Šæ”¾æ‰ï¼Œæ‰€ä»¥ä½¿ç”¨äº†<code>__weak</code>ã€‚å‡å¦‚åœ¨ViewControllerä¸­å¼ºå¼•ç”¨cacheå¯¹è±¡ï¼Œé‚£ä¹ˆä½¿ä¸ä½¿ç”¨<code>__weak</code>éƒ½æ˜¯æ— å…³ç´§è¦çš„äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">@property (nonatomic, strong) YYCache *cache;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>å¦å¤–æä¸€ç‚¹ï¼Œå› ä¸ºYYCacheä¸­å¯ä»¥è‡ªå·±æ§åˆ¶å†…å­˜å ç”¨å¤§å°ï¼Œç£ç›˜å ç”¨å¤§å°ï¼Œå³è¶…è¿‡é™åˆ¶è‡ªåŠ¨åˆ é™¤å°¾éƒ¨æ•°æ®ã€‚å‡å¦‚æˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œå³å¯¹ç¼“å­˜å¤§å°æ— é™åˆ¶ï¼Œå¯ä»¥æ³¨é‡Šæ‰ç›¸å…³æ£€æŸ¥æ“ä½œçš„ä»£ç ï¼Œå› ä¸ºå®ƒæ¯éš”ä¸€æ®µæ—¶é—´(YYDiskCacheé»˜è®¤ä¸º60sï¼ŒYYMemoryCacheé»˜è®¤ä¸º5s)ä¼šè°ƒç”¨æ–¹æ³•è‡ªåŠ¨æ£€æŸ¥å¹¶æ“ä½œæ•°æ®ï¼Œç®—æ˜¯ä¸€ä¸ªå°ä¼˜åŒ–å§ã€‚</p>
<h3 id="UIAppliactionå¯¹è±¡"><a href="#UIAppliactionå¯¹è±¡" class="headerlink" title="UIAppliactionå¯¹è±¡"></a>UIAppliactionå¯¹è±¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">static UIApplication *_YYSharedApplication() &#123;</div><div class="line">    static BOOL isAppExtension = NO;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        Class cls = NSClassFromString(@&quot;UIApplication&quot;);</div><div class="line">        if(!cls || ![cls respondsToSelector:@selector(sharedApplication)]) isAppExtension = YES;</div><div class="line">        if ([[[NSBundle mainBundle] bundlePath] hasSuffix:@&quot;.appex&quot;]) isAppExtension = YES;</div><div class="line">    &#125;);</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wundeclared-selector&quot;</div><div class="line">    return isAppExtension ? nil : [UIApplication performSelector:@selector(sharedApplication)];</div><div class="line">#pragma clang diagnostic pop</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç æ˜¯è·å¾—å½“å‰UIAppliactionå¯¹è±¡ï¼Œé‡Œé¢åˆ¤æ–­äº†å½“åœ¨App Extensioné‡Œè¿”å›nilã€‚å‡å¦‚æ˜¯æˆ‘ä»¬è‡ªå·±è®¾è®¡ä¸€ä¸ªSDKç»™åˆ«äººä½¿ç”¨ï¼Œä¼šä¸ä¼šæ³¨æ„åˆ°è¿™äº›ç»†èŠ‚å‘¢ï¼Ÿ</p>
<h3 id="æŒ‡å®šqueueä¸­å­çº¿ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡"><a href="#æŒ‡å®šqueueä¸­å­çº¿ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡" class="headerlink" title="æŒ‡å®šqueueä¸­å­çº¿ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡"></a>æŒ‡å®šqueueä¸­å­çº¿ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">NSMutableArray *holder = [NSMutableArray new];</div><div class="line">while (!finish) &#123;</div><div class="line">    if (pthread_mutex_trylock(&amp;_lock) == 0) &#123;</div><div class="line">        if (_lru-&gt;_tail &amp;&amp; (now - _lru-&gt;_tail-&gt;_time) &gt; ageLimit) &#123;</div><div class="line">            _YYLinkedMapNode *node = [_lru removeTailNode];</div><div class="line">            if (node) [holder addObject:node];</div><div class="line">        &#125; else &#123;</div><div class="line">            finish = YES;</div><div class="line">        &#125;</div><div class="line">        pthread_mutex_unlock(&amp;_lock);</div><div class="line">    &#125; else &#123;</div><div class="line">        usleep(10 * 1000); //10 ms</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">if (holder.count) &#123;</div><div class="line">    dispatch_queue_t queue = _lru-&gt;_releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</div><div class="line">    dispatch_async(queue, ^&#123;</div><div class="line">        [holder count]; // release in queue</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å½“å‰çº¿ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªNSMutableArrayï¼Œç„¶åå°†è¦åˆ é™¤é‡Šæ”¾çš„å¯¹è±¡æ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œå†åœ¨å­çº¿ç¨‹ä¸­è°ƒç”¨countæ–¹æ³•ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†åœ¨å­çº¿ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡çš„ç›®çš„äº†ã€‚</p>
<p>åŸå› ï¼šå½“æŠŠå°†è¦åˆ é™¤çš„å¯¹è±¡æ·»åŠ åˆ°arrayä¸­ï¼Œæ­¤æ—¶arrayä¸ä¼šé‡Šæ”¾ï¼Œarrayä¸­çš„å¯¹è±¡ä¹Ÿä¸ä¼šé‡Šæ”¾ï¼Œå› ä¸ºåœ¨å¦å¤–çš„çº¿ç¨‹ä¸­åˆè°ƒç”¨äº†countæ–¹æ³•ï¼ŒæŒæœ‰äº†arrayã€‚å½“blockæ‰§è¡Œå®Œï¼Œå°±ä¼šé‡Šæ”¾æŒæœ‰çš„arrayï¼Œä¹Ÿè¾¾åˆ°äº†é‡Šæ”¾åˆ é™¤å¯¹è±¡çš„ç›®çš„ï¼Œå³åœ¨æŒ‡å®šçš„queueä¸­å­çº¿ç¨‹é‡Šæ”¾å¯¹è±¡ã€‚(è¯´å®è¯ï¼Œçœ‹æºç ä¹‹å‰ä»æ¥æ²¡æœ‰æƒ³åˆ°è¿‡è¿™ä¸ªéœ€æ±‚ï¼Œåœ¨æŒ‡å®šçš„queueä¸­é‡Šæ”¾å¯¹è±¡ï¼Œæ±—é¢œ!)</p>
<h3 id="åŒå‘é“¾è¡¨çš„é€‰æ‹©"><a href="#åŒå‘é“¾è¡¨çš„é€‰æ‹©" class="headerlink" title="åŒå‘é“¾è¡¨çš„é€‰æ‹©"></a>åŒå‘é“¾è¡¨çš„é€‰æ‹©</h3><p>åœ¨YYMemoryCacheä¸­ä½¿ç”¨äº†åŒå‘é“¾è¡¨æ¥å®ç°LRUçš„ç­–ç•¥ç¼“å­˜ï¼Œä¸æ­¢iOSå¹³å°ï¼Œåœ¨å…¶ä»–å¹³å°ï¼Œå®‰å“ï¼ŒLinuxç­‰å®ç°LRUç®—æ³•éƒ½æ˜¯ä½¿ç”¨åŒå‘é“¾è¡¨+Mapçš„æ–¹æ³•ã€‚ä½¿ç”¨Mapæ˜¯ä¸ºäº†æ›´å¿«æ‰¾åˆ°è¦åˆ é™¤æˆ–ç§»åŠ¨çš„èŠ‚ç‚¹ï¼Œé“¾è¡¨æ˜¯å°†ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ”¾åˆ°å¤´éƒ¨èŠ‚ç‚¹ï¼Œåˆ é™¤çš„æ—¶å€™åˆ é™¤å°¾éƒ¨èŠ‚ç‚¹çš„æ•°æ®ã€‚ä¸€å¼€å§‹æˆ‘æƒ³ï¼Œè¿™ä¸ªæ˜æ˜ç”¨å•å‘é“¾è¡¨+Mapå°±èƒ½å®ç°ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ›´åŠ å¤æ‚çš„åŒçº¿é“¾è¡¨å‘¢ï¼Ÿ</p>
<p>åæ¥æˆ‘åˆå¯¹æ¯”äº†åŒå‘é“¾è¡¨ä¸å•å‘é“¾è¡¨çš„çš„ä¸åŒï¼Œå•å‘é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹åªçŸ¥é“ä¸‹ä¸ªèŠ‚ç‚¹çš„å†…å­˜åœ°å€ï¼Œè€Œä¸çŸ¥é“å®ƒä¸Šä¸ªèŠ‚ç‚¹çš„åœ°å€ï¼ŒåŒå‘é“¾è¡¨æ—¢çŸ¥é“ä¸‹ä¸ªèŠ‚ç‚¹çš„åœ°å€ï¼Œä¹ŸçŸ¥é“ä¸Šä¸ªèŠ‚ç‚¹çš„åœ°å€ã€‚æ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œå½“æˆ‘ä»¬è¦ç§»åŠ¨æŸä¸ªèŠ‚ç‚¹ï¼Œæ¯”å¦‚ç§»åŠ¨ä¸­é—´çš„èŠ‚ç‚¹ä½¿å®ƒä½œä¸ºå¤´éƒ¨èŠ‚ç‚¹ï¼Œå‡å¦‚ç”¨çš„æ˜¯å•å‘é“¾è¡¨ï¼Œå› ä¸ºå®ƒä¸çŸ¥é“å®ƒçš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿˜è¦éå†æ•´ä¸ªé“¾è¡¨ï¼Œæ‰¾åˆ°ä¸Šä¸ªèŠ‚ç‚¹ï¼Œç„¶åæ‰èƒ½è¡”æ¥èµ·æ¥ã€‚è€ŒåŒå‘é“¾è¡¨ä¸ç”¨éå†æ•´ä¸ªé“¾è¡¨ï¼Œå®ƒè‡ªå·±å°±çŸ¥é“å®ƒçš„ä¸Šä¸ªèŠ‚ç‚¹åœ°å€ã€‚è™½ç„¶åŒå‘é“¾è¡¨æ›´åŠ å¤æ‚äº†ä¸€ç‚¹ï¼Œä½†æ˜¯å¸¦æ¥çš„å¥½å¤„ï¼Œå¯¹æ€§èƒ½çš„æå‡ä¹Ÿæ˜¯ä¸è¨€è€Œå–»çš„ã€‚</p>
<h3 id="æ¥å£çš„è®¾è®¡"><a href="#æ¥å£çš„è®¾è®¡" class="headerlink" title="æ¥å£çš„è®¾è®¡"></a>æ¥å£çš„è®¾è®¡</h3><p>YYCacheé‡Œçš„æ¥å£åŠæ¶æ„è®¾è®¡å¯ä»¥è¯´æ˜¯ç®€æ´æ˜äº†ï¼ŒYYCacheæŒæœ‰YYMemoryCacheå’ŒYYDiskCacheï¼Œä¸¤è€…åˆ†åˆ«è´Ÿè´£å†…å­˜ç¼“å­˜åŠç£ç›˜ç¼“å­˜ï¼Œä¸¤è€…ä¹‹é—´äº’ä¸å½±å“ã€‚å†æ¥çœ‹ä¸‹ç›¸å…³çš„api</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">@interface YYCache : NSObject</div><div class="line"></div><div class="line">@property (copy, readonly) NSString *name</div><div class="line">@property (strong, readonly) YYMemoryCache *memoryCache</div><div class="line">@property (strong, readonly) YYDiskCache *diskCache</div><div class="line"></div><div class="line">- (nullable instancetype)initWithName:(NSString *)name</div><div class="line">- (nullable instancetype)initWithPath:(NSString *)path</div><div class="line">+ (nullable instancetype)cacheWithName:(NSString *)name</div><div class="line"></div><div class="line">- (BOOL)containsObjectForKey:(NSString *)key</div><div class="line">- (void)containsObjectForKey:(NSString *)key withBlock:(nullable void(^)(NSString *key, BOOL contains))block</div><div class="line"> </div><div class="line">- (nullable id&lt;NSCoding&gt;)objectForKey:(NSString *)key</div><div class="line">- (void)objectForKey:(NSString *)key withBlock:(nullable void(^)(NSString *key, id&lt;NSCoding&gt; object))block</div><div class="line"> </div><div class="line">- (void)setObject:(nullable id&lt;NSCoding&gt;)object forKey:(NSString *)key</div><div class="line">- (void)setObject:(nullable id&lt;NSCoding&gt;)object forKey:(NSString *)key withBlock:(nullable void(^)(void))block</div><div class="line">- (void)removeObjectForKey:(NSString *)key</div><div class="line">- (void)removeObjectForKey:(NSString *)key withBlock:(nullable void(^)(NSString *key))block</div><div class="line">- (void)removeAllObjects</div><div class="line">- (void)removeAllObjectsWithBlock:(void(^)(void))block</div><div class="line">- (void)removeAllObjectsWithProgressBlock:(nullable void(^)(int removedCount, int totalCount))progress</div><div class="line">                                 endBlock:(nullable void(^)(BOOL error))end</div></pre></td></tr></table></figure>
<p>å¯ä»¥è¯´ä¸ç”¨çœ‹æ³¨é‡Šï¼Œçœ‹æ–¹æ³•åå°±å¯ä»¥ç›´æ¥çŸ¥é“è¯¥æ–¹æ³•çš„ä½œç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰ä¸€ä¸ªå¤šä½™çš„æ–¹æ³•ã€‚å“ªäº›æ–¹æ³•è¯¥æ”¾åœ¨<code>.h</code>æ–‡ä»¶é‡Œå£°æ˜ç»™å¤–éƒ¨è°ƒç”¨ï¼Œå“ªäº›æ–¹æ³•è¯¥æ”¾åœ¨<code>.m</code>æ–‡ä»¶é‡Œç§æœ‰æ“ä½œï¼Œéƒ½æ§åˆ¶çš„å®Œç¾æ— ç‘•ã€‚</p>
<p>YYCacheé‡Œçš„æ¥å£åŠæ¶æ„è®¾è®¡å¯ä»¥è¯´æ˜¯ä½œä¸ºä¸€ä¸ªSDKçš„å…¸èŒƒï¼Œå¹¶ä¸”ä»£ç ä¹Ÿå¯¹æ¯ä¸€ä¸ªç»†èŠ‚è¿½æ±‚åˆ°æè‡´ã€‚æ­£å› ä¸ºè®¾è®¡çš„è¿™ä¹ˆæ¼‚äº®ï¼Œæºç è¯»èµ·æ¥æ‰ä¼šé€šä¿—æ˜“æ‡‚ï¼Œè®©äººèµå¹ğŸ‘ï¼</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/26/dispatch_onceçº¿ç¨‹å®‰å…¨/" itemprop="url">
                  dispatch_onceçº¿ç¨‹å®‰å…¨
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-07-26T22:04:18+08:00" content="2018-07-26">
              2018-07-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/26/dispatch_onceçº¿ç¨‹å®‰å…¨/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/07/26/dispatch_onceçº¿ç¨‹å®‰å…¨/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/07/26/dispatch_onceçº¿ç¨‹å®‰å…¨/" class="leancloud_visitors" data-flag-title="dispatch_onceçº¿ç¨‹å®‰å…¨">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static dispatch_once_t onceToken;</div><div class="line">dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">   ...</div><div class="line">&#125;);</div><div class="line">return instance;</div></pre></td></tr></table></figure>
<p>è¯´åˆ°å•ä¾‹ï¼Œå¤§å®¶éƒ½ä¼šæƒ³åˆ°ç”¨<code>dispatch_once</code>å®ç°ï¼Œä»Šå¤©æ¥æ¢ç©¶ä¸€ä¸‹<code>dispatch_once</code>å†…éƒ¨å¦‚ä½•æ“ä½œçš„ï¼Œå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p><code>dispatch_once_t</code>å®è´¨å°±æ˜¯ä¸ª<code>long</code>ç±»å‹çš„åŸºæœ¬å˜é‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef long dispatch_once_t</div></pre></td></tr></table></figure>
<p><code>dispatch_once</code> å‡½æ•°å®ç°ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">void  dispatch_once(dispatch_once_t *val, dispatch_block_t block) &#123;</div><div class="line"></div><div class="line">	dispatch_once_f(val, block, _dispatch_Block_invoke(block));</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å°†åŸºæœ¬å˜é‡çš„æŒ‡é’ˆåŠblockä¼ è¿›å»ï¼Œ<code>dispatch_block_t</code> æ˜¯è‡ªå®šä¹‰çš„ ï¼Œè¿™ä¸ª<code>block</code>å°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œæ— å‚æ•°ï¼Œæ— è¿”å›å€¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef void (^dispatch_block_t)(void);</div></pre></td></tr></table></figure>
<p><code>_dispatch_Block_invoke</code>ä¹Ÿæ˜¯ä¸ªå®å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#define _dispatch_Block_invoke(bb) \</div><div class="line">		((dispatch_function_t)((struct Block_layout *)bb)-&gt;invoke)</div></pre></td></tr></table></figure>
<p>å®ƒçš„ä½œç”¨æ˜¯è·å¾—<code>block</code>å†…éƒ¨çš„<code>invoke</code>çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å…·ä½“çš„<code>block</code>å®ç°å‡½æ•°çš„è°ƒç”¨åœ°å€ï¼Œå°±æ˜¯æˆ‘ä»¬è‡ªå·±åœ¨<code>dispatch_block_t</code>é‡Œå†™çš„é‚£æ®µä»£ç çš„å…·ä½“å®ç°åœ°å€ã€‚</p>
<p>å°†å˜é‡åœ°å€ï¼Œ<code>block</code>ï¼Œ<code>invoke</code>ä¸‰ä¸ªå‚æ•°ä¼ å…¥<code>dispatch_once_f</code>æ–¹æ³•é‡Œï¼Œä¸‹é¢ç»§ç»­åˆ†æ<code>dispatch_once_f</code>æ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">void</div><div class="line">dispatch_once_f(dispatch_once_t *val, void *ctxt, dispatch_function_t func)</div><div class="line">&#123;</div><div class="line">#if !DISPATCH_ONCE_INLINE_FASTPATH</div><div class="line">	if (likely(os_atomic_load(val, acquire) == DLOCK_ONCE_DONE)) &#123;</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line">#endif // !DISPATCH_ONCE_INLINE_FASTPATH</div><div class="line">	return dispatch_once_f_slow(val, ctxt, func);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>DISPATCH_ONCE_INLINE_FASTPATH</code>æ˜¯åˆ¤æ–­å½“å‰ç¼–è¯‘ç¯å¢ƒï¼Œæ˜¯çœŸæœºè¿˜æ˜¯æ¨¡æ‹Ÿå™¨ã€‚æœ€ç»ˆå®ç°æ–¹æ³•æ¥åˆ°äº†<code>dispatch_once_f_slow</code>æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">static void</div><div class="line">dispatch_once_f_slow(dispatch_once_t *val, void *ctxt, dispatch_function_t func)</div><div class="line">&#123;</div><div class="line">#if DISPATCH_GATE_USE_FOR_DISPATCH_ONCE</div><div class="line">	dispatch_once_gate_t l = (dispatch_once_gate_t)val;</div><div class="line"></div><div class="line">	if (_dispatch_once_gate_tryenter(l)) &#123;</div><div class="line">		_dispatch_client_callout(ctxt, func);</div><div class="line">		_dispatch_once_gate_broadcast(l);</div><div class="line">	&#125; else &#123;</div><div class="line">		_dispatch_once_gate_wait(l);</div><div class="line">	&#125;</div><div class="line">#else</div><div class="line">	_dispatch_once_waiter_t volatile *vval = (_dispatch_once_waiter_t*)val;</div><div class="line">	struct _dispatch_once_waiter_s dow = &#123; &#125;;</div><div class="line">	_dispatch_once_waiter_t tail = &amp;dow, next, tmp;</div><div class="line">	dispatch_thread_event_t event;</div><div class="line"></div><div class="line">	if (os_atomic_cmpxchg(vval, NULL, tail, acquire)) &#123;</div><div class="line">		dow.dow_thread = _dispatch_tid_self();</div><div class="line">		_dispatch_client_callout(ctxt, func);</div><div class="line"></div><div class="line">		next = (_dispatch_once_waiter_t)_dispatch_once_xchg_done(val);</div><div class="line">		while (next != tail) &#123;</div><div class="line">			tmp = (_dispatch_once_waiter_t)_dispatch_wait_until(next-&gt;dow_next);</div><div class="line">			event = &amp;next-&gt;dow_event;</div><div class="line">			next = tmp;</div><div class="line">			_dispatch_thread_event_signal(event);</div><div class="line">		&#125;</div><div class="line">	&#125; else &#123;</div><div class="line">		_dispatch_thread_event_init(&amp;dow.dow_event);</div><div class="line">		next = *vval;</div><div class="line">		for (;;) &#123;</div><div class="line">			if (next == DISPATCH_ONCE_DONE) &#123;</div><div class="line">				break;</div><div class="line">			&#125;</div><div class="line">			if (os_atomic_cmpxchgv(vval, next, tail, &amp;next, release)) &#123;</div><div class="line">				dow.dow_thread = next-&gt;dow_thread;</div><div class="line">				dow.dow_next = next;</div><div class="line">				if (dow.dow_thread) &#123;</div><div class="line">					pthread_priority_t pp = _dispatch_get_priority();</div><div class="line">					_dispatch_thread_override_start(dow.dow_thread, pp, val);</div><div class="line">				&#125;</div><div class="line">				_dispatch_thread_event_wait(&amp;dow.dow_event);</div><div class="line">				if (dow.dow_thread) &#123;</div><div class="line">					_dispatch_thread_override_end(dow.dow_thread, val);</div><div class="line">				&#125;</div><div class="line">				break;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		_dispatch_thread_event_destroy(&amp;dow.dow_event);</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆé•¿ï¼Œé€æ®µåˆ†æï¼š</p>
<p>é¦–å…ˆåˆå§‹åŒ–äº†ä¸€ç³»åˆ—çš„å˜é‡ï¼Œ<code>_dispatch_once_waiter_s</code>ç±»ä¼¼äºé“¾è¡¨ä¸­çš„èŠ‚ç‚¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">typedef struct _dispatch_once_waiter_s &#123;</div><div class="line">	volatile struct _dispatch_once_waiter_s *volatile dow_next; // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</div><div class="line">	dispatch_thread_event_s dow_event; // ä¿¡å·é‡</div><div class="line">	mach_port_t dow_thread; // çº¿ç¨‹ç«¯å£</div><div class="line">&#125; *_dispatch_once_waiter_t;</div></pre></td></tr></table></figure>
<p><code>if (os_atomic_cmpxchg(vval, NULL, tail, acquire))</code>è¿™è¡Œä»£ç å±•å¼€ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">if (*vval == NULL) &#123;</div><div class="line">	*vval = tail = &amp;dow;</div><div class="line">	return true;</div><div class="line">&#125; else &#123;</div><div class="line">	return false</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„æ€æ˜¯ä¼ å…¥çš„<code>*vval == NULL</code>å¦‚æœä¸ºnilï¼Œåˆ™èµ‹å€¼ï¼Œå¹¶è¿”å›trueï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æ˜¯åŸå­æ“ä½œçš„ã€‚å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿›æ¥ï¼Œ<code>val=0</code>æ¥ä¸‹æ¥æ‰§è¡Œ<code>if</code>é‡Œé¢çš„ä»£ç ã€‚</p>
<p><code>_dispatch_client_callout</code>è¡¨ç¤ºæ‰§è¡Œ<code>block</code>ï¼Œç„¶åå°†nextæ ‡è®°ä¸º<code>DISPATCH_ONCE_DONE</code>ã€‚</p>
<p>å‡å¦‚æ•´ä¸ªè¿‡ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆä¸‹é¢çš„whileå¾ªç¯ä¸ä¼šæ‰§è¡Œï¼Œæ‰§è¡Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œã€‚å‡å¦‚æœ‰å…¶ä»–çº¿ç¨‹è¿›æ¥ï¼Œå°±ä¼šè¿›å…¥elseåˆ†æ”¯é‡Œã€‚</p>
<p>elseåˆ†æ”¯é‡Œï¼Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå…ˆåˆ¤æ–­<code>if (next == DISPATCH_ONCE_DONE)</code>ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è·³å‡ºå¾ªç¯ã€‚æ¯è¿›æ¥ä¸€æ¬¡ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ª<code>_dispatch_once_waiter_s</code>çš„èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œç„¶åè°ƒç”¨ä¿¡å·é‡ç­‰å¾…ã€‚è€Œé“¾è¡¨çš„å¤´éƒ¨æ˜¯ç¬¬ä¸€æ¬¡è¿›æ¥çš„ï¼Œè¿›å…¥åˆ°ifä»£ç æ®µçš„é‚£ä¸ªèŠ‚ç‚¹ã€‚å½“ifåˆ†æ”¯æ‰§è¡Œå®Œåï¼Œä¼šè¿›å…¥whileå¾ªç¯éå†é“¾è¡¨ï¼Œä¾æ¬¡å‘é€ä¿¡å·å°†çº¿ç¨‹å”¤é†’ã€‚</p>
<p>è¿™å°±æ˜¯å…¨éƒ¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œç”¨åˆ°çš„çŸ¥è¯†ç‚¹ä¸»è¦æ˜¯åŸå­æ€§æ“ä½œã€é“¾è¡¨ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºå¤§å®¶éƒ½è¯´<code>dispatch_once</code>åªæ‰§è¡Œä¸€æ¬¡è¿™ç§è¯´è¯æ˜¯ä¸ä¸¥è°¨çš„ï¼Œå®ƒæœ¬è´¨ä¸Šå¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼Œåªæ˜¯æŠŠæ¯æ¬¡æ‰§è¡Œè¯·æ±‚æ”¾åˆ°äº†å†…éƒ¨çš„é“¾è¡¨é‡Œã€‚<br>è¿˜æ˜¯ç”»ä¸ªå›¾å§ã€‚</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/dispatch_once%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8.png" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/10/iOSå›½é™…åŒ–/" itemprop="url">
                  iOSå›½é™…åŒ–
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-07-10T20:19:13+08:00" content="2018-07-10">
              2018-07-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/10/iOSå›½é™…åŒ–/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/07/10/iOSå›½é™…åŒ–/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/07/10/iOSå›½é™…åŒ–/" class="leancloud_visitors" data-flag-title="iOSå›½é™…åŒ–">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ€è¿‘é¡¹ç›®é‡Œæ·»åŠ äº†å›½é™…åŒ–åŠåº”ç”¨å†…è¯­è¨€åˆ‡æ¢åŠŸèƒ½ï¼Œé‚æ•´ç†ä¸‹ã€‚</p>
<h3 id="ç®€å•å›½é™…åŒ–"><a href="#ç®€å•å›½é™…åŒ–" class="headerlink" title="ç®€å•å›½é™…åŒ–"></a>ç®€å•å›½é™…åŒ–</h3><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨æ—¶ï¼Œæ–‡ä»¶ç›®å½•ä¸‹ä¼šé»˜è®¤æœ‰ä¸€ä¸ª <code>Base.lproj</code> æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯é¡¹ç›®åœ¨è‹±æ–‡è¯­è¨€ç¯å¢ƒä¸‹çš„é»˜è®¤æœ¬åœ°åŒ–æ–‡ä»¶å¤¹ã€‚å½“æˆ‘ä»¬ä¸åšå›½é™…åŒ–æ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ²¡ä»€ä¹ˆç”¨ã€‚</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/international_baselproj.png" alt="image"><br>å‡å¦‚æˆ‘ä»¬æƒ³æ”¯æŒæ›´å¤šçš„è¯­è¨€ï¼Œå¯ä»¥åœ¨é¡¹ç›®é‡Œè¿™é‡Œè®¾ç½®</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/international_addLanguage.png" alt="image"></p>
<p>æ·»åŠ å®Œæˆä¹‹åé¡¹ç›®æ–‡ä»¶ç›®å½•å°±å¤šäº†å‡ ä¸ªè¯­è¨€æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬æ–°æ·»åŠ äº†ä¸¤ç§ï¼šç®€ä½“ä¸­æ–‡å’Œç¹ä½“ä¸­æ–‡</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/international_wenjain.png" alt="image"></p>
<h4 id="åº”ç”¨åç§°å›½é™…åŒ–"><a href="#åº”ç”¨åç§°å›½é™…åŒ–" class="headerlink" title="åº”ç”¨åç§°å›½é™…åŒ–"></a>åº”ç”¨åç§°å›½é™…åŒ–</h4><p>åˆ›å»ºInfoPlist.stringsæ–‡ä»¶(InfoPlist.stringsï¼Œåç§°ä¸è¦å†™é”™â€¦)<br><img src="http://ocauxqtbu.bkt.clouddn.com/international_strings.png" alt="image"><br>ç„¶ååˆ†åˆ«åœ¨ <code>InfoPlist.strings</code> æ–‡ä»¶é‡Œæ·»åŠ ä¸åŒè¯­è¨€çš„key value</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CFBundleDisplayName = &quot;international&quot;;// è‹±æ–‡</div><div class="line">CFBundleDisplayName = &quot;å›½é™…åŒ–Demo&quot;;// ä¸­æ–‡</div></pre></td></tr></table></figure>
<p>ä¸ä»…åº”ç”¨åç§°å¯ä»¥å›½é™…åŒ–ï¼Œå…¶ä»– <code>info.plist</code> ä¸­çš„å­—æ®µå¯ä»¥è®¾ç½®ï¼Œæ¯”å¦‚éšç§æƒé™è®¾ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">NSPhotoLibraryUsageDescription = &quot;è¯·ç‚¹å‡»&apos;å¥½&apos;ä»¥å…è®¸è®¿é—®ã€‚å¦‚æœä¸å…è®¸,ä½ å°†æ— æ³•ä½¿ç”¨å›¾ç‰‡åŠŸèƒ½&quot;;</div><div class="line">NSCameraUsageDescription = &quot;è¯·ç‚¹å‡»&apos;å¥½&apos;ä»¥å…è®¸è®¿é—®ã€‚å¦‚æœä¸å…è®¸,ä½ å°†æ— æ³•ä½¿ç”¨æ‹æ‘„åŠŸèƒ½&quot;;</div><div class="line">NSMicrophoneUsageDescription = &quot;è¯·ç‚¹å‡»&apos;å¥½&apos;ä»¥å…è®¸è®¿é—®ã€‚å¦‚æœä¸å…è®¸,ä½ å°†æ— æ³•ä½¿ç”¨éº¦å…‹é£åŠŸèƒ½&quot;;</div><div class="line">NSLocationWhenInUseUsageDescription = &quot;è¯·ç‚¹å‡»&apos;å¥½&apos;ä»¥å…è®¸è®¿é—®ã€‚å¦‚æœä¸å…è®¸,ä½ å°†æ— æ³•ä½¿ç”¨ä½ç½®åŠŸèƒ½&quot;;</div></pre></td></tr></table></figure>
<p>æ·»åŠ å®Œä¹‹ååˆ‡æ¢è¯­è¨€åº”ç”¨åç§°ä¼šè·Ÿç€æ›´æ¢ï¼š</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/international_test4.jpg" alt="image"></p>
<h4 id="åº”ç”¨å†…å®¹å›½é™…åŒ–"><a href="#åº”ç”¨å†…å®¹å›½é™…åŒ–" class="headerlink" title="åº”ç”¨å†…å®¹å›½é™…åŒ–"></a>åº”ç”¨å†…å®¹å›½é™…åŒ–</h4><p>åˆ›å»ºä¸€ä¸ªstringsæ–‡ä»¶æ¥ç”¨ä½œå†…å®¹å›½é™…åŒ–ï¼Œä¸‹é¢ä¼šæœ‰ä¸‰ä¸ªå­æ–‡ä»¶åˆ†åˆ«ç”¨æ¥æ“ä½œå¯¹åº”è¯­è¨€çš„å›½é™…åŒ–å†…å®¹<br><img src="http://ocauxqtbu.bkt.clouddn.com/international_localizable.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;LabelText&quot;=&quot;hello,world&quot;;//è‹±æ–‡</div><div class="line">&quot;LabelText&quot;=&quot;ä½ å¥½,ä¸–ç•Œ&quot;;//ä¸­æ–‡</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åœ¨ä»£ç ä¸­è¿™æ ·å†™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(100, 100, 100, 30)];</div><div class="line">label.text = NSLocalizedStringFromTable(@&quot;LabelText&quot;, @&quot;Localizable&quot;, nil);</div><div class="line">[self.view addSubview:label];</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆè¿™ä¸ªlableå°±ä¼šå½“å‰æ‰‹æœºç³»ç»Ÿçš„è¯­è¨€ç¯å¢ƒï¼Œæ ¹æ® <code>LabelText</code> è¿™ä¸ªkeyå»å–å¯¹åº”è¯­è¨€çš„valueï¼Œå¦‚æœåº”ç”¨æ²¡æœ‰å¯¹æ‰‹æœºç³»ç»Ÿçš„è¯­è¨€è¿›è¡Œå›½é™…åŒ–ï¼Œåˆ™å–é»˜è®¤è¯­è¨€ï¼Œæ¯”å¦‚è‹±æ–‡ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯å¯¹APPè¿›è¡Œç®€å•å›½é™…åŒ–ï¼Œä½†æ˜¯è¿™æ ·æœ‰ä¸€ç‚¹ä¸å¥½ï¼Œå°±æ˜¯åªèƒ½æ ¹æ®æ‰‹æœºç³»ç»Ÿè‡ªé€‚åº”å¤„ç†ï¼Œæ— æ³•è¿›è¡ŒAPPå†…è¯­è¨€çš„åˆ‡æ¢ã€‚æ‰€ä»¥è¯­è¨€çš„å›½é™…åŒ–å’Œåº”ç”¨å†…åˆ‡æ¢è¯­è¨€è¦æˆ‘ä»¬è‡ªå·±æ¥å®ç°ã€‚ </p>
<h3 id="å›½é™…åŒ–çš„æœ¬è´¨"><a href="#å›½é™…åŒ–çš„æœ¬è´¨" class="headerlink" title="å›½é™…åŒ–çš„æœ¬è´¨"></a>å›½é™…åŒ–çš„æœ¬è´¨</h3><p>å›½é™…åŒ–çš„æœ¬è´¨å°±æ˜¯æ ¹æ®æŒ‡å®šçš„languageï¼Œæ‰¾åˆ°æœ¬åœ°æ­¤è¯­è¨€å¯¹åº”çš„èµ„æºæ–‡ä»¶(bundle)ï¼Œåœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾keyå¯¹åº”çš„å­—ç¬¦ä¸²ã€‚åº”ç”¨åç§°çš„å›½é™…åŒ–ï¼Œå’ŒAPPå†…å®¹çš„å›½é™…åŒ–éƒ½æ˜¯è¿™ä¸€ä¸ªåŸç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»è¿™ä¸ªåŸç†å…¥æ‰‹ï¼Œç®€è¿°ä¸€ä¸‹å®ç°æµç¨‹</p>
<ul>
<li>1.å¯åŠ¨åº”ç”¨åï¼Œå…ˆæŸ¥çœ‹æœ¬åœ°æœ‰æ²¡æœ‰ä¸Šæ¬¡ä¿å­˜çš„è¯­è¨€idï¼Œå¦‚æœæœ‰ï¼Œåˆ™è®¾è¿™ä¸ªè¯­è¨€ä¸ºå½“å‰APPè¯­è¨€</li>
<li>2.å¦‚æœæ²¡æœ‰ï¼Œè¯æ˜ä¸ºç¬¬ä¸€æ¬¡æ‰“å¼€ï¼Œå³ä»APPStoreä¸‹è½½åç¬¬ä¸€æ¬¡æ‰“å¼€ï¼Œæ­¤æ—¶è·å–æ‰‹æœºç³»ç»Ÿè¯­è¨€ï¼Œå‡å¦‚APPå†…å¯¹è¿™ä¸ªè¯­è¨€è¿›è¡Œå›½é™…åŒ–äº†ï¼Œåˆ™æŠŠè¿™ä¸ªè¯­è¨€è®¾ç½®APPå†…è¯­è¨€ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤è¯­è¨€ï¼Œæ¯”å¦‚è‹±è¯­ã€‚(æ¯”å¦‚æ‰‹æœºç³»ç»Ÿé‡Œè¯­è¨€ä¸ºå¾·è¯­ï¼Œä½†æ˜¯æ²¡æœ‰å¯¹è¿™ä¸ªè¯­è¨€è¿›è¡Œå›½é™…åŒ–)</li>
<li>3.åç»­çš„APPåç§°åŠAPPå†…ç•Œé¢å†…å®¹éƒ½æ ¹æ®è®¾ç½®çš„è¯­è¨€æ¥è¿›è¡Œå›½é™…åŒ–å¤„ç†</li>
<li>4.APPå†…åˆ‡æ¢è¯­è¨€,å°±æ˜¯æ”¹å˜äº†æŸ¥æ‰¾çš„bundleæ–‡ä»¶ã€‚æ¯”å¦‚ï¼Œä¹‹å‰æ˜¯è‹±è¯­ï¼Œç¿»è¯‘å­—ç¬¦ä¸²valueä»è‹±è¯­ç¯å¢ƒä¸‹çš„bundleæ–‡ä»¶ä¸‹æŸ¥æ‰¾ï¼Œåˆ‡æ¢æˆä¸­æ–‡åï¼Œä»ä¸­æ–‡ç¯å¢ƒä¸‹çš„bundleæ–‡ä»¶ä¸­æŸ¥æ‰¾valueã€‚æœ€åï¼Œä¿å­˜åˆ‡æ¢åçš„è¯­è¨€idåˆ°æœ¬åœ°ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚</li>
</ul>
<h3 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h3><h4 id="è‡ªå»º-lprojæ–‡ä»¶"><a href="#è‡ªå»º-lprojæ–‡ä»¶" class="headerlink" title="è‡ªå»º lprojæ–‡ä»¶"></a>è‡ªå»º <code>lproj</code>æ–‡ä»¶</h4><p>åˆšæ‰æåˆ°äº†ï¼Œæ·»åŠ è¯­è¨€åä¼šåœ¨é¡¹ç›®ç›®å½•ä¸‹è‡ªåŠ¨ç”Ÿæˆå¯¹åº”è¯­è¨€çš„ <code>lproj</code> æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»º <code>lproj</code> æ–‡ä»¶ã€‚ç„¶åå°†è¿™äº›æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œç»Ÿä¸€ç®¡ç†<br><img src="http://ocauxqtbu.bkt.clouddn.com/international_addlproj.png" alt="image"><br>åˆ‡æ¢è¯­è¨€åï¼Œå°†bundleè·¯å¾„æ¢æˆåˆ‡æ¢åè¯­è¨€çš„è·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// self.currentLanguage ä¸º zh-hans æˆ– zh-Hant æˆ– en</div><div class="line">NSString *path = [[NSBundle mainBundle]pathForResource:self.currentLanguage ofType:@&quot;lproj&quot;];</div><div class="line">self.bundle = [NSBundle bundleWithPath:path];</div></pre></td></tr></table></figure>
<p>è·å–keyå¯¹åº”çš„valueæ—¶ï¼Œå¯ä»¥è¿™æ ·å†™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-(NSString *)getStringForKey:(NSString *)key withTable:(NSString *)table</div><div class="line">&#123;</div><div class="line">    if (self.bundle)</div><div class="line">    &#123;</div><div class="line">        return NSLocalizedStringFromTableInBundle(key, table, self.bundle, @&quot;&quot;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return NSLocalizedStringFromTable(key, table, @&quot;&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>-(NSString *)getStringForKey:(NSString *)key withTable:(NSString *)table</code> è¿™ä¸ªæ–¹æ³•ä¸ºè¯­è¨€ç®¡ç†å•ä¾‹ç±»çš„publicæ–¹æ³•ï¼Œåœ¨ <code>.h</code>æ–‡ä»¶ä¸­å£°æ˜ï¼Œvalueéƒ½æ˜¯é€šè¿‡å•ä¾‹ç±»è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥è·å¾—å„ä¸ªè¯­è¨€çš„valueã€‚</p>
<h4 id="å’ŒæœåŠ¡ç«¯çš„åŒæ­¥"><a href="#å’ŒæœåŠ¡ç«¯çš„åŒæ­¥" class="headerlink" title="å’ŒæœåŠ¡ç«¯çš„åŒæ­¥"></a>å’ŒæœåŠ¡ç«¯çš„åŒæ­¥</h4><p>å½“æˆ‘ä»¬ä»APPStoreä¸‹è½½APPåï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€åº”ç”¨è·å¾—å½“å‰æ‰‹æœºç³»ç»Ÿçš„è¯­è¨€ï¼Œè¿˜è¦æŠŠè¿™ä¸ªè¯­è¨€åŒæ­¥åˆ°æœåŠ¡ç«¯ï¼Œå‘Šè¯‰æœåŠ¡ç«¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å“ªä¸ªè¯­è¨€ï¼Œå¹¶ä¸”åç»­çš„æ¥å£è°ƒç”¨éƒ½è¦ç”¨åˆ°è¿™ä¸ªè¯­è¨€idã€‚</p>
<p>æœåŠ¡ç«¯ä¿å­˜ä¸€ä»½æ‰‹æœºç³»ç»Ÿä¸Šæ‰€æœ‰è¯­è¨€çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œåˆ†å®‰å“å’ŒiOSï¼Œè¿™ä¸ªéœ€è¦å®‰å“å¼€å‘äººå‘˜å’ŒiOSå¼€å‘äººå‘˜æä¾›ç»™åå°ï¼Œæ¯”å¦‚æˆ‘æä¾›çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@&quot;zh-Hans&quot;  //ç®€ä½“ä¸­æ–‡</div><div class="line">@&quot;zh-Hant&quot; //ç¹ä½“ä¸­æ–‡</div><div class="line">@&quot;en&quot; //è‹±è¯­</div><div class="line">@&quot;ja&quot; //æ—¥æ–‡</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œé€šè¿‡ <code>[NSLocale preferredLanguages].firstObject</code> è¿™ä¸ªæ–¹æ³•è·å¾—å½“å‰æ‰‹æœºç³»ç»Ÿè¯­è¨€ï¼Œè°ƒç”¨æœåŠ¡ç«¯è¯­è¨€æ¥å£åï¼Œæ‹¿å½“å‰æ‰‹æœºç³»ç»Ÿè¯­è¨€å’Œæ¥å£æ•°æ®å¯¹æ¯”ï¼Œè·å¾—è¯­è¨€idï¼Œç„¶ååç»­çš„æ¥å£è°ƒç”¨éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªè¯­è¨€idäº†ã€‚</p>
<h4 id="ç¬¬ä¸‰æ–¹åº“çš„å›½é™…åŒ–"><a href="#ç¬¬ä¸‰æ–¹åº“çš„å›½é™…åŒ–" class="headerlink" title="ç¬¬ä¸‰æ–¹åº“çš„å›½é™…åŒ–"></a>ç¬¬ä¸‰æ–¹åº“çš„å›½é™…åŒ–</h4><p>é¡¹ç›®é‡Œé‡‡ç”¨äº† <code>MJRefresh</code> ç¬¬ä¸‰æ–¹åˆ·æ–°åº“ï¼Œæ§ä»¶é‡Œçš„åˆ·æ–°çŠ¶æ€æ–‡å­—ä¹Ÿè¦å›½é™…åŒ–ã€‚ä½†æ˜¯è¿™ä¸ªåº“çš„å›½é™…åŒ–æ˜¯è‡ªå·±åšçš„ï¼Œå½“APPå†…åˆ‡æ¢è¯­è¨€åï¼Œæ§ä»¶ä¸Šçš„æ–‡å­—è¿˜æ˜¯ä¹‹å‰è¯­è¨€çš„æ–‡å­—ã€‚çœ‹äº†ä¸‹æºç ï¼Œæœ€åé€šè¿‡ <code>NSBundle+MJRefresh</code> æ–‡ä»¶é‡Œçš„è¿™ä¸ªæ–¹æ³•æ¥è·å¾—ä¸åŒè¯­è¨€çš„value</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (NSString *)mj_localizedStringForKey:(NSString *)key value:(NSString *)value &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡å½“å‰è¯­è¨€ï¼Œè·å¾—bundleèµ„æºæ–‡ä»¶ï¼Œç„¶ååœ¨èµ„æºæ–‡ä»¶é‡Œå¾—åˆ°valueåè¿”å›ã€‚å› ä¸ºå®ƒè‡ªå·±æœ‰bundleèµ„æºæ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠbundleæ–‡ä»¶çš„è·¯å¾„æ¢æˆå½“å‰è¯­è¨€çš„æ–‡ä»¶è·¯å¾„å°±å¯ä»¥äº†ã€‚</p>
<p>å½“ç„¶äº†ï¼Œä¸åªè¿™ä¸ªåˆ·æ–°æ§ä»¶ï¼Œå…¶ä»–æœ‰ä½¿ç”¨é“çš„ç¬¬ä¸‰æ–¹åº“ï¼Œä¹Ÿè¦å›½é™…åŒ–ä¸€ä¸‹ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/06/æˆ‘çš„äº§å“ä½“ä¼š/" itemprop="url">
                  æˆ‘çš„äº§å“ä½“ä¼š
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-07-06T11:18:04+08:00" content="2018-07-06">
              2018-07-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/è¯»ä¹¦ä¸æ„Ÿæ‚Ÿ/" itemprop="url" rel="index">
                    <span itemprop="name">è¯»ä¹¦ä¸æ„Ÿæ‚Ÿ</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/06/æˆ‘çš„äº§å“ä½“ä¼š/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/07/06/æˆ‘çš„äº§å“ä½“ä¼š/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/07/06/æˆ‘çš„äº§å“ä½“ä¼š/" class="leancloud_visitors" data-flag-title="æˆ‘çš„äº§å“ä½“ä¼š">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>è¸å…¥äº’è”ç½‘ç§»åŠ¨å¼€å‘è¿™ä¸ªè¡Œä¸šä¹Ÿæœ‰ä¸‰å¹´äº†ï¼Œä»å½“åˆçš„æ‡µæ‡µæ‡‚æ‡‚åˆ°ç°åœ¨ç•¥æœ‰æ€è€ƒï¼Œè¿™é‡Œè¯´æ€è€ƒæœ‰ç‚¹å¤¸å¤§äº†ï¼Œåªæ˜¯ä»ç å†œçš„è§’åº¦ï¼Œå¯¹äºäº§å“æœ‰è‡ªå·±çš„ä¸€ç‚¹ä½“ä¼šã€‚å¯èƒ½ä¸å…¶ä»–ç¨‹åºå‘˜ä¸åŒï¼Œå…¶ä»–ä»äº‹æŠ€æœ¯çš„ç¨‹åºå‘˜ï¼Œéƒ½æƒ³æˆä¸ºå…¨æ ˆå·¥ç¨‹å¸ˆï¼Œå­¦å­¦åç«¯ï¼Œå­¦å­¦å‰ç«¯ï¼Œä½†æ˜¯è‡ªå·±åœ¨é—²æš‡ä¹‹ä½™ï¼Œæ›´å¤šçš„æ˜¯æ€è€ƒå¦‚ä½•åšå¥½ä¸€ä¸ªäº§å“ï¼Œç»™ç”¨æˆ·æ›´å¥½çš„ä½“éªŒã€‚æœ€è¿‘è‡ªå·±ä¹Ÿçœ‹äº†å‡ æœ¬å…³äºäº’è”ç½‘åŠäº§å“çš„ä¹¦ç±ï¼Œç»“åˆè‡ªå·±çš„ç»éªŒï¼Œè¯´ä¸€ä¸‹è‡ªå·±çš„æ‹™è§ã€‚<br>æˆ‘è§‰å¾—ä¸€ä¸ªå¥½äº§å“ï¼Œåº”è¯¥æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æœ‰ç”¨</li>
<li>å¥½ç”¨</li>
<li>æ”¹è¿›çš„èƒ½åŠ›</li>
<li>å•†ä¸šæ¨¡å¼</li>
</ul>
<h3 id="å¯¹æˆ‘æœ‰ç”¨"><a href="#å¯¹æˆ‘æœ‰ç”¨" class="headerlink" title="å¯¹æˆ‘æœ‰ç”¨"></a>å¯¹æˆ‘æœ‰ç”¨</h3><p>æœ‰ç”¨ï¼Œå³ä½ è¿™ä¸ªäº§å“å¯¹äºæˆ‘åˆ°åº•æœ‰ä»€ä¹ˆç”¨å¤„ï¼Œæˆ‘èƒ½ä»ä¸­å¾—åˆ°ä»€ä¹ˆæ–¹ä¾¿ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯å®šä½ä½ çš„æ ¸å¿ƒåŠŸèƒ½ä»¥åŠæ ¸å¿ƒç”¨æˆ·ã€‚æ¯”å¦‚ï¼Œä½ å‘æˆ‘ä»‹ç»ä¸€ä¸ªå°è¯´ç±»APPï¼Œè¯´å®ƒå†…å®¹å¦‚ä½•ä¸°å¯Œï¼Œä½“éªŒå¦‚ä½•è‰¯å¥½ï¼Œä½†æ˜¯æˆ‘ä»æ¥ä¸çœ‹å°è¯´ï¼Œä½•æ¥ç”¨è¿™ä¸ªå°è¯´APPä¹‹è¯´ã€‚åœ¨åšäº§å“çš„æ—¶å€™ï¼Œå¼€å‘ä¸€ä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œå°½é‡å¤šæƒ³æƒ³è¿™ä¸ªåŠŸèƒ½æ˜¯å¦å¯¹ç”¨æˆ·æœ‰ç”¨å¤„ï¼Œæ˜¯å¦å¯¹äº§å“çš„æ ¸å¿ƒç”¨æˆ·æœ‰å¥½å¤„ã€‚å½“è¦åŠ å…¥ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œå¤šå¬å¬æ ¸å¿ƒç”¨æˆ·çš„å£°éŸ³ã€‚</p>
<p>å¦‚ä½•å®šä½ä½ çš„æ ¸å¿ƒç”¨æˆ·ï¼Œç”¨æˆ·æ˜¯ä»€ä¹ˆæ ·çš„äººï¼Œç”¨æˆ·éœ€è¦ä»€ä¹ˆï¼Œç”¨æˆ·å–œæ¬¢ä»€ä¹ˆï¼Œç”¨æˆ·è®¨åŒä»€ä¹ˆï¼Œå¯¹äºä¸åŒçš„è¡Œä¸šå¹³å°ï¼Œè¦æœ‰ä¸åŒçš„æ€è€ƒæ–¹å¼ã€‚æ¯”å¦‚å¯¹äºçŸ¥ä¹ï¼Œç®€ä¹¦ï¼Œæ˜é‡‘è¿™ç§æ³¨é‡å†…å®¹çš„ï¼Œé‚£äº›èƒ½å¤Ÿäº§ç”Ÿé«˜è´¨çš„åšå®¢çš„ç”¨æˆ·ï¼Œå°±æ˜¯æ ¸å¿ƒç”¨æˆ·ï¼›å¯¹äºæ‰“è½¦ç±»çš„APPè€Œè¨€ï¼Œç»å¸¸å‡ºå·®çš„ç”¨æˆ·å°±æ˜¯æ ¸å¿ƒç”¨æˆ·ï¼›YYè¯­éŸ³çš„æ ¸å¿ƒç”¨æˆ·æ˜¯æ¸¸æˆç©å®¶ã€‚</p>
<p>å½“ä½ çš„æ ¸å¿ƒåŠŸèƒ½å®šä½ä»¥åï¼Œä¸è¦è½»æ˜“è½¬å‹ï¼Œä¹Ÿå¯ä»¥è¯´ï¼Œæƒ³è½¬å‹ä¹Ÿä¸æ˜¯é‚£ä¹ˆå®¹æ˜“çš„ã€‚</p>
<p>æ¯”å¦‚æˆ‘ç°åœ¨åšçš„è¿™ä¸ªç¾ç”²APPï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯è§†é¢‘æ•™å­¦ï¼Œç¾å›¾å±•ç¤ºï¼›å®ƒçš„æ ¸å¿ƒç”¨æˆ·å°±æ˜¯é‚£äº›æœ‰å¼ºçƒˆçš„å­¦ä¹ æ¬²æœ›ï¼Œé€šè¿‡è¿™ä¸ªå¹³å°èƒ½å¤Ÿæå‡è‡ªå·±çš„èƒ½åŠ›ï¼Œè´­ä¹°æ‰€éœ€è¦çš„ç‰©å“ã€‚</p>
<h3 id="å¥½ç”¨"><a href="#å¥½ç”¨" class="headerlink" title="å¥½ç”¨"></a>å¥½ç”¨</h3><p>å¥½ç”¨ï¼Œå³ä½ è¿™ä¸ªäº§å“ç”¨èµ·æ¥æ˜¯å¦æ–¹ä¾¿ï¼Œå¯¹æ¯”ä¸åŒè¡Œçš„ç«äº‰å“ï¼Œæœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹å¸å¼•æˆ‘ã€‚</p>
<p>æˆ‘ä¸€ç›´æå€¡çš„æ˜¯ï¼Œä¿è¯å†…å®¹ä¼˜è´¨çš„æƒ…å†µä¸‹ï¼Œç•Œé¢è¶Šç®€æ´è¶Šå¥½ã€‚è¿™é‡Œä¸å¾—ä¸è¯´ä¸€ä¸‹å¾®ä¿¡ï¼Œå¾®ä¿¡è‡ªä»ä¸Šçº¿ä»¥æ¥ï¼Œç•Œé¢ä¸€ç›´ä¿æŒç®€æ´æ¸…çˆ½çš„é£æ ¼ï¼Œå¹¶ä¸”å¯æ§åˆ¶ç•Œé¢çš„æ˜¾ç¤ºå†…å®¹ï¼Œæ¯”å¦‚å‘ç°é¡µé¢çš„ç®¡ç†ã€‚è¿™é‡Œå°±ä½“ç°å‡ºç•Œé¢è®¾è®¡å¸ˆçš„é‡è¦æ€§äº†ï¼Œä¸€ä¸ªç•Œé¢è¯¥æ˜¾ç¤ºä»€ä¹ˆï¼Œä¸è¯¥æ˜¾ç¤ºä»€ä¹ˆï¼Œæ˜¾ç¤ºçš„è¯ï¼Œåº”è¯¥ä»¥æ€æ ·çš„æ–¹å¼å»å‘ˆç°ï¼Œè¿™äº›éƒ½åº”è¯¥æ˜¯å¥½å¥½æ–Ÿé…Œçš„ä¸œè¥¿ã€‚å†æ¯”å¦‚æˆ‘æœ‰æ—¶å€™ä¼šçœ‹ä¸€ä¸‹æ¸¸æˆç›´æ’­ï¼Œè™ç‰™ï¼Œæ–—é±¼ï¼Œç†ŠçŒ«è¿™äº›APPéƒ½ç”¨è¿‡ï¼Œå…¶ä¸­æœ€å–œæ¬¢è™ç‰™APPçš„ç•Œé¢é£æ ¼ï¼Œå¾ˆç®€æ´ï¼Œæ²¡æœ‰æ‚ä¹±æ— ç« çš„å†…å®¹ã€‚æˆ‘å°±åªæ˜¯æƒ³ç®€å•çš„çœ‹ä¸ªç›´æ’­è€Œå·²ï¼Œå…¶ä»–APPç¡®ç»™æˆ‘æ¨èäº†å¾ˆå¤šæ— ç”¨çš„ä¿¡æ¯ã€‚</p>
<p>è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œè®¾ç½®ç•Œé¢å¦‚ä½•æ’ç‰ˆã€‚è®¾ç½®ç•Œé¢åŒ…æ‹¬å¯¹è´¦å·çš„ç®¡ç†ã€APPè®¾ç½®çš„ç®¡ç†ä»¥åŠå…¶ä»–è¾…åŠ©çš„å°åŠŸèƒ½ã€‚è¿™é‡Œè¦åˆ†æ¸…ä»€ä¹ˆåŠŸèƒ½è¦å½’åˆ°è´¦å·ç®¡ç†ç±»ç›®ä¸‹ï¼Œä»€ä¹ˆåŠŸèƒ½å½’åˆ°APPè®¾ç½®ç®¡ç†ç±»ç›®ä¸‹ï¼Œå†…å®¹å®šä¸‹æ¥ï¼Œå‘ˆç°é£æ ¼å°±æŒ‰å¹³å°çš„é£æ ¼æ¥å‘ˆç°ã€‚iOS APPçš„é£æ ¼å°±æŒ‰è‹¹æœæ‰‹æœºæœ¬èº«è®¾ç½®é‡Œçš„é£æ ¼æ¥ï¼Œå®‰å“APPå°±æŒ‰å®‰å“æ‰‹æœºæœ¬èº«çš„è®¾ç½®é£æ ¼æ¥ï¼Œæ²¡å¿…è¦å®Œå…¨ç»Ÿä¸€ã€‚</p>
<p>è¿™é‡Œé¢å¤–æä¸€ç‚¹ï¼Œå°½é‡å°‘ç”¨å¼¹æ¡†ï¼Œè¿™æ˜¯ç”¨æˆ·å¾ˆåæ„Ÿçš„ä¿¡æ¯å‘ˆç°å½¢å¼ã€‚</p>
<h3 id="æ”¹è¿›çš„èƒ½åŠ›"><a href="#æ”¹è¿›çš„èƒ½åŠ›" class="headerlink" title="æ”¹è¿›çš„èƒ½åŠ›"></a>æ”¹è¿›çš„èƒ½åŠ›</h3><p>æ„æ€å°±æ˜¯ä½ çš„äº§å“è¦æœ‰æŒç»­çš„æ”¹è¿›ç­‰èƒ½åŠ›ï¼Œä¸è¦ä¸€ç›´åŸåœ°è¸æ­¥ï¼Œæ¯”å¦‚å…¶ä»–APPä¸Šæœ‰ä¸€äº›ä¼˜ç§€çš„äº¤äº’è®¾è®¡ï¼Œå¯ä»¥å€Ÿé‰´ä¸€ä¸‹ã€‚ä½†æ˜¯æœ‰ä¸€ç‚¹ç‰¹åˆ«é‡è¦ï¼Œå¦‚æœåªæ˜¯ä¸€å‘³çš„æŠ„è¢­å€Ÿé‰´ï¼Œé‚£ä¹ˆæ°¸è¿œä¹Ÿå­¦ä¸åˆ°å®ƒçš„ç²¾é«“ã€‚</p>
<p>å½“ä½ åŠ å…¥äº†ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œæ¯”å¦‚ç¤¾åŒºç­‰ï¼Œç”¨è¿™ä¸ªåŠŸèƒ½çš„äººå¾ˆå°‘ï¼Œè¿™æ—¶å°±è¦æ€è€ƒè¿™ä¸ªåŠŸèƒ½å¯¹äºä½ è¿™ä¸ªAPPçš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Œæ˜¯å¦çœŸçš„ç»™ç”¨æˆ·å¸¦æ¥äº†å¥½å¤„ï¼Ÿ</p>
<p>å½“ä½ çš„æ ¸å¿ƒç”¨æˆ·ç»™ä½ çš„äº§å“æå»ºè®®æ—¶ï¼Œä¸è¦å¿½è§†å®ƒï¼Œå› ä¸ºè¿™æ˜¯çœŸçœŸæ­£æ­£ä½¿ç”¨ä½ äº§å“çš„äººçš„æƒ³æ³•ã€‚å¦‚æœä»–çš„å»ºè®®è¢«é‡‡çº³ï¼Œä¸‹ä¸ªç‰ˆæœ¬ä¸­æ›´æ–°äº†ä»–çš„å»ºè®®ï¼Œé‚£ä¹ˆä»–è‚¯å®šä¼šè®¤ä¸ºè¿™ä¸ªäº§å“æ˜¯ä¸ªä¸æ–­æˆé•¿çš„äº§å“ï¼Œä»–è®¤å¯äº†è¿™ä¸ªäº§å“ï¼Œè¯´ä¸ä¸€å®šä»–è¿˜ä¼šå‘åŒäº‹æœ‹å‹å»æ¨é”€ä½ çš„äº§å“ã€‚</p>
<h3 id="å•†ä¸šæ¨¡å¼"><a href="#å•†ä¸šæ¨¡å¼" class="headerlink" title="å•†ä¸šæ¨¡å¼"></a>å•†ä¸šæ¨¡å¼</h3><p>å•†ä¸šæ¨¡å¼ï¼Œæˆ‘ç†è§£çš„åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ¨å¹¿æ¨¡å¼ï¼ŒäºŒæ˜¯ç›ˆåˆ©æ¨¡å¼ã€‚</p>
<p>å¯¹äºå¦‚ä½•æ¨å¹¿ï¼Œä¸€å‘³çš„ç ¸é’±æ˜¯è¡Œä¸é€šçš„ï¼Œåªèƒ½è§£å†³å¾—äº†ä¸€æ—¶ã€‚ä¸€ä¸ªæ¨å¹¿æ¨¡å¼æ˜¯å¦ä¸ºå¥½çš„æ¨å¹¿æ¨¡å¼ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ï¼Œä¸å†ç ¸é’±äº†ï¼Œçœ‹ç”¨æˆ·æ•°æ˜¯å¦è¿˜åœ¨å¢é•¿ã€‚å¯¹äºç›ˆåˆ©æ¨¡å¼ï¼Œåœ¨æ‰¾æŠ•èµ„æ—¶ï¼ŒæŠ•èµ„äººéƒ½ä¼šé—®ï¼Œä½ çš„äº§å“å°†æ¥æ€ä¹ˆèµ¢åˆ©ï¼Œæœ‰æ²¡æœ‰æ‰¾åˆ°å¥½çš„ç›ˆåˆ©æ¨¡å¼ã€‚åœ¨å‘¨é¸¿ç¥çš„ã€Šæˆ‘çš„äº’è”ç½‘æ–¹æ³•è®ºã€‹ä¸­æåˆ°äº†äº’è”ç½‘çš„ç›ˆåˆ©æ¨¡å¼æœ‰ä¸‰ç§ï¼š</p>
<p>1.åœ¨ç½‘ä¸Šå–ä¸œè¥¿ã€‚å–çœŸå®çš„ä¸œè¥¿ï¼Œè¡£æœé‹å­ï¼Œè¿™ç§å«ç”µå­å•†åŠ¡ï¼›å–è‚¡ç¥¨åŸºé‡‘ç­‰ç†è´¢äº§å“ï¼Œå«äº’è”ç½‘é‡‘èï¼›å–è™šæ‹Ÿçš„æœåŠ¡ï¼Œå«O2O.</p>
<p>2.ä¾é å¹¿å‘Šæ”¶å…¥ã€‚</p>
<p>3.ä»¥ç½‘æ¸¸ä¸ºä»£è¡¨çš„å¢å€¼æœåŠ¡ã€‚</p>
<p>è¿™ä¸‰ç§æ–¹å¼éƒ½å¾ˆå¸¸è§ï¼Œè€Œå¯¹äºç§»åŠ¨APPæ¥è¯´ï¼Œæœ€æ™®éçš„å°±æ˜¯å¹¿å‘Šæ”¶å…¥äº†ï¼Œé€šè¿‡æ¥å…¥å¹¿å‘Šï¼Œæ¥èµšå–åˆ©ç›Šã€‚ä½†æ˜¯ï¼Œæ¥å…¥å¹¿å‘Šä¹Ÿè¦æœ‰å¥½çš„æ–¹æ³•ï¼Œä¸è¦è®©ç”¨æˆ·åæ„Ÿã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œä¸€ä¸ªäº§å“è¦æœ‰ä¸€ä¸ªå¥½çš„æƒ³æ³•ï¼Œå¥½çš„æ–¹å‘ï¼Œæ˜¯å¦èƒ½ä¸ºå¤§ä¼—ç¾¤ä½“æä¾›æ–¹ä¾¿ï¼ŒåŠ ä¸Šå¯é çš„æŠ€æœ¯å›¢é˜Ÿå®åŠ›å’Œæ¨å¹¿æ‰‹æ®µã€‚å”‰ï¼Œè¿™è¯è¯´èµ·æ¥å®¹æ˜“ï¼Œå®ç°èµ·æ¥ä½•å…¶éš¾å•Šï¼</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/16/ç¨‹åºçš„å¯åŠ¨é“¾æ¥è¿‡ç¨‹/" itemprop="url">
                  ç¨‹åºçš„å¯åŠ¨é“¾æ¥è¿‡ç¨‹
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-03-16T10:32:04+08:00" content="2018-03-16">
              2018-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/03/16/ç¨‹åºçš„å¯åŠ¨é“¾æ¥è¿‡ç¨‹/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/03/16/ç¨‹åºçš„å¯åŠ¨é“¾æ¥è¿‡ç¨‹/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/03/16/ç¨‹åºçš„å¯åŠ¨é“¾æ¥è¿‡ç¨‹/" class="leancloud_visitors" data-flag-title="ç¨‹åºçš„å¯åŠ¨é“¾æ¥è¿‡ç¨‹">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mainå‡½æ•°æ˜¯ç¨‹åºçš„å¯åŠ¨å…¥å£ï¼Œä½†æ˜¯ç³»ç»Ÿä¸ºç¨‹åºçš„å¯åŠ¨åˆåšäº†å“ªäº›å‡†å¤‡å‘¢ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åˆæ˜¯æ€æ ·åŠ è½½è¿›å†…å­˜çš„å‘¢ï¼Ÿè¿™ä¸¤å¤©èŠ±äº†ç‚¹æ—¶é—´æ·±å…¥äº†äº†è§£äº†ä¸€ä¸‹ã€‚</p>
<h3 id="Mach-Oæ ¼å¼ç®€å•ä»‹ç»"><a href="#Mach-Oæ ¼å¼ç®€å•ä»‹ç»" class="headerlink" title="Mach-Oæ ¼å¼ç®€å•ä»‹ç»"></a>Mach-Oæ ¼å¼ç®€å•ä»‹ç»</h3><p>Machåˆ™æ˜¯è‹¹æœæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œåœ¨Machä¸Šï¼Œä¸€ç§å¯æ‰§è¡Œçš„æ–‡ä»¶æ ¼æ˜¯å°±æ˜¯Mach-Oï¼ˆMach Object file formatï¼‰ï¼Œè¿™æ˜¯ä¸€ç§ç”¨äºè®°å½•å¯æ‰§è¡Œæ–‡ä»¶ã€å¯¹è±¡ä»£ç ã€å…±äº«åº“ã€åŠ¨æ€åŠ è½½ä»£ç å’Œå†…å­˜è½¬å‚¨çš„æ–‡ä»¶æ ¼å¼ã€‚Mach-O æ–‡ä»¶ä¸€èˆ¬éƒ½æœ‰ä¸€ä¸ª Header ï¼Œå„ç§ Load Commands ä»¥åŠå¤šä¸ª Segmentï¼š<br><img src="http://ocauxqtbu.bkt.clouddn.com/link_mach-o.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.Headerï¼šä¿å­˜äº†Mach-Oçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†å¹³å°ã€æ–‡ä»¶ç±»å‹ã€LoadCommandsçš„ä¸ªæ•°ç­‰ç­‰ã€‚</div><div class="line">2.LoadCommandsï¼šè¿™ä¸€æ®µç´§è·ŸHeaderï¼ŒåŠ è½½Mach-Oæ–‡ä»¶æ—¶ä¼šä½¿ç”¨è¿™é‡Œçš„æ•°æ®æ¥ç¡®å®šå†…å­˜çš„åˆ†å¸ƒã€‚</div><div class="line">3.Dataï¼šæ¯ä¸€ä¸ªsegmentçš„å…·ä½“æ•°æ®éƒ½ä¿å­˜åœ¨è¿™é‡Œï¼Œè¿™é‡ŒåŒ…å«äº†å…·ä½“çš„ä»£ç ã€æ•°æ®ç­‰ç­‰ã€‚</div></pre></td></tr></table></figure>
<p>####Header<br><img src="http://ocauxqtbu.bkt.clouddn.com/link_mach-o_header.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Magic Number:			è¯¥æ–‡ä»¶æ˜¯64ä½å¹³å°æ–‡ä»¶è¿˜æ˜¯32ä½å¹³å°æ–‡ä»¶ã€‚å€¼ä¸º0xFEEDFACFè¡¨ç¤º64ä½ï¼Œ0xFEEDFACEè¡¨ç¤º32ä½ï¼›</div><div class="line">CPU Type,CPU subType:	ç¡®å®šCPUçš„å¹³å°ä¸ç‰ˆæœ¬ï¼›</div><div class="line">File Type:				è¯¥æ–‡ä»¶çš„ç±»å‹ã€‚MH_EXECUTEè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼›</div><div class="line">Number of 				Load Commands:Load Commandsçš„ä¸ªæ•°ï¼›</div><div class="line">Size of Load Commands:	Load Commandsçš„é•¿åº¦ï¼›</div><div class="line">Flags:					dylbåŠ è½½æ—¶éœ€è¦çš„æ ‡å¿—ä½ï¼›</div><div class="line">Reserved:				åªæœ‰64ä½çš„æ—¶å€™æ‰å­˜åœ¨çš„å­—æ®µï¼Œæš‚æ—¶æ²¡ç”¨</div></pre></td></tr></table></figure>
<p>####Load Commands<br>Load Commandsè¡¨ç¤ºçš„æ˜¯åŠ è½½å‘½ä»¤ï¼Œä¸åŒçš„å­—æ®µå°±æ˜¯è¡¨ç¤ºä¸åŒçš„å‘½ä»¤ï¼Œé€šè¿‡è§£æLoadCommandæ¥åŠ è½½æ¥ä¸‹æ¥çš„æ•°æ®ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LC_MAINï¼šæ•´ä¸ªç¨‹åºçš„å…¥å£åœ°å€ï¼Œä¿è¯è¿›ç¨‹å¯åŠ¨åèƒ½å¤Ÿæ­£å¸¸çš„å¼€å§‹æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¿è¡Œ</div><div class="line">LC_UUIDï¼šå”¯ä¸€ID</div><div class="line">LC_LOAD_DYLINKERï¼šè·å¾—åŠ¨æ€åŠ è½½å™¨åœ°å€,è°ƒç”¨dylbç¨‹åº</div><div class="line">LC_CODE_SIGNATUREï¼šè¿›è¡Œæ•°å­—ç­¾å.</div></pre></td></tr></table></figure>
<p>ç­‰ç­‰</p>
<p>####Segment &amp; Section<br>Dataè¡¨ç¤ºåŸå§‹æ•°æ®,å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ®µï¼ˆsegmentï¼‰ï¼Œæ¯ä¸ªæ®µå¯ä»¥æ‹¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªåŒºåŸŸï¼ˆsectionï¼‰ã€‚æ¯ä¸€ä¸ªæ®µï¼ˆsegmentï¼‰éƒ½æ‹¥æœ‰ä¸€æ®µè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚<br>åŠ è½½æ•°æ®æ—¶ï¼Œä¸»è¦åŠ è½½çš„å°±æ˜¯<code>LC_SEGMENT</code>æˆ–è€…<code>LC_SEGMENT_64</code>ã€‚è¿™é‡Œå¤§éƒ¨åˆ†çš„æ•°æ®æ˜¯ç”¨æ¥å¸®åŠ©å†…æ ¸å°†Segmentæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ã€‚<code>LC_SEGMENT_64</code>çš„æ•°æ®ç»“æ„ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">struct segment_command_64 &#123; /* for 64-bit architectures */</div><div class="line">	uint32_t	cmd;		/* LC_SEGMENT_64 */</div><div class="line">	uint32_t	cmdsize;	/* load commandçš„å¤§å° */</div><div class="line">	char		segname[16];	/* segment name */</div><div class="line">	uint64_t	vmaddr;		/* æ®µçš„è™šæ‹Ÿå†…å­˜åœ°å€ */</div><div class="line">	uint64_t	vmsize;		/*  æ®µçš„è™šæ‹Ÿå†…å­˜å¤§å° */</div><div class="line">	uint64_t	fileoff;	/* æ®µåœ¨æ–‡ä»¶ä¸­åç§»é‡ */</div><div class="line">	uint64_t	filesize;	/* æ®µåœ¨æ–‡ä»¶ä¸­çš„å¤§å° */</div><div class="line">	vm_prot_t	maxprot;	/* maximum VM protection */</div><div class="line">	vm_prot_t	initprot;	/* initial VM protection */</div><div class="line">	uint32_t	nsects;		/* æ ‡ç¤ºäº†Segmentä¸­æœ‰å¤šå°‘secetion */</div><div class="line">	uint32_t	flags;		/* flags */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Sectionçš„æ•°æ®ç»“æ„ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">struct section &#123; /* for 32-bit architectures */</div><div class="line">    char        sectname[16];   /* name of this section */</div><div class="line">    char        segname[16];    /* segment this section goes in */</div><div class="line">    uint32_t    addr;       /* memory address of this section */</div><div class="line">    uint32_t    size;       /* size in bytes of this section */</div><div class="line">    uint32_t    offset;     /* file offset of this section */</div><div class="line">    uint32_t    align;      /* å­—èŠ‚å¤§å°å¯¹é½ */</div><div class="line">    uint32_t    reloff;     /* file offset of relocation entries */</div><div class="line">    uint32_t    nreloc;     /* number of relocation entries */</div><div class="line">    uint32_t    flags;      /* flags (section type and attributes)*/</div><div class="line">    uint32_t    reserved1;  /* reserved (for offset or index) */</div><div class="line">    uint32_t    reserved2;  /* reserved (for count or sizeof) */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><p><code>__PAGEZERO</code>æ˜¯ç¬¬ä¸€ä¸ªæ®µï¼Œå®ƒçš„å¤§å°åœ¨ 32 ä½ç³»ç»Ÿæ˜¯ 4KB+ï¼Œè€Œåœ¨ 64 ä½ç³»ç»Ÿæ˜¯ 4GB+ã€‚ä½äºè™šæ‹Ÿå†…å­˜ä» 0x000000 åˆ° App çœŸå®èµ·å§‹ä½ç½®ä¹‹é—´ï¼Œéƒ½æ˜¯è¢«æ ‡è®°ä¸ºä¸å¯è¯»å†™å’Œä¸å¯æ‰§è¡Œã€‚å› ä¸ºé‡Œé¢å¹¶æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ file size ä¸º 0ã€‚ä¸»è¦çš„ä½œç”¨æ˜¯ä¸ºäº†æ•è· NULL æŒ‡é’ˆä½¿ç”¨å’ŒæŒ‡é’ˆæˆªæ–­é”™è¯¯ï¼Œé˜²æ­¢å¼•èµ·ç³»ç»Ÿå´©æºƒã€‚å¼€å‘ä¸­å¸¸è§çš„ EXC_BAD_ACCESS å¼‚å¸¸éƒ½æ˜¯å› ä¸ºé”™è¯¯è®¿é—®åˆ°è¿™é‡Œäº†ã€‚</p>
</li>
<li><p><code>__TEXT</code> æ®µåŒ…å«äº† Mach å¤´éƒ¨ï¼Œè¢«æ‰§è¡Œçš„ä»£ç å’Œåªè¯»å¸¸é‡ï¼Œå®ƒè¢«åªè¯»å’Œå¯æ‰§è¡Œçš„æ–¹å¼æ˜ å°„ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå¸¸è§çš„ sectionï¼š</p>
</li>
<li><p><code>__text</code> é‡Œå°±æ˜¯ç¨‹åºç¼–è¯‘åçš„æœºå™¨ç ã€‚</p>
</li>
<li><code>__stubs</code> å’Œ <code>__stub_helper</code> æ˜¯ç»™åŠ¨æ€é“¾æ¥å™¨ï¼ˆdyldï¼‰ä½¿ç”¨çš„ã€‚</li>
<li><code>__const</code> åŒ…å«å¸¸é‡å˜é‡ï¼Œæ‰€æœ‰ä¸éœ€è¦é‡å®šå‘çš„å¸¸é‡æ•°æ®éƒ½ä¼šè¢«ç¼–è¯‘å™¨æ”¾åœ¨è¿™é‡Œã€‚</li>
<li><code>__cstring</code> åŒ…å«ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²å¸¸é‡ã€‚</li>
<li><code>__DATA</code> æ®µåŒ…å«äº†å¯è¯»å†™çš„å†…å®¹ï¼Œå…¨å±€å˜é‡å’Œé™æ€å˜é‡ç­‰ï¼Œä»¥å¯è¯»å†™å’Œä¸å¯æ‰§è¡Œçš„æ–¹å¼æ˜ å°„ã€‚å¸¸è§çš„ section æœ‰ï¼š<br><code>__nl_symbol_ptr</code> å’Œ <code>__la_symbol_ptr</code> åˆ†åˆ«æ˜¯ non-lazy å’Œ lazy ç¬¦å·æŒ‡é’ˆã€‚lazy ç¬¦å·æŒ‡é’ˆç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ä¸­è°ƒç”¨æœªå®šä¹‰çš„å‡½æ•°ï¼Œä¾‹å¦‚ä¸åŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å‡½æ•°ï¼Œå®ƒä»¬å°†ä¼šå»¶è¿ŸåŠ è½½ã€‚è€Œé’ˆå¯¹ non-lazy ç¬¦å·æŒ‡é’ˆï¼Œå½“å¯æ‰§è¡Œæ–‡ä»¶è¢«åŠ è½½åŒæ—¶ï¼Œä¹Ÿä¼šè¢«åŠ è½½ã€‚</li>
<li><code>__const</code> åŒ…å«éœ€è¦é‡å®šå‘çš„å¸¸é‡æ•°æ®ã€‚</li>
<li><code>__bss</code> åŒ…å«æ²¡æœ‰è¢«åˆå§‹åŒ–çš„é™æ€å˜é‡ã€‚</li>
<li><code>__LINKEDIT</code> æ®µå®ƒçš„ä½œç”¨æ˜¯åŒ…å«å¦‚ä½•åŠ è½½æ•´ä¸ªæ–‡ä»¶çš„ã€Œå…ƒæ•°æ®ã€ã€‚ä¾‹å¦‚ç¬¦å·è¡¨ï¼Œå­—ç¬¦ä¸²è¡¨å’Œé‡å®šä½è¡¨ã€‚ä»£ç ç­¾ååæ¯é¡µçš„åŠ å¯†æ•£åˆ—å€¼ä¹Ÿä¼šå­˜å‚¨åˆ°è¿™é‡Œã€‚</li>
</ul>
<h3 id="åŠ¨æ€é“¾æ¥åº“"><a href="#åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="åŠ¨æ€é“¾æ¥åº“"></a>åŠ¨æ€é“¾æ¥åº“</h3><p>ä¸€ä¸ªç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ç®€å•åˆ†ä¸ºé¢„ç¼–è¯‘ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥ç­‰è¿‡ç¨‹ã€‚é“¾æ¥å°±æ˜¯è®²å¤šä¸ªç›®æ ‡æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«å°±æ˜¯åœ¨é“¾æ¥é˜¶æ®µå¦‚ä½•å¤„ç†åº“ã€‚åœ¨é“¾æ¥é˜¶æ®µï¼Œå°†æ±‡ç¼–ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¸å¼•ç”¨åˆ°çš„åº“ä¸€ä¸ªé“¾æ¥æ‰“åŒ…åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå› ä¸ºå¯¹åº”çš„é“¾æ¥æ–¹å¼æˆä¸ºé™æ€é“¾æ¥ã€‚è€ŒåŠ¨æ€åº“åœ¨ç¨‹åºç¼–è¯‘æ—¶å¹¶ä¸ä¼šè¢«è¿æ¥åˆ°ç›®æ ‡ä»£ç ä¸­ï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ˜¯æ‰è¢«è½½å…¥ã€‚ä½¿ç”¨åŠ¨æ€åº“çš„å¥½å¤„æœ‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.ä»£ç å…±ç”¨ï¼šå¾ˆå¤šç¨‹åºéƒ½åŠ¨æ€é“¾æ¥äº†è¿™äº› libï¼Œä½†å®ƒä»¬åœ¨å†…å­˜å’Œç£ç›˜ä¸­ä¸­åªæœ‰ä¸€ä»½</div><div class="line">2.æ˜“äºç»´æŠ¤ï¼šç”±äºè¢«ä¾èµ–çš„ lib æ˜¯ç¨‹åºæ‰§è¡Œæ—¶æ‰ link çš„ï¼Œæ‰€ä»¥è¿™äº› lib å¾ˆå®¹æ˜“åšæ›´æ–°</div><div class="line">3.å‡å°‘å¯æ‰§è¡Œæ–‡ä»¶ä½“ç§¯ï¼šç›¸æ¯”é™æ€é“¾æ¥ï¼ŒåŠ¨æ€é“¾æ¥åœ¨ç¼–è¯‘æ—¶ä¸éœ€è¦æ‰“è¿›å»ï¼Œæ‰€ä»¥å¯æ‰§è¡Œæ–‡ä»¶çš„ä½“ç§¯è¦å°å¾ˆå¤š</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯åŒæ ·çš„ï¼ŒåŠ è½½åŠ¨æ€åº“ï¼Œå°±éœ€è¦åŠ¨æ€è¿æ¥å™¨dylbã€‚åŠ¨æ€é“¾æ¥åŠ è½½å™¨åœ¨ç³»ç»Ÿä¸­ä»¥ä¸€ä¸ªç”¨æˆ·æ€çš„å¯æ‰§è¡Œæ–‡ä»¶å½¢å¼å­˜åœ¨ï¼Œä¸€èˆ¬åº”ç”¨ç¨‹åºä¼šåœ¨Mach-Oæ–‡ä»¶éƒ¨åˆ†æŒ‡å®šä¸€ä¸ªLC_LOAD_DYLINKERçš„åŠ è½½å‘½ä»¤ï¼Œæ­¤åŠ è½½å‘½ä»¤æŒ‡å®šäº†dyldçš„è·¯å¾„ï¼Œé€šå¸¸å®ƒçš„é»˜è®¤å€¼æ˜¯â€œ/usr/lib/dyldâ€ã€‚ç³»ç»Ÿå†…æ ¸åœ¨åŠ è½½Mach-Oæ–‡ä»¶æ—¶ï¼Œä¼šä½¿ç”¨è¯¥è·¯å¾„æŒ‡å®šçš„ç¨‹åºä½œä¸ºåŠ¨æ€åº“çš„åŠ è½½å™¨æ¥åŠ è½½dylibã€‚ä¸è¿‡dylbæ˜¯<a href="https://github.com/opensource-apple/dyld" target="_blank" rel="external">å¼€æº</a>çš„ã€‚</p>
<p>###mach-oæ–‡ä»¶åŠ è½½</p>
<p>####dyldè‡ªèº«å¦‚ä½•åŠ è½½</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/link_objc_init.png" alt="image"><br>æˆ‘ä»¬åœ¨ç¨‹åºä¸­è®¾ä¸ªæ–­ç‚¹ï¼Œæ–­åœ¨<code>_objc_init</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ ˆåº•çš„<code>_dylb_start</code>æ–¹æ³•ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†,æ—¢ç„¶å„ç§äºŒè¿›åˆ¶éƒ½æ˜¯èµ°dyldåŠ è½½çš„ï¼Œé‚£ä¹ˆdyldè‡ªèº«æ˜¯å¦‚ä½•åŠ è½½è¿›æ¥çš„å‘¢ï¼Ÿ<br>ç³»ç»Ÿåœ¨è§£æMach-Oæ–‡ä»¶æ—¶ï¼Œ<code>_dylb_start</code> çš„æ–¹æ³•åœ°å€çš„æ˜¯åœ¨ <code>LC_UNIXTHREAD</code> æ®µä¸­è§£æå‡ºæ¥çš„ï¼Œç„¶åé€šè¿‡ <code>LC_LOAD_DYLINKER</code> è¿™ä¸ªå­—æ®µæ¥å¯åŠ¨è¿™ä¸ªäºŒè¿›åˆ¶åŠ è½½å™¨ã€‚ä»ä¸‹é¢dylbçš„è¿™æ®µæºç å¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨å‰è¿˜è¦åšä¸€äº›å‡†å¤‡å¼•å¯¼å·¥ä½œï¼Œåˆ°æœ€åæ‰æ˜¯è°ƒç”¨<code>dyld::_main</code>æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">//  This is code to bootstrap dyld.  This work in normally done for a program by dyld and crt.</div><div class="line">//  In dyld we have to do this manually.</div><div class="line">//</div><div class="line">uintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], </div><div class="line">				intptr_t slide, const struct macho_header* dyldsMachHeader,</div><div class="line">				uintptr_t* startGlue)</div><div class="line">&#123;</div><div class="line">	// if kernel had to slide dyld, we need to fix up load sensitive locations</div><div class="line">	// we have to do this before using any global variables</div><div class="line">	if ( slide != 0 ) &#123;</div><div class="line">		rebaseDyld(dyldsMachHeader, slide);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// allow dyld to use mach messaging</div><div class="line">	mach_init();</div><div class="line"></div><div class="line">	// kernel sets up env pointer to be just past end of agv array</div><div class="line">	const char** envp = &amp;argv[argc+1];</div><div class="line">	</div><div class="line">	// kernel sets up apple pointer to be just past end of envp array</div><div class="line">	const char** apple = envp;</div><div class="line">	while(*apple != NULL) &#123; ++apple; &#125;</div><div class="line">	++apple;</div><div class="line"></div><div class="line">	// set up random value for stack canary</div><div class="line">	__guard_setup(apple);</div><div class="line"></div><div class="line">#if DYLD_INITIALIZER_SUPPORT</div><div class="line">	// run all C++ initializers inside dyld</div><div class="line">	runDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);</div><div class="line">#endif</div><div class="line"></div><div class="line">	// now that we are done bootstrapping dyld, call dyld&apos;s main</div><div class="line">	uintptr_t appsSlide = slideOfMainExecutable(appsMachHeader);</div><div class="line">	return dyld::_main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="é“¾æ¥è¿‡ç¨‹"><a href="#é“¾æ¥è¿‡ç¨‹" class="headerlink" title="é“¾æ¥è¿‡ç¨‹"></a>é“¾æ¥è¿‡ç¨‹</h3><p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹è½½æºç çœ‹ä¸‹ï¼Œ<code>dyld::_main</code>mainæ–¹æ³•åšçš„ä¸»è¦äº‹æƒ…æœ‰</p>
<ul>
<li>è®¾ç½®è¿è¡Œç¯å¢ƒï¼Œç¯å¢ƒå˜é‡</li>
<li>å®ä¾‹åŒ–Image</li>
<li>åŠ è½½å…±äº«ç¼“å­˜</li>
<li>åŠ¨æ€åº“çš„ç‰ˆæœ¬åŒ–é‡è½½</li>
<li>åŠ è½½æ’å…¥çš„åŠ¨æ€åº“</li>
<li>linkä¸»ç¨‹åº</li>
<li>linkæ’å…¥çš„åŠ¨æ€åº“</li>
<li>weakBindå¼±ç¬¦å·ç»‘å®š</li>
<li>initialize</li>
<li>æŸ¥æ‰¾å…¥å£ç‚¹å¹¶è¿”å›</li>
</ul>
<p>åœ¨æ‰€æœ‰çš„åŠ¨æ€åº“åšå¥½ç¬¦å·é‡å®šä½å’Œåˆå§‹åŒ–å·¥ä½œä¹‹åï¼Œä¹Ÿå°±æ˜¯ dyld::_main ä¸´è¿‘æœ«å°¾çš„æ—¶å€™ï¼Œdyld ä¼šè·å– main å‡½æ•°çš„åœ°å€è¿”å›ç»™ dyldï¼Œdyld ç´§æ¥ç€è°ƒç”¨ main å‡½æ•°ï¼Œå°†æ§åˆ¶æƒäº¤æ¢ç»™ä¸»ç¨‹åºï¼Œç¨‹åºå¼€å§‹çœŸæ­£çš„æ‰§è¡Œã€‚<br>ä¸‹é¢æ˜¯<code>dyld::_main</code>æ–¹æ³•çš„éƒ¨åˆ†æºä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">// Entry point for dyld.  The kernel loads dyld and jumps to __dyld_start which</div><div class="line">// sets up some registers and call this function.</div><div class="line">//</div><div class="line">// Returns address of main() in target program which __dyld_start jumps to</div><div class="line">//</div><div class="line">uintptr_t</div><div class="line">_main(const macho_header* mainExecutableMH, uintptr_t mainExecutableSlide, </div><div class="line">		int argc, const char* argv[], const char* envp[], const char* apple[], </div><div class="line">		uintptr_t* startGlue) &#123;</div><div class="line">		...</div><div class="line">		//å®ä¾‹åŒ–Image</div><div class="line">		sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</div><div class="line">		&#125;</div><div class="line">		...</div><div class="line">		//		åŠ è½½å…±äº«ç¼“å­˜</div><div class="line">		checkSharedRegionDisable();</div><div class="line">		...</div><div class="line">			#if DYLD_SHARED_CACHE_SUPPORT</div><div class="line">//		åŠ¨æ€åº“çš„ç‰ˆæœ¬åŒ–é‡è½½</div><div class="line">		if ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion )</div><div class="line">			mapSharedCache();</div><div class="line">	#endif</div><div class="line"></div><div class="line">		// Now that shared cache is loaded, setup an versioned dylib overrides</div><div class="line">	#if SUPPORT_VERSIONED_PATHS</div><div class="line">		checkVersionedPaths();</div><div class="line">	#endif</div><div class="line">//åŠ è½½æ’å…¥çš„åŠ¨æ€åº“</div><div class="line">		// load any inserted libraries</div><div class="line">		if	( sEnv.DYLD_INSERT_LIBRARIES != NULL ) &#123;</div><div class="line">			for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib) </div><div class="line">				loadInsertedDylib(*lib);</div><div class="line">		&#125;</div><div class="line">		// record count of inserted libraries so that a flat search will look at </div><div class="line">		// inserted libraries, then main, then others.</div><div class="line">		sInsertedDylibCount = sAllImages.size()-1;</div><div class="line"></div><div class="line">//		linkä¸»ç¨‹åº</div><div class="line">		// link main executable</div><div class="line">		gLinkContext.linkingMainExecutable = true;</div><div class="line">		link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL));</div><div class="line">		sMainExecutable-&gt;setNeverUnloadRecursive();</div><div class="line">		if ( sMainExecutable-&gt;forceFlat() ) &#123;</div><div class="line">			gLinkContext.bindFlat = true;</div><div class="line">			gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ä¾‹åŒ–imageçš„è¿‡ç¨‹,Runtimeçš„åˆå§‹åŒ–è¿‡ç¨‹å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„ã€‚è¿™ä¸ªimageä¸æ˜¯å›¾ç‰‡çš„æ„æ€ï¼Œå®ƒå¤§æ¦‚è¡¨ç¤ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<code>instantiateFromLoadedImage</code>è¿™ä¸ªæ–¹æ³•å°±æ˜¯å®ä¾‹åŒ–çš„è¿‡ç¨‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// The kernel maps in main executable before dyld gets control.  We need to </div><div class="line">// make an ImageLoader* for the already mapped in main executable.</div><div class="line">static ImageLoader* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path)</div><div class="line">&#123;</div><div class="line">	// try mach-o loader</div><div class="line">	if ( isCompatibleMachO((const uint8_t*)mh, path) ) &#123; //æ£€æµ‹machoæ–‡ä»¶æ˜¯å¦ç¬¦åˆæ¡ä»¶,æ„æ€æ˜¯è¯¥æ‰‹æœºèƒ½å¦å¤„ç†æ­¤mach-oæ–‡ä»¶</div><div class="line">//		åˆå§‹åŒ–å®ä¾‹ï¼šæ–¹æ³•å†…éƒ¨é€šè¿‡åˆ¤æ–­mach-oæ–‡ä»¶æ˜¯å¦æ˜¯å‹ç¼©è¿‡çš„ï¼Œç„¶åé€‰æ‹©ç›¸åº”çš„ç±»è¿›è¡Œå®ä¾‹åŒ–</div><div class="line">		ImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);</div><div class="line">//		æ·»åŠ imageåˆ°ç®¡ç†çš„æ¨¡å—ä¸­</div><div class="line">		addImage(image);</div><div class="line">		return image;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	throw &quot;main executable not a known format&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>isCompatibleMachO</code>æ–¹æ³•éƒ¨åˆ†æºç ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">// This is used to validate if a non-fat (aka thin or raw) mach-o file can be used</div><div class="line">// on the current processor. //</div><div class="line">bool isCompatibleMachO(const uint8_t* firstPage, const char* path)</div><div class="line">&#123;</div><div class="line">#if CPU_SUBTYPES_SUPPORTED</div><div class="line">	// It is deemed compatible if any of the following are true:</div><div class="line">	//  1) mach_header subtype is in list of compatible subtypes for running processor</div><div class="line">	//  2) mach_header subtype is same as running processor subtype</div><div class="line">	//  3) mach_header subtype runs on all processor variants</div><div class="line">	const mach_header* mh = (mach_header*)firstPage;</div><div class="line">	...</div><div class="line">	...</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ä»æ³¨é‡Šä¸­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼Œæ‰‹æœºæ‰èƒ½å¤„ç†æ­¤mach-oæ–‡ä»¶</p>
<ul>
<li>mach_headerä¸­çš„subtypeæ”¯æŒå½“å‰CPUç‰ˆæœ¬ã€‚</li>
<li>mach_headerä¸­çš„subtypeå’Œå½“å‰æ­£åœ¨è¿è¡Œçš„CPUç‰ˆæœ¬ç›¸åŒã€‚</li>
<li>mach_headerä¸­çš„subtypeåœ¨è¯¥CPUçš„æ‰€æœ‰ç‰ˆæœ¬éƒ½å¯ä»¥å¤„ç†ã€‚</li>
</ul>
<p><code>instantiateMainExecutable</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// create image for main executable</div><div class="line">ImageLoader* ImageLoaderMachO::instantiateMainExecutable(const macho_header* mh, uintptr_t slide, const char* path, const LinkContext&amp; context)</div><div class="line">&#123;</div><div class="line">	//dyld::log(&quot;ImageLoader=%ld, ImageLoaderMachO=%ld, ImageLoaderMachOClassic=%ld, ImageLoaderMachOCompressed=%ld\n&quot;,</div><div class="line">	//	sizeof(ImageLoader), sizeof(ImageLoaderMachO), sizeof(ImageLoaderMachOClassic), sizeof(ImageLoaderMachOCompressed));</div><div class="line">	bool compressed;</div><div class="line">	unsigned int segCount;</div><div class="line">	unsigned int libCount;</div><div class="line">	const linkedit_data_command* codeSigCmd;</div><div class="line">	const encryption_info_command* encryptCmd;</div><div class="line">//	åˆ¤æ–­mach-oæ–‡ä»¶æ˜¯å¦æ˜¯å‹ç¼©è¿‡</div><div class="line">	sniffLoadCommands(mh, path, false, &amp;compressed, &amp;segCount, &amp;libCount, context, &amp;codeSigCmd, &amp;encryptCmd);</div><div class="line">	// instantiate concrete class based on content of load commands</div><div class="line">//	é€šè¿‡æ˜¯å¦å‹ç¼©ï¼Œç”¨ä¸åŒçš„æ–¹æ³•æ¥å¤„ç†</div><div class="line">	if ( compressed )</div><div class="line">		return ImageLoaderMachOCompressed::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</div><div class="line">	else</div><div class="line">#if SUPPORT_CLASSIC_MACHO</div><div class="line">		return ImageLoaderMachOClassic::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</div><div class="line">#else</div><div class="line">		throw &quot;missing LC_DYLD_INFO load command&quot;;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆåˆ¤æ–­mach-oæ–‡ä»¶æ˜¯å¦å‹ç¼©è¿‡ï¼Œç„¶åå†ç”¨ä¸ç”¨çš„æ–¹å¼å¤„ç†æ­¤æ–‡ä»¶ã€‚ä¸¤ä¸ªæ–¹æ³•çš„å¤„ç†æ–¹å¼å¤§åŒå°å¼‚ï¼Œ<code>ImageLoaderMachOClassic::instantiateMainExecutable</code>æ–¹æ³•é‡Œåˆè°ƒç”¨äº†<code>ImageLoaderMachOClassic::instantiateStart</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// construct ImageLoaderMachOClassic using &quot;placement new&quot; with SegmentMachO objects array at end</div><div class="line">ImageLoaderMachOClassic* ImageLoaderMachOClassic::instantiateStart(const macho_header* mh, const char* path,</div><div class="line">																		unsigned int segCount, unsigned int libCount)</div><div class="line">&#123;</div><div class="line">	size_t size = sizeof(ImageLoaderMachOClassic) + segCount * sizeof(uint32_t) + libCount * sizeof(ImageLoader*);</div><div class="line">	ImageLoaderMachOClassic* allocatedSpace = static_cast&lt;ImageLoaderMachOClassic*&gt;(malloc(size));</div><div class="line">	if ( allocatedSpace == NULL )</div><div class="line">		throw &quot;malloc failed&quot;;</div><div class="line">	uint32_t* segOffsets = ((uint32_t*)(((uint8_t*)allocatedSpace) + sizeof(ImageLoaderMachOClassic)));</div><div class="line">	bzero(&amp;segOffsets[segCount], libCount*sizeof(void*));	// zero out lib array</div><div class="line">	return new (allocatedSpace) ImageLoaderMachOClassic(mh, path, segCount, segOffsets, libCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å†…ä¸»è¦æ˜¯ç”³è¯·å†…å­˜ï¼Œç„¶åè°ƒç”¨<code>ImageLoaderMachOClassic</code>æ–¹æ³•ï¼Œæ ¹æ®mach-oæ–‡ä»¶segmentsçš„è§„åˆ™å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ImageLoaderMachO::ImageLoaderMachO(const macho_header* mh, const char* path, unsigned int segCount, </div><div class="line">																uint32_t segOffsets[], unsigned int libCount)</div><div class="line"> : ImageLoader(path, libCount), fCoveredCodeLength(0), fMachOData((uint8_t*)mh), fLinkEditBase(NULL), fSlide(0),</div><div class="line">......</div><div class="line">&#123;</div><div class="line">	fIsSplitSeg = ((mh-&gt;flags &amp; MH_SPLIT_SEGS) != 0);        </div><div class="line"></div><div class="line">	// construct SegmentMachO object for each LC_SEGMENT cmd using &quot;placement new&quot; to put </div><div class="line">	// each SegmentMachO object in array at end of ImageLoaderMachO object</div><div class="line">	const uint32_t cmd_count = mh-&gt;ncmds;</div><div class="line">	const struct load_command* const cmds = (struct load_command*)&amp;fMachOData[sizeof(macho_header)];</div><div class="line">	const struct load_command* cmd = cmds;</div><div class="line">	for (uint32_t i = 0, segIndex=0; i &lt; cmd_count; ++i) &#123;</div><div class="line">		if ( cmd-&gt;cmd == LC_SEGMENT_COMMAND ) &#123;</div><div class="line">			const struct macho_segment_command* segCmd = (struct macho_segment_command*)cmd;</div><div class="line">			// ignore zero-sized segments</div><div class="line">			if ( segCmd-&gt;vmsize != 0 ) &#123;</div><div class="line">				// record offset of load command</div><div class="line">				segOffsets[segIndex++] = (uint32_t)((uint8_t*)segCmd - fMachOData);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		cmd = (const struct load_command*)(((char*)cmd)+cmd-&gt;cmdsize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œè¿™ä¸ªæ–¹æ³•å°±æ‰§è¡Œå®Œäº†ã€‚ç„¶åå°±æ˜¯æœ€å¼€å§‹çš„è°ƒç”¨<code>addimage</code>æ–¹æ³•ã€‚è¿™é‡Œæ¶‰åŠçš„æºä»£ç éå¸¸å¤šï¼Œæˆ‘åªæ˜¯ç²˜è´´äº†ä¸€éƒ¨åˆ†ã€‚</p>
<p>####Runtimeæ˜¯åœ¨å“ªä¸ªè¿‡ç¨‹ä¸­åˆå§‹åŒ–çš„ï¼Ÿ</p>
<p>ä»ä¸Šé¢çš„é‚£ä¸ª<code>_objc_init</code>è°ƒç”¨æ ˆå¯ä»¥çœ‹å‡ºï¼Œ<code>initializeMainExecutable</code>å†…ä¼šè¿›è¡ŒRuntimeçš„åˆå§‹åŒ–</p>
<ul>
<li>initializeMainExecutable()</li>
<li>ImageLoader::runInitializers()</li>
<li>â€¦</li>
<li>doModInitFunctions()</li>
<li>libdispatch_init</li>
<li>_os_object_init</li>
</ul>
<p>æœ€ç»ˆçš„ï¼Œåœ¨<code>_os_object_init</code>è¿™ä¸ªæ–¹æ³•å†…è°ƒç”¨äº†<code>_objc_init()</code>æ–¹æ³•ï¼ŒRuntime æ¥æ‰‹åè°ƒç”¨ï¼Œè°ƒç”¨map_images åšè§£æå’Œå¤„ç†ï¼ŒæŠŠ Category çš„å®ä¾‹æ–¹æ³•ã€åè®®ä»¥åŠå±æ€§æ·»åŠ åˆ°ç±»ä¸Šï¼ŒæŠŠ Category çš„ç±»æ–¹æ³•å’Œåè®®æ·»åŠ åˆ°ç±»çš„ metaclass ä¸Šï¼›æ¥ä¸‹æ¥ <code>load_images</code> ä¸­è°ƒç”¨ <code>call_load_methods</code> æ–¹æ³•ï¼Œéå†æ‰€æœ‰åŠ è½½è¿›æ¥çš„ Classï¼ŒæŒ‰ç»§æ‰¿å±‚çº§ä¾æ¬¡è°ƒç”¨ Class çš„ load æ–¹æ³•å’Œå…¶ Category çš„ load æ–¹æ³•ã€‚</p>
<p>æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»äº†dylbåŠ è½½mach-oæ–‡ä»¶çš„ç®€å•æµç¨‹ï¼Œå…·ä½“æ–¹æ³•å†…éƒ¨å¦‚ä½•åŠ è½½å¹¶æ²¡æœ‰è¿‡å¤šæ¢ç©¶ï¼Œæ¯”å¦‚ç¬¦å·ç»‘å®šï¼Œå»¶è¿ŸåŠ è½½ç­‰æ¯ä¸€ä¸ªçŸ¥è¯†ç‚¹éƒ½å¯ä»¥å†™ä¸€ç¯‡æ–‡ç« æ¥é˜è¿°ã€‚å¦‚æœ‰é”™è¯¯ï¼Œè¯·æŒ‡æ­£</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/19/å®¹å™¨ç±»å‹æ•°æ®é˜²Crashå¤„ç†/" itemprop="url">
                  å®¹å™¨ç±»å‹æ•°æ®é˜²Crashå¤„ç†
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-01-19T19:32:07+08:00" content="2018-01-19">
              2018-01-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/01/19/å®¹å™¨ç±»å‹æ•°æ®é˜²Crashå¤„ç†/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/01/19/å®¹å™¨ç±»å‹æ•°æ®é˜²Crashå¤„ç†/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/01/19/å®¹å™¨ç±»å‹æ•°æ®é˜²Crashå¤„ç†/" class="leancloud_visitors" data-flag-title="å®¹å™¨ç±»å‹æ•°æ®é˜²Crashå¤„ç†">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="å®¹å™¨ç±»å‹å¤„ç†"><a href="#å®¹å™¨ç±»å‹å¤„ç†" class="headerlink" title="å®¹å™¨ç±»å‹å¤„ç†"></a>å®¹å™¨ç±»å‹å¤„ç†</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨NSArrayæˆ–NSDictionary,å¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¾ˆå®¹æ˜“é€ æˆcrashæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NSArray *array = @[@1,@2,@3];</div><div class="line">array[3];</div><div class="line"></div><div class="line">id value = nil;</div><div class="line">NSDictionary *dic = @&#123;@&quot;key&quot;:value&#125;;</div></pre></td></tr></table></figure>
<p>æ•°ç»„è¶Šç•Œå’Œåˆå§‹åŒ–NSDictionaryæ—¶valueä¸ºnilï¼Œéƒ½ä¼šcrash.</p>
<p>é˜²æŠ¤æªæ–½å°±æ˜¯hookç³»ç»Ÿæ–¹æ³•ï¼Œåœ¨è‡ªå·±çš„æ–¹æ³•é‡Œå…ˆè¿›è¡Œåˆ¤æ–­ï¼Œç„¶åå†è°ƒç”¨ç³»ç»Ÿæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ZJSwizzleMethod(NSClassFromString(@&quot;__NSArrayI&quot;), @selector(objectAtIndex:), </div><div class="line">@selector(zj_objectAtIndex:));</div><div class="line"></div><div class="line">void ZJSwizzleMethod(Class c, SEL origSEL, SEL newSEL) &#123;</div><div class="line">    Method origMethod = class_getInstanceMethod(c, origSEL);</div><div class="line">    Method newMethod = nil;</div><div class="line">    if (!origMethod) &#123;</div><div class="line">        c = object_getClass(c);</div><div class="line">        return ZJSwizzleMethod(c, origSEL, newSEL);</div><div class="line">    &#125;else&#123;</div><div class="line">        newMethod = class_getInstanceMethod(c, newSEL);</div><div class="line">        if (!newMethod) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if(class_addMethod(c, origSEL, method_getImplementation(newMethod), </div><div class="line">    method_getTypeEncoding(newMethod)))&#123;</div><div class="line">            </div><div class="line">        class_replaceMethod(c, newSEL, method_getImplementation(origMethod),</div><div class="line">         method_getTypeEncoding(origMethod));</div><div class="line">    &#125;else&#123;</div><div class="line">            </div><div class="line">        method_exchangeImplementations(origMethod, newMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨äº¤æ¢çš„æ–¹æ³•é‡Œåˆ¤æ–­indexæ˜¯å¦å°äºæ•°ç»„ä¸ªæ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (id)zj_objectAtIndex:(NSUInteger)index &#123;</div><div class="line">    </div><div class="line">    if(index &gt;= self.count) &#123;</div><div class="line">        ZJSafeCollectionLog(@&quot;[%@ %@] index &#123;%zd&#125; beyond bounds [0...%zd]&quot;,NSStringFromClass([self class]),NSStringFromSelector(_cmd),index,MAX(self.count - 1, 0));</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    return [self zj_objectAtIndex:index];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœè¶Šç•Œï¼Œå°±åœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—ï¼Œä½†æ˜¯ä¸ä¼šCrash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">void ZJSafeCollectionLog(NSString*fmt,...) &#123;</div><div class="line">    if (ZJSafeCollectionLogEnabled)</div><div class="line">    &#123;</div><div class="line">        va_list ap;</div><div class="line">        va_start(ap, fmt);</div><div class="line">        NSString *content = [[NSString alloc] initWithFormat:fmt arguments:ap];</div><div class="line">        NSLog(@&quot;%@&quot;, content);</div><div class="line">        va_end(ap);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚åˆšæ‰çš„è¿™æ®µä»£ç ï¼Œè¾“å‡ºä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">NSArray *array = @[@1,@2,@3];</div><div class="line">array[3];</div><div class="line"></div><div class="line">[__NSArrayI objectAtIndexedSubscript:] index &#123;3&#125; beyond bounds [0...2]</div></pre></td></tr></table></figure>
<p>åŒæ ·çš„ï¼Œä¸ä»…ä»…æ˜¯NSArray,å¯¹NSMutableArrayï¼ŒNSDictionaryï¼ŒNSMutableDictionaryéƒ½hookäº†å¸¸ç”¨çš„æ–¹æ³•ï¼Œå…·ä½“è§<a href="https://github.com/coderZhou10496/ZJSafeCollectionDemo" target="_blank" rel="external">Githubåœ°å€</a></p>
<h3 id="unrecognized-selectorå¤„ç†"><a href="#unrecognized-selectorå¤„ç†" class="headerlink" title="unrecognized selectorå¤„ç†"></a>unrecognized selectorå¤„ç†</h3><p>è¿™ä¸ªå¼‚å¸¸æ˜¯æœªå®ç°ç›¸åº”çš„æ–¹æ³•ï¼Œè¿™ä¸ªCrashé˜²æŠ¤æªæ–½æ˜¯ä¹Ÿæ˜¯ç”¨Runtimeè¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚æ¶ˆæ¯è½¬å‘è¿‡ç¨‹ä¸ºï¼š</p>
<ul>
<li><ol>
<li>è°ƒç”¨resolveInstanceMethod:æ–¹æ³• (æˆ– resolveClassMethod:)ã€‚å…è®¸ç”¨æˆ·åœ¨æ­¤æ—¶ä¸ºè¯¥ Class åŠ¨æ€æ·»åŠ å®ç°ã€‚å¦‚æœæœ‰å®ç°äº†ï¼Œåˆ™è°ƒç”¨å¹¶è¿”å›YESï¼Œé‚£ä¹ˆé‡æ–°å¼€å§‹objc_msgSendæµç¨‹ã€‚è¿™ä¸€æ¬¡å¯¹è±¡ä¼šå“åº”è¿™ä¸ªé€‰æ‹©å™¨ï¼Œä¸€èˆ¬æ˜¯å› ä¸ºå®ƒå·²ç»è°ƒç”¨è¿‡class_addMethodã€‚å¦‚æœä»æ²¡å®ç°ï¼Œç»§ç»­ä¸‹é¢çš„åŠ¨ä½œã€‚</li>
</ol>
</li>
<li><ol>
<li>è°ƒç”¨forwardingTargetForSelector:æ–¹æ³•ï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªèƒ½å“åº”è¯¥æ¶ˆæ¯çš„å¯¹è±¡ã€‚å¦‚æœè·å–åˆ°ï¼Œåˆ™ç›´æ¥æŠŠæ¶ˆæ¯è½¬å‘ç»™å®ƒï¼Œè¿”å›é nil å¯¹è±¡ã€‚å¦åˆ™è¿”å› nil ï¼Œç»§ç»­ä¸‹é¢çš„åŠ¨ä½œã€‚æ³¨æ„ï¼Œè¿™é‡Œä¸è¦è¿”å› self ï¼Œå¦åˆ™ä¼šå½¢æˆæ­»å¾ªç¯ã€‚</li>
</ol>
</li>
<li><ol>
<li>è°ƒç”¨methodSignatureForSelector:æ–¹æ³•ï¼Œå°è¯•è·å¾—ä¸€ä¸ªæ–¹æ³•ç­¾åã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ç›´æ¥è°ƒç”¨doesNotRecognizeSelectoræŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœèƒ½è·å–ï¼Œåˆ™è¿”å›énilï¼šåˆ›å»ºä¸€ä¸ª NSlnvocation å¹¶ä¼ ç»™forwardInvocation:ã€‚åœ¨forwardInvocationé‡Œè¿›è¡Œè½¬å‘ã€‚</li>
</ol>
</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸‰ä¸ªè¿‡ç¨‹ä¸­è¿›è¡ŒåŠ¨æ€çš„æ·»åŠ æ–¹æ³•ï¼Œæˆ–å¯¹æœªå®ç°çš„æ–¹æ³•è¿›è¡Œè½¬å‘ã€‚</p>
<p>è¿™ç§Crashç±»å‹åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯å®ä¾‹æ–¹æ³•æœªå®ç°ï¼Œä¸€ç§æ˜¯ç±»æ–¹æ³•æœªå®ç°ã€‚å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼Œåœ¨è¿™ä¸‰æ­¥ä¸­ä»»ä½•ä¸€æ­¥è¿›è¡Œè¡¥æ•‘å°±è¡Œï¼Œä½†æ˜¯å¦‚æœæ˜¯ç±»æ–¹æ³•ï¼Œåªèƒ½åœ¨ç¬¬ä¸€æ­¥ä¸­åŠ¨æ€çš„æ·»åŠ æ–¹æ³•æ¥è¿›è¡Œé˜²æŠ¤ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªNSObjectçš„åˆ†ç±»ï¼Œé‡å†™ç³»ç»Ÿæ–¹æ³•ã€‚ä½†æ˜¯å¦‚æœç”¨åˆ†ç±»é‡å†™æ–¹æ³•çš„è¯ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¼šæ‹¦æˆªç³»ç»Ÿè‡ªå¸¦çš„æ–¹æ³•ï¼Œè€Œè¿™äº›æ˜¯ä¸éœ€è¦æˆ‘ä»¬å¤„ç†çš„ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å¤„ç†è‡ªå·±åˆ›å»ºçš„ç±»å°±è¡Œäº†ï¼Œæ¯”å¦‚å¯¹ç±»æ–¹æ³•è¿›è¡Œé˜²æŠ¤Crashï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">+ (BOOL)resolveClassMethod:(SEL)sel &#123;</div><div class="line">#warning &apos;ZJTestClass&apos; only test class</div><div class="line">    Class metaClass = object_getClass([ZJTestClass class]);</div><div class="line">    if([self isKindOfClass:[metaClass class]]) &#123;</div><div class="line">        class_addMethod(metaClass, sel, (IMP)remedyMethod, &quot;v@:&quot;);</div><div class="line">    &#125;</div><div class="line">    return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ZJTestClassä¸ºè‡ªå·±åˆ›å»ºçš„classï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥æ¢æˆBaseModelæˆ–è€…BaseController.å¦‚æœæ˜¯ç±»æ–¹æ³•æœªå®ç°ï¼Œå°±ä¼šè¿›å…¥<code>+ (BOOL)resolveClassMethod:(SEL)sel</code>æ–¹æ³•é‡Œã€‚å› ä¸ºæ˜¯ç±»æ–¹æ³•ï¼Œæ‰€ä»¥ä»£ç ä¸­çš„metaClassä¸ºå…ƒç±»ï¼Œå¦‚æœæ˜¯è‡ªå·±åˆ›å»ºçš„ç±»ï¼Œå°±ä¼šè¿›å…¥åˆ°ifè¯­å¥ä¸­ï¼Œä»è€ŒåŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚</p>
<p>å¯¹äºå®ä¾‹æ–¹æ³•Crashçš„é˜²æŠ¤ï¼Œæˆ‘æ˜¯åœ¨ç¬¬äºŒæ­¥è¿›è¡Œçš„ï¼Œå…·ä½“åŸå› åœ¨<a href="https://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&amp;mid=2651113088&amp;idx=1&amp;sn=10b28d7fbcdf0def1a47113e5505728d" target="_blank" rel="external">è¿™ç¯‡æ–‡ç« ä¸­</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1.resolveInstanceMethodéœ€è¦åœ¨ç±»çš„æœ¬èº«ä¸ŠåŠ¨æ€æ·»åŠ å®ƒæœ¬èº«ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯¹äºè¯¥ç±»æœ¬èº«æ¥è¯´å†—ä½™çš„</div><div class="line">2.forwardInvocationå¯ä»¥é€šè¿‡NSInvocationçš„å½¢å¼å°†æ¶ˆæ¯è½¬å‘ç»™å¤šä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å…¶å¼€é”€è¾ƒå¤§ï¼Œéœ€è¦</div><div class="line">åˆ›å»ºæ–°çš„NSInvocationå¯¹è±¡ï¼Œå¹¶ä¸”forwardInvocationçš„å‡½æ•°ç»å¸¸è¢«ä½¿ç”¨è€…è°ƒç”¨ï¼Œæ¥åšå¤šå±‚æ¶ˆæ¯è½¬å‘</div><div class="line">é€‰æ‹©æœºåˆ¶ï¼Œä¸é€‚åˆå¤šæ¬¡é‡å†™</div><div class="line">3.forwardingTargetForSelectorå¯ä»¥å°†æ¶ˆæ¯è½¬å‘ç»™ä¸€ä¸ªå¯¹è±¡ï¼Œå¼€é”€è¾ƒå°ï¼Œå¹¶ä¸”è¢«é‡å†™çš„æ¦‚ç‡è¾ƒä½ï¼Œé€‚åˆé‡å†™</div></pre></td></tr></table></figure>
<p>å…·ä½“ä»£ç ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">void remedyMethod (id self,SEL _cmd)</div><div class="line">&#123;</div><div class="line">    if(ZJForwardingLogEnabled) &#123;</div><div class="line">        Class cs = object_getClass(self);</div><div class="line">        NSLog(@&quot;[%@ %@] unrecognized selector&quot;,NSStringFromClass(cs),NSStringFromSelector(_cmd));</div><div class="line">    &#125;</div><div class="line">    return;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id)forwardingTargetForSelector:(SEL)aSelector &#123;</div><div class="line">#warning &apos;ZJTestClass&apos; only test class</div><div class="line">    if([self isKindOfClass:[UIResponder class]]|| [self isKindOfClass:[ZJTestClass class]] || [self isKindOfClass:[NSNull class]]) &#123;</div><div class="line">        Class ZJProtectorCls = NSClassFromString(@&quot;ZJProtector&quot;);</div><div class="line">        if(!ZJProtectorCls) &#123;</div><div class="line">            ZJProtectorCls = objc_allocateClassPair([NSObject class], &quot;ZJProtector&quot;, 0);</div><div class="line">            objc_registerClassPair(ZJProtectorCls);</div><div class="line">        &#125;</div><div class="line">        class_addMethod(ZJProtectorCls, aSelector, (IMP)remedyMethod, &quot;v@:&quot;);</div><div class="line"></div><div class="line">        Class ZJProtector = [ZJProtectorCls class];</div><div class="line">        id instance = [[ZJProtector alloc] init];</div><div class="line">        return instance;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŠ¨æ€çš„åˆ›å»ºäº†ä¸€ä¸ªç±»<code>ZJProtector</code>ï¼Œç„¶åå†å¯¹è¿™ä¸ªç±»æ·»åŠ æ–¹æ³•<code>class_addMethod</code>ã€‚</p>
<p>æœ€åæ¶ˆæ¯ä¼šè¿›å…¥åˆ°remedyMethodæ–¹æ³•é‡Œï¼Œæ–¹æ³•é‡Œæœ‰æ—¥å¿—è¾“å‡ºã€‚</p>
<h3 id="å¯¹NSNullçš„å¤„ç†"><a href="#å¯¹NSNullçš„å¤„ç†" class="headerlink" title="å¯¹NSNullçš„å¤„ç†"></a>å¯¹NSNullçš„å¤„ç†</h3><p>NSNullä¸nilä¸åŒï¼Œå¯¹nilå‘é€ä»»ä½•æ–¹æ³•éƒ½æ˜¯æ— æ•ˆçš„ï¼Œä¸ä¼šCrashï¼Œä½†æ˜¯NSNullå°±åƒå¹³å¸¸ä½¿ç”¨çš„ç±»ä¸€æ ·ï¼Œä¼šCrashã€‚GitHubä¸Šæœ‰ä¸€ä¸ª<a href="https://github.com/nicklockwood/NullSafe" target="_blank" rel="external">NullSafe</a>åº“ï¼Œæ˜¯ä¸“é—¨å¤„ç†è¿™ä¸ªé—®é¢˜çš„ã€‚ä¹Ÿæ˜¯ç”¨æ¶ˆæ¯è½¬å‘å¤„ç†çš„ã€‚å…¶ä¸­æœ‰æ®µä»£ç ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">//get class list </div><div class="line">int numClasses = objc_getClassList(NULL, 0);</div><div class="line">Class *classes = (Class *)malloc(sizeof(Class) * (unsigned long)numClasses);</div><div class="line">numClasses = objc_getClassList(classes, numClasses);</div><div class="line"></div><div class="line">//add to list for checking</div><div class="line">for (int i = 0; i &lt; numClasses; i++)</div><div class="line">&#123;</div><div class="line">    //determine if class has a superclass</div><div class="line">    Class someClass = classes[i];</div><div class="line">    Class superclass = class_getSuperclass(someClass);</div><div class="line">    while (superclass)</div><div class="line">    &#123;</div><div class="line">        if (superclass == [NSObject class])</div><div class="line">        &#123;</div><div class="line">            [classList addObject:someClass];</div><div class="line">            [classList removeObject:[someClass superclass]];</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        superclass = class_getSuperclass(superclass);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ„æ€æ˜¯è·å–é¡¹ç›®ä¸­æ‰€æœ‰çš„ç±»ï¼Œç„¶åéå†ï¼Œå¦‚æœæ˜¯NSObjectçš„å­ç±»ï¼Œå°±æ·»åŠ åˆ°NSMutableSeté‡Œã€‚æˆ‘æµ‹è¯•äº†ä¸‹ï¼Œå³ä½¿ä¸ºç©ºå·¥ç¨‹ï¼ŒnumClassesä¸º11970ï¼Œæ„æ€æ˜¯è¦éå†11970æ¬¡ï¼Œéå¸¸è€—æ—¶é—´ã€‚å¹¶ä¸”åœ¨è½¬å‘æ—¶ï¼Œè¿˜è¦éå†è¿™ä¸ªclassListï¼Œåˆ¤æ–­é‡Œé¢çš„ç±»æ˜¯å¦èƒ½å“åº”è°ƒç”¨çš„æ–¹æ³•ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªç±»èƒ½å“åº”ï¼Œå°±åœæ­¢éå†ã€‚æ¯”è¾ƒè€—æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘æ„Ÿè§‰è¿™æ ·åšä¸å¤ªåˆç†ã€‚æ‰€ä»¥æˆ‘åœ¨ä¸Šé¢çš„<code>forwardingTargetForSelector</code>é‡Œä¹Ÿæ·»åŠ äº†å¯¹NSNullçš„åˆ¤æ–­ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSNull *nul = [NSNull null];</div><div class="line">[nul performSelector:@selector(testMethod)];</div></pre></td></tr></table></figure>
<p>è¿™æ ·å†™ä¹Ÿä¸ä¼šCrash.ä½†æ˜¯å¦‚æœä»…ä»…æ˜¯ç”¨äº†NullSafeè¿™ä¸ªåº“ï¼Œæ˜¯å¤„ç†ä¸äº†çš„ï¼Œå› ä¸ºå®ƒä»…ä»…æ˜¯æŠŠæ¶ˆæ¯è½¬å‘ç»™å…¶ä»–ç±»ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ä¸€ä¸ªç±»èƒ½å“åº”è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¸€æ ·æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>å…·ä½“Demoï¼š<a href="https://github.com/coderZhou10496/ZJSafeCollectionDemo" target="_blank" rel="external">Github</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/04/UIView blockåŠ¨ç”»åŸç†åˆ†æ/" itemprop="url">
                  UIView blockåŠ¨ç”»åŸç†æµ…æ
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-01-04T18:05:52+08:00" content="2018-01-04">
              2018-01-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/01/04/UIView blockåŠ¨ç”»åŸç†åˆ†æ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/01/04/UIView blockåŠ¨ç”»åŸç†åˆ†æ/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/01/04/UIView blockåŠ¨ç”»åŸç†åˆ†æ/" class="leancloud_visitors" data-flag-title="UIView blockåŠ¨ç”»åŸç†æµ…æ">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>å½“æˆ‘ä»¬åœ¨Xcodeé‡Œå†™ä¸‹è¿™æ®µä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[UIView animateWithDuration:1 animations:^&#123;</div><div class="line">        view.center = CGPointMake(200, 200);</div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„viewå°±ä¼šè¿›è¡ŒåŠ¨ç”»ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©æ¥æ¢ç©¶ä¸¤ä¸ªé—®é¢˜</p>
<p> 1.è¿™è¡Œä»£ç å†™åœ¨blocké‡Œé¢è·Ÿå†™åœ¨å¤–é¢åˆ°åº•æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Œç³»ç»Ÿæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</p>
<p> 2.ç³»ç»Ÿæ˜¯æ€ä¹ˆçŸ¥é“ <code>view.center = CGPointMake(200, 200)</code> è¿™è¡Œä»£ç æ˜¯å†™åœ¨ UIView block ä¸­çš„ï¼Ÿ</p>
<h3 id="éšå¼åŠ¨ç”»"><a href="#éšå¼åŠ¨ç”»" class="headerlink" title="éšå¼åŠ¨ç”»"></a>éšå¼åŠ¨ç”»</h3><p>åŠ¨ç”»åˆ†ä¸ºéšå¼åŠ¨ç”»å’Œæ˜¾ç¤ºåŠ¨ç”»ï¼Œéšå¼åŠ¨ç”»å°±æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šä»»ä½•åŠ¨ç”»çš„ç±»å‹ï¼Œä»…ä»…æ˜¯æ”¹å˜äº†ä¸€ä¸ªå±æ€§ï¼Œæ²¡æœ‰åŠ åŠ¨ç”»ç‰¹æ•ˆï¼Œä½†å®ƒå´é»˜è®¤æœ‰åŠ¨ç”»æ•ˆæœã€‚åŒºåˆ†éšå¼åŠ¨ç”»å’Œæ˜¾ç¤ºåŠ¨ç”»æ˜¯ç”±ç”±CoreAnimationä¸­çš„CATransactionæ§åˆ¶çš„ã€‚å®˜æ–¹æ–‡æ¡£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Core Animation supports two types of transactions: implicit transactions </div><div class="line">and explicit transactions. Implicit transactions are created automatically</div><div class="line">when the layer tree is modified by a thread without an active transaction </div><div class="line">and are committed automatically when the thread&apos;s runloop next iterates. </div><div class="line">Explicit transactions occur when the the application sends the </div><div class="line">CATransaction class a begin message before modifying the layer tree, and a </div><div class="line">commit message afterwards.</div></pre></td></tr></table></figure>
<p>æ„æ€æ˜¯CoreAnimationæ”¯æŒä¸¤ç§äº‹åŠ¡ï¼Œæ˜¾å¼äº‹åŠ¡å’Œéšå¼äº‹åŠ¡ã€‚<br>æ˜¾å¼äº‹åŠ¡æ˜¯è°ƒç”¨[CATransaction begin]ï¼Œç„¶åæ˜¯[CATransaction commit]ã€‚å½“æ²¡æœ‰å®ç°è¿™äº›æ—¶CoreAnimationè‡ªåŠ¨åˆ›å»ºéšå¼äº‹åŠ¡ï¼Œå®ƒä»¬åœ¨çº¿ç¨‹çš„è¿è¡Œå¾ªç¯ä¸‹ä¸€æ¬¡è¿­ä»£æ—¶è‡ªåŠ¨æäº¤ã€‚</p>
<p>å¤§å®¶æŒ‰ä½cmdç‚¹è¿›CALayerçš„å¤´æ–‡ä»¶ä¸­çœ‹çš„è¯ï¼Œä¼šå‘ç°å¾ˆå¤šçš„å±æ€§çš„æ³¨é‡Šä¸­ï¼Œæœ€åä¼šæœ‰ä¸€ä¸ªè¯å«åšAnimatable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/** Geometry and layer hierarchy properties. **/</div><div class="line">/* The bounds of the layer. Defaults to CGRectZero. Animatable. */</div><div class="line"></div><div class="line">@property CGRect bounds;</div></pre></td></tr></table></figure>
<p>è¡¨ç¤ºç›´æ¥å¯¹layerçš„è¿™ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼ï¼Œä¼šäº§ç”Ÿéšå¼åŠ¨ç”»ã€‚</p>
<p>æ¯”å¦‚è¿™æ®µä»£ç ï¼Œç‚¹å‡»æŒ‰é’®æ”¹å˜åˆ›å»ºçš„layerçš„èƒŒæ™¯è‰²</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">self.layer = [CALayer layer];</div><div class="line">self.layer.frame = CGRectMake(130.0f, 200.0f, 100.0f, 100.0f);</div><div class="line">self.layer.backgroundColor = [UIColor blueColor].CGColor; </div><div class="line">[self.view.layer addSublayer:self.layer];</div><div class="line"></div><div class="line">- (IBAction)click:(UIButton *)sender &#123;</div><div class="line">    sender.selected = !sender.selected;</div><div class="line">    self.layer.backgroundColor = sender.selected ? [UIColor redColor].CGColor : [UIColor blueColor].CGColor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/AnimationColor1.gif" alt="image"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€æ¬¡æ”¹å˜é¢œè‰²éƒ½æœ‰é»˜è®¤çš„å¾ˆçŸ­çš„åŠ¨ç”»æ•ˆæœï¼Œè¿™ä¸ªåŠ¨ç”»å°±æ˜¯éšå¼åŠ¨ç”»ã€‚</p>
<p>ä½†æ˜¯å‡å¦‚æˆ‘ä»¬è¿™æ ·å†™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (IBAction)click:(UIButton *)sender &#123;</div><div class="line"></div><div class="line">	[CATransaction begin];</div><div class="line">	[CATransaction setAnimationDuration:1.0];</div><div class="line">    sender.selected = !sender.selected;</div><div class="line">    self.layer.backgroundColor = sender.selected ? [UIColor redColor].CGColor : [UIColor blueColor].CGColor;</div><div class="line">    [CATransaction commit];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/AnimationColor2.gif" alt="image"></p>
<p>è¿™æ ·å°±æ˜¯æ˜¾å¼åŠ¨ç”»ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°åŠ¨ç”»æ•ˆæœäº†ã€‚</p>
<p>åœ¨iOS 4ä¹‹å‰æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿›è¡ŒåŠ¨ç”»ï¼Œå®é™…ä¸Šåœ¨ <code>beginAnimations:context:</code> å’Œ <code>commitAnimations</code>ä¹‹é—´æ‰€æœ‰è§†å›¾æˆ–è€…å›¾å±‚å±æ€§çš„æ”¹å˜è€Œåšçš„åŠ¨ç”»éƒ½æ˜¯ç”±äºè®¾ç½®äº†CATransactionçš„åŸå› ,å¦å¤–BlockåŠ¨ç”»æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·ï¼ŒCATransaction çš„<code>begin</code> å’Œ <code>commit</code> ä¼šåœ¨blockå—ä¸­å†…éƒ¨è‡ªåŠ¨è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[UIView beginAnimations:@&quot;...&quot; context:nil];</div><div class="line">...</div><div class="line">...</div><div class="line">[UIView commitAnimations];</div></pre></td></tr></table></figure>
<h3 id="actionForLayer-forKey-æ–¹æ³•"><a href="#actionForLayer-forKey-æ–¹æ³•" class="headerlink" title="actionForLayer: forKey:æ–¹æ³•"></a>actionForLayer: forKey:æ–¹æ³•</h3><p>CALayeræœ‰ä¸ªå±æ€§delegateï¼Œåˆ›å»ºlayeræ—¶ï¼Œdelegateé»˜è®¤ä¸ºnilï¼ŒåŠ¨ç”»æ•ˆæœå°±æŒ‰é»˜è®¤çš„éšå¼åŠ¨ç”»å‘ˆç°ã€‚å¦‚æœå¯¹delegateèµ‹å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªdelegateå®ç°äº†delegateæ–¹æ³•ï¼Œé‚£ä¹ˆåŠ¨ç”»æ•ˆæœå°±ç”±delegateæ–¹æ³•æ§åˆ¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- (nullable id&lt;CAAction&gt;)actionForLayer:(CALayer *)layer forKey:(NSString *)event &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼åˆ†ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1.è¿”å›å®ç°äº†`&lt;CAAction&gt;`çš„å¯¹è±¡,å°±æŒ‰ç…§å¯¹è±¡çš„åŠ¨ç”»æ•ˆæœ</div><div class="line"></div><div class="line">2.è¿”å›nilï¼Œæ„æ€ç­‰åŒäºæ˜¯æ²¡æœ‰å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œéšå¼åŠ¨ç”»ã€‚</div><div class="line"></div><div class="line">3.è¿”å›NSNullå¯¹è±¡ï¼Œè¡¨ç¤ºç»“æŸï¼Œæ— éšå¼åŠ¨ç”»ã€‚</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä»€ä¹ˆæ—¶å€™è°ƒç”¨å‘¢ï¼Ÿæ˜¯å½“è¿™ä¸ªlayeræ˜¾ç¤ºã€ä¸æ˜¾ç¤ºã€å’Œå±æ€§æ”¹å˜çš„æ—¶å€™è°ƒç”¨ï¼Œå¹¶ä¸”ä»CALayerçš„å¤´æ–‡ä»¶å¯ä»¥çœ‹å‡ºæ˜¾ç¤ºå’Œä¸æ˜¾ç¤ºçš„eventå‚æ•°å€¼ä¸º <code>onOrderIn</code> å’Œ <code>onOrderOut</code>ï¼Œæ”¹å˜å±æ€§çš„æ—¶å€™å‚æ•°å€¼ä¸ºå±æ€§å€¼å­—ç¬¦ä¸²ã€‚</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/Animation_key.png" alt="image"></p>
<p>åˆå§‹åŒ–layerçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå½“å‰viewControllerä½œä¸ºdelegateï¼Œå®ç°ä¸€ä¸‹è¿™ä¸ªdelegateæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (nullable id&lt;CAAction&gt;)actionForLayer:(CALayer *)layer forKey:(NSString *)event &#123;</div><div class="line">	CABasicAnimation *ani = [[CABasicAnimation alloc] init];</div><div class="line">    ani.duration = 1.0;//è®¾ç½®åŠ¨ç”»æ—¶é—´ä¸º1ç§’é’Ÿ</div><div class="line">    return ani;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å› ä¸ºCAAnimationç›¸å…³çš„ç±»å·²ç»å®ç°äº†<code>&lt;CAAction&gt;</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›CABasicAnimationå¯¹è±¡ã€‚ä»ä¸‹é¢çš„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŒæ ·çš„æ•ˆæœ</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/AnimationColor2.gif" alt="image"></p>
<p>å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰å¯¹è±¡ï¼Œå®ç°<code>&lt;CAAction&gt;</code>åè®®ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ªUIViewéƒ½æœ‰ä¸€ä¸ªæ ¹Layerï¼ŒUIViewæ˜¯æ ¹Layerçš„delegeteã€‚æˆ‘ä»¬æ”¹å˜UIViewçš„å±æ€§æ²¡æœ‰äº§ç”ŸåŠ¨ç”»çš„åŸå› å°±æ˜¯è¿™ä¸ªæ–¹æ³•é»˜è®¤è¿”å›NSNullå¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»£ç éªŒè¯ä¸‹ï¼š</p>
<p>å°†è‡ªå®šä¹‰viewæ·»åŠ åˆ°UIViewControllerçš„viewä¸Šï¼Œç‚¹å‡»æŒ‰é’®æ”¹å˜èƒŒæ™¯è‰²</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MyCustomView *view = [[MyCustomView alloc] initWithFrame:CGRectMake(100, 300, 100, 100)];</div><div class="line">view.backgroundColor = [UIColor redColor];</div><div class="line">[self.view addSubview:view];</div><div class="line">self.customView = view;</div><div class="line"></div><div class="line">- (IBAction)click1:(UIButton *)sender &#123;</div><div class="line">   self.customView.backgroundColor = sender.selected ? [UIColor 			redColor] : [UIColor blueColor];</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>è‡ªå®šä¹‰UIView,é‡å†™è¿™ä¸ªdelegateæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@interface MyCustomView : UIView</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation MyCustomView</div><div class="line"></div><div class="line">- (nullable id&lt;CAAction&gt;)actionForLayer:(CALayer *)layer forKey:(NSString *)event &#123;</div><div class="line">    id value = [super actionForLayer:layer forKey:event];</div><div class="line">    NSLog(@&quot;value:%d&quot;,[value isKindOfClass:[NSNull class]]);</div><div class="line">    return value;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/Animation_value.png" alt="image"></p>
<p>ä»logä¸­å¯ä»¥çœ‹åˆ°è¿”å›çš„å¯¹è±¡å°±æ˜¯NSNullç±»å‹çš„å¯¹è±¡ï¼Œå³UIViewé»˜è®¤å…³é—­äº†æ ¹layerçš„éšå¼åŠ¨ç”»ã€‚</p>
<p>é‚£ä¹ˆå›åˆ°æˆ‘ä»¬æœ€å¼€å§‹æˆ‘ä»¬è®¨è®ºçš„è¿™ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶åœ¨UIView Blockä¸­æ”¹å˜viewçš„å±æ€§äº§ç”Ÿäº†åŠ¨ç”»ï¼Œé‚£å°±è¿™ä¸ªä»£ç†æ–¹æ³•å°±ä¸€å®šè¿”å›äº†ä¸€ä¸ªå®ç°<code>&lt;CAAction&gt;</code>çš„å¯¹è±¡ã€‚æˆ‘ä»¬é€šè¿‡ä»£ç éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;%@&quot;,[view.layer.delegate actionForLayer:view.layer </div><div class="line">forKey:@&quot;position&quot;]);</div><div class="line"></div><div class="line"> [UIView animateWithDuration:1 animations:^&#123;</div><div class="line">        view.center = CGPointMake(200, 200);</div><div class="line">        NSLog(@&quot;%@&quot;,[view.layer.delegate actionForLayer:view.layer forKey:@&quot;position&quot;]);</div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/Animation_resultpng.png" alt="image"><br>é€šè¿‡è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œåœ¨blockå¤–é¢ï¼Œè¿™ä¸ªæ–¹æ³•å°†è¿”å›ä¸€ä¸ªNSNullï¼Œåœ¨blocké‡Œé¢è¿”å›äº†ä¸€ä¸ªå«åšUIViewAdditiveAnimationActionç±»çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªç§æœ‰ç±»çš„ç±»åå°±å¯ä»¥çŒœåˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªå®ç°äº†<code>&lt;CAAction&gt;</code>çš„å¯¹è±¡ï¼Œå³ä¼šäº§ç”ŸåŠ¨ç”»ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š<br>æ¯ä¸ªUIViewå¯¹å®ƒå…³è”çš„å›¾å±‚éƒ½æ‰®æ¼”äº†ä¸€ä¸ªå§”æ‰˜ï¼Œå¹¶ä¸”æä¾›äº†actionForLayerï¼šforKeyï¼šçš„å®ç°æ–¹æ³•ã€‚å½“ä¸åœ¨ä¸€ä¸ªåŠ¨ç”»å—çš„ä¸­æ”¹å˜ç›¸åº”çš„å±æ€§å€¼ï¼ŒUIViewå¯¹æ‰€æœ‰å›¾å±‚è¡Œä¸ºè¿”å›NULLï¼Œè¿™æ—¶å€™ä¸ä¼šæœ‰åŠ¨ç”»æ•ˆæœäº§ç”Ÿï¼›åä¹‹ï¼Œå®ƒå°±è¿”å›ä¸€ä¸ªCAActionåè®®å¯¹åº”çš„å¯¹è±¡ï¼Œç„¶åè¿›è¡ŒåŠ¨ç”»å¤„ç†ã€‚</p>
<h3 id="ç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“çš„"><a href="#ç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“çš„" class="headerlink" title="ç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“çš„"></a>ç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“çš„</h3><p>ä½†æ˜¯ç³»ç»Ÿæ˜¯æ€ä¹ˆçŸ¥é“æˆ‘ä»¬æŠŠæ”¹å˜viewå±æ€§çš„è¿™è¡Œä»£ç å†™åœ¨äº†Blocké‡Œï¼Œç„¶åè¿›è¡ŒåŠ¨ç”»çš„å‘¢ï¼Ÿæ—¢æˆ‘ä»¬å¼€ç¯‡è®²åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>BlockåŠ¨ç”»å†™æ³•æ˜¯åœ¨ iOS 4.0 æå‡ºæ¥çš„ï¼Œåœ¨ iOS 4.0ä¹‹å‰ï¼Œæˆ‘ä»¬å†™åŠ¨ç”»çš„æ–¹å¼æ˜¯è¿™æ ·çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">UIView beginAnimations:@&quot;...&quot; context:nil];</div><div class="line">...</div><div class="line">...</div><div class="line">[UIView commitAnimations];</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªcontextæ˜¯ä¸€ä¸ªå…¨å±€çš„å‚æ•°ï¼Œå½“æˆ‘ä»¬åœ¨contextè¿™ä¸ªç¯å¢ƒä¸‹æ”¹å˜viewå±æ€§æ—¶ä¼šè¢«contextæ‰€è®°å½•ä¸‹æ¥ã€‚åœ¨ æ‰§è¡Œå®Œ<code>commitAnimations</code> åï¼Œç³»ç»Ÿæ£€æµ‹contextå†…çš„åŠ¨ç”»å†…å®¹ï¼Œç„¶åæ¸²æŸ“ç»˜åˆ¶è¿›è¡ŒåŠ¨ç”»ã€‚Blockå†™æ³•å…¶å®å°±æ˜¯å¯¹è¿™ç§å¤æ‚å†™æ³•çš„ä¸€ç§å°è£…ï¼Œå…¶æœ¬è´¨ä¹Ÿæ˜¯æœ‰å…¨å±€çš„ç³»ç»Ÿå˜é‡è¿›è¡Œç›‘æ§ï¼Œåªæ˜¯Blockæ›´ä¼˜é›…ï¼Œæ›´æ–¹ä¾¿ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/05/å…³äºAFURLSessionManagerçš„å‡ ç‚¹ç–‘é—®/" itemprop="url">
                  å…³äºAFURLSessionManagerçš„å‡ ç‚¹ç–‘é—®
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2017-12-05T19:16:30+08:00" content="2017-12-05">
              2017-12-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/12/05/å…³äºAFURLSessionManagerçš„å‡ ç‚¹ç–‘é—®/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/05/å…³äºAFURLSessionManagerçš„å‡ ç‚¹ç–‘é—®/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/12/05/å…³äºAFURLSessionManagerçš„å‡ ç‚¹ç–‘é—®/" class="leancloud_visitors" data-flag-title="å…³äºAFURLSessionManagerçš„å‡ ç‚¹ç–‘é—®">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>è¿™ä¸¤å¤©èŠ±äº†ç‚¹æ—¶é—´çœ‹äº†ä¸‹<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="external">AFNetworking</a>çš„æºç ï¼Œç‰¹åˆ«æ˜¯å¯¹äº <code>AFURLSessionManager</code> è¿™ä¸ªæ ¸å¿ƒç±»ç ”ç©¶çš„æ¯”è¾ƒå¤šï¼Œå…¶ä¸­æœ‰å‡ ä¸ªç–‘é—®ï¼Œæ‰€ä»¥å†™ç¯‡æ–‡ç« æ¥è®°å½•ä¸‹</p>
<h3 id="å…³äºAFURLSessionManagerçš„å†…å­˜æ³„éœ²"><a href="#å…³äºAFURLSessionManagerçš„å†…å­˜æ³„éœ²" class="headerlink" title="å…³äºAFURLSessionManagerçš„å†…å­˜æ³„éœ²"></a>å…³äºAFURLSessionManagerçš„å†…å­˜æ³„éœ²</h3><p>è¿™ä¸ªé—®é¢˜åœ¨<a href="https://github.com/AFNetworking/AFNetworking/issues" target="_blank" rel="external">issues</a>ä¸Šè¢«å¤šæ¬¡æåˆ°ï¼Œå°±æ˜¯è¯´ä»…ä»…æ˜¯å†™ä¸ªç®€å•çš„è¯·æ±‚ï¼Œä¹Ÿä¼šå‡ºç°å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc]init];</div><div class="line">[manager POST:urlStringparameters:paraDic progress:^(NSProgress * _Nonnull uploadProgress) &#123;</div><div class="line">        </div><div class="line">    &#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</div><div class="line">        </div><div class="line">    &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</div><div class="line">        </div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åœ¨ UIViewController å†™ä¸Šè¿™æ®µä»£ç ï¼Œå› ä¸º AFHTTPSessionManager ä¸æ˜¯å…¨å±€çš„ç±»ï¼Œä¸æ˜¯å•åˆ©ç±»ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œå½“é€€å‡ºå½“å‰ UIViewController æ—¶ï¼ŒAFHTTPSessionManager ç±»çš„ dealloc æ–¹æ³•åº”è¯¥æ‰§è¡Œï¼Œç„¶åäº‹å®ä¸Šå´æ²¡æœ‰ã€‚</p>
<p>ä½¿ç”¨Instrumentsåˆ†æä¸ºï¼š<br><img src="http://ocauxqtbu.bkt.clouddn.com/AFURLSessionManager01.png" alt="image"></p>
<p>æ„æ€å°±æ˜¯ AFURLSessionManager æŒæœ‰äº† NSURLSession å¯¹è±¡ï¼Œå¹¶ä¸” NSURLSession çš„delegate å¯¹è±¡ ä¸ºAFURLSessionManagerï¼Œé€ æˆäº†å¾ªç¯å¼•ç”¨ã€‚å…¶å®å°±æ˜¯è¿™è¡Œä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">self.session = [NSURLSession sessionWithConfiguration:self.sessionConfiguration </div><div class="line">delegate:self delegateQueue:self.operationQueue];</div></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹è‹¹æœå¼€å‘æ–‡æ¡£å¯¹äºè¿™ä¸ªæ–¹æ³•çš„æè¿°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">The session object keeps a strong reference to the delegate until your app</div><div class="line"> exits or explicitly invalidates the session. If you do not invalidate the </div><div class="line"> session by calling the invalidateAndCancel or finishTasksAndInvalidate </div><div class="line"> method, your app leaks memory until it exits.</div></pre></td></tr></table></figure>
<p>æœç„¶å¦‚æ­¤ï¼ŒNSURLSession å¯¹è±¡ä¼šå¼ºå¼•ç”¨ä¼ å…¥çš„ delegate å¯¹è±¡ç›´åˆ°APPé€€å‡ºæˆ–è€…æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•ä½¿ session å¤±æ•ˆï¼Œå¦åˆ™ä¼šå‡ºç°å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p>
<p>å…¶å®è§£å†³è¿™ä¸ªå†…å­˜æ³„éœ²çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿè¯´äº†ï¼Œæ‰‹åŠ¨ä½¿å…¶å¤±æ•ˆã€‚æˆ‘ä»¬åœ¨ block å›è°ƒé‡Œè°ƒç”¨ä¸€ä¸‹ <code>invalidateAndCancel</code> å°±è¡Œäº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[manager POST:urlString parameters:dic progress:^(NSProgress * _Nonnull uploadProgress) &#123;</div><div class="line"></div><div class="line">        </div><div class="line">        &#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</div><div class="line"></div><div class="line">            [manager.session invalidateAndCancel];</div><div class="line">        &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</div><div class="line">            [manager.session invalidateAndCancel];</div><div class="line">        &#125;];</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯ AFNetworking çš„ä½œè€…ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™ä¹ˆåšå‘¢ï¼Œè€Œæ˜¯ä»»å…¶å†…å­˜æ³„éœ²ï¼Ÿæˆ‘çŒœæµ‹å¯èƒ½æ˜¯å½“ä¸€ä¸ªç•Œé¢å­˜åœ¨å¤šä¸ªç½‘ç»œè¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ç”¨ manager å»è¯·æ±‚ï¼Œå‡å¦‚åœ¨ä¸€ä¸ªè¯·æ±‚å›è°ƒé‡Œè°ƒç”¨ <code>[manager.session invalidateAndCancel]</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä½¿å…¶ä»–çš„è¯·æ±‚ç»ˆæ­¢äº†ï¼Œæ•…è€Œå‘ç”Ÿé”™è¯¯ã€‚å¹¶ä¸”æˆ‘ä»¬åœ¨é¡µé¢ä¸‹æ‹‰åˆ·æ–°æ—¶ï¼Œç”±äº manager.session å·²å¤±æ•ˆï¼Œä¹Ÿä¼šå‡ºç°é”™è¯¯ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆåœ¨blockå›è°ƒé‡Œå¯ä»¥å†™-self-è®¿é—®å±æ€§"><a href="#ä¸ºä»€ä¹ˆåœ¨blockå›è°ƒé‡Œå¯ä»¥å†™-self-è®¿é—®å±æ€§" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨blockå›è°ƒé‡Œå¯ä»¥å†™ self. è®¿é—®å±æ€§"></a>ä¸ºä»€ä¹ˆåœ¨blockå›è°ƒé‡Œå¯ä»¥å†™ <code>self.</code> è®¿é—®å±æ€§</h3><p>æ¯”å¦‚è¿™æ ·å†™å½“å‰ UIViewController ä»èƒ½é‡Šæ”¾ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, strong)AFHTTPSessionManager *manager;</div><div class="line"></div><div class="line">self.manager = [[AFHTTPSessionManager alloc]init];</div><div class="line">[manager POST:urlString parameters:dic progress:^(NSProgress * _Nonnull uploadProgress) &#123;</div><div class="line">    &#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</div><div class="line"></div><div class="line">        self.XX = XX</div><div class="line">        </div><div class="line">    &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
<p>è¿™é‡ŒControllerå¯¹è±¡æ˜¯å¼ºå¼•ç”¨äº†managerï¼Œblockå¼ºå¼•ç”¨äº†Controllerï¼Œé‚£ä¹ˆmanagerå¼ºå¼•ç”¨äº†blockäº†å—ï¼Ÿè‚¯å®šæ˜¯æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹</p>
<p>AFHTTPSessionManager æœ‰ä¸ªå­—å…¸å±æ€§ï¼šmutableTaskDelegatesKeyedByTaskIdentifierï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (readwrite, nonatomic, strong) NSMutableDictionary *mutableTaskDelegatesKeyedByTaskIdentifier;</div></pre></td></tr></table></figure>
<p>å­—å…¸é‡Œé¢æ”¾çš„æ˜¯ï¼Œkeyæ˜¯NSURLSessionTaskçš„å”¯ä¸€æ ‡è¯†ï¼Œvalueæ˜¯AFURLSessionManagerTaskDelegateå¯¹è±¡ã€‚</p>
<p>AFURLSessionManagerTaskDelegateè¿™ä¸ªç±»å¼ºå¼•ç”¨äº† AFURLSessionManager å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, strong) AFURLSessionManager *manager;</div></pre></td></tr></table></figure>
<p>1.UIViewControllerå¯¹è±¡      æŒæœ‰    AFHTTPSessionManagerå¯¹è±¡</p>
<p>2.AFHTTPSessionManagerå¯¹è±¡  æŒæœ‰    å­—å…¸</p>
<p>3.å­—å…¸                          æŒæœ‰    AFâ€¦TaskDelegateå¯¹è±¡</p>
<p>4.AFâ€¦TaskDelegateå¯¹è±¡     æŒæœ‰    AFHTTPSessionManagerå¯¹è±¡(weak) </p>
<p>5.AFâ€¦TaskDelegateå¯¹è±¡     æŒæœ‰    completionHandler(å›è°ƒçš„block)</p>
<p>6.completionHandler        æŒæœ‰    UIViewControllerå¯¹è±¡</p>
<p>çœ‹ç€å¾ˆä¹±ï¼Œè¿˜æ˜¯çœ‹å›¾å§</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/AFURLSessionManager03.png" alt="image"></p>
<p>é‚£ä¹ˆAFNetworkingæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Œæ€ä¹ˆæ‰“ç ´è¿™ç§å¾ªç¯å¼•ç”¨å‘¢ã€‚</p>
<p>çœ‹ä¸‹è¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¯·æ±‚å®Œæˆåè°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">              task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(NSError *)error &#123;</div><div class="line"></div><div class="line"> [self removeDelegateForTask:task];</div><div class="line"> </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)removeDelegateForTask:(NSURLSessionTask *)task &#123;</div><div class="line">    NSParameterAssert(task);</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [self delegateForTask:task];</div><div class="line">    [self.lock lock];</div><div class="line">    [delegate cleanUpProgressForTask:task];</div><div class="line">    [self removeNotificationObserverForTask:task];</div><div class="line">    [self.mutableTaskDelegatesKeyedByTaskIdentifier removeObjectForKey:@(task.taskIdentifier)];</div><div class="line">    [self.lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªå›è°ƒæ–¹æ³•é‡Œï¼ŒæŠŠ AFURLSessionManagerTaskDelegate å¯¹è±¡ä»å­—å…¸ä¸­ç§»é™¤äº†ï¼Œå°±æ˜¯è¯´å­—å…¸ä¸å†æŒæœ‰ AFURLSessionManagerTaskDelegate å¯¹è±¡ï¼Œæ‰€ä»¥å°±ä¸å­˜åœ¨å¼ºå¼•ç”¨äº†é—®é¢˜äº†ã€‚</p>
<h3 id="å…³äºæ–‡ä»¶ä¸‹è½½çš„æ“ä½œ"><a href="#å…³äºæ–‡ä»¶ä¸‹è½½çš„æ“ä½œ" class="headerlink" title="å…³äºæ–‡ä»¶ä¸‹è½½çš„æ“ä½œ"></a>å…³äºæ–‡ä»¶ä¸‹è½½çš„æ“ä½œ</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>NSURLSessionDownloadDelegate</code> çš„è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">      downloadTask:(NSURLSessionDownloadTask *)downloadTask</div><div class="line">didFinishDownloadingToURL:(NSURL *)location</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [self delegateForTask:downloadTask];</div><div class="line">    if (self.downloadTaskDidFinishDownloading) &#123;</div><div class="line">        //è°ƒç”¨è‡ªå®šä¹‰çš„blockæ‹¿åˆ°æ–‡ä»¶å­˜å‚¨çš„åœ°å€</div><div class="line">        NSURL *fileURL = self.downloadTaskDidFinishDownloading(session, downloadTask, location);</div><div class="line">        if (fileURL) &#123;</div><div class="line">            delegate.downloadFileURL = fileURL;</div><div class="line">            NSError *error = nil;</div><div class="line">            //locationæ˜¯ä¸´æ—¶è·¯å¾„ï¼Œæˆ‘ä»¬æŠŠæ•°æ®ä»ä¸´æ—¶çš„ä¸‹è½½è·¯å¾„ç§»åŠ¨è‡³æˆ‘ä»¬éœ€è¦çš„è·¯å¾„</div><div class="line">            [[NSFileManager defaultManager] moveItemAtURL:location toURL:fileURL error:&amp;error];</div><div class="line">             //å¦‚æœå‡ºé”™</div><div class="line">            if (error) &#123;</div><div class="line">                [[NSNotificationCenter defaultCenter] postNotificationName:AFURLSessionDownloadTaskDidFailToMoveFileNotification object:downloadTask userInfo:error.userInfo];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">     //è½¬å‘ä»£ç†</div><div class="line">    if (delegate) &#123;</div><div class="line">        [delegate URLSession:session downloadTask:downloadTask didFinishDownloadingToURL:location];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æˆ‘ä¸‹è½½æ–‡ä»¶å®Œæˆçš„æ—¶å€™è°ƒç”¨ã€‚å¦‚æœè®¾ç½®äº† <code>downloadTaskDidFinishDownloadingBlock</code>ï¼Œå°±å»æ“ä½œæ•°æ®ï¼ŒæŠŠæ•°æ®ä»ä¸´æ—¶çš„ä¸‹è½½è·¯å¾„ç§»åŠ¨è‡³æˆ‘ä»¬éœ€è¦çš„è·¯å¾„ï¼Œç„¶å returnï¼Œæ„æ€å°±æ˜¯ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œã€‚</p>
<p>å¦‚æœæ²¡æœ‰è®¾ç½®blockï¼Œå°±æŠŠè¿™ä¸ªä»£ç†è½¬å‘åˆ° AFURLSessionManagerTaskDelegate è‡ªå®šä¹‰çš„ä»£ç†é‡Œé¢ã€‚åœ¨è‡ªå®šä¹‰ä»£ç†é‡Œåšäº†åŒæ ·çš„æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">      downloadTask:(NSURLSessionDownloadTask *)downloadTask</div><div class="line">didFinishDownloadingToURL:(NSURL *)location</div><div class="line">&#123;</div><div class="line">    NSError *fileManagerError = nil;</div><div class="line">    self.downloadFileURL = nil;</div><div class="line"></div><div class="line">    //AFä»£ç†çš„è‡ªå®šä¹‰Block</div><div class="line">    if (self.downloadTaskDidFinishDownloading) &#123;</div><div class="line">        //å¾—åˆ°è‡ªå®šä¹‰ä¸‹è½½è·¯å¾„</div><div class="line">        self.downloadFileURL = self.downloadTaskDidFinishDownloading(session, downloadTask, location);</div><div class="line">        if (self.downloadFileURL) &#123;</div><div class="line">            //æŠŠä¸‹è½½è·¯å¾„ç§»åŠ¨åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸‹è½½è·¯å¾„</div><div class="line">            [[NSFileManager defaultManager] moveItemAtURL:location toURL:self.downloadFileURL error:&amp;fileManagerError];</div><div class="line"></div><div class="line">            //é”™è¯¯å‘é€šçŸ¥</div><div class="line">            if (fileManagerError) &#123;</div><div class="line">                [[NSNotificationCenter defaultCenter] postNotificationName:AFURLSessionDownloadTaskDidFailToMoveFileNotification object:downloadTask userInfo:fileManagerError.userInfo];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å³ï¼šå¦‚æœè®¾ç½®äº† <code>downloadTaskDidFinishDownloadingBlock</code>ï¼Œå°±å»æ“ä½œæ•°æ®ï¼ŒæŠŠæ•°æ®ä»ä¸´æ—¶çš„ä¸‹è½½è·¯å¾„ç§»åŠ¨è‡³æˆ‘ä»¬éœ€è¦çš„è·¯å¾„ã€‚è¿™ä¸€æ­¥éª¤è·Ÿ<code>NSURLSessionDownloadDelegate</code> é‡Œçš„æ–¹æ³•å®Œå…¨ä¸€æ ·ã€‚å¹¶ä¸”ï¼Œå¦‚æœè®¾ç½®äº†blockï¼Œæ“ä½œæ–‡ä»¶åç›´æ¥returnäº†ï¼Œä¸ä¼šå†è½¬å‘ä»£ç†äº†ã€‚å¦‚æœæ²¡è®¾ç½®blockï¼Œè½¬å‘ä»£ç†åï¼Œåœ¨è‡ªå·±çš„ä»£ç†æ–¹æ³•é‡Œåˆåˆ¤æ–­äº†æ˜¯å¦è®¾ç½®äº†blockã€‚</p>
<p>è¿™ä¸ªè½¬å‘ä»£ç†çš„æ­¥éª¤çœ‹èµ·æ¥å¤šä½™äº†ï¼ŒAFçš„ä½œè€…ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œè®©æˆ‘ä¸å¾—è§£ï¼Œéš¾é“è¿˜æœ‰å…¶ä»–çš„ç”¨å¤„ï¼Ÿ</p>
<h3 id="å…¶ä»–çš„ä¸€äº›ç–‘é—®"><a href="#å…¶ä»–çš„ä¸€äº›ç–‘é—®" class="headerlink" title="å…¶ä»–çš„ä¸€äº›ç–‘é—®"></a>å…¶ä»–çš„ä¸€äº›ç–‘é—®</h3><p>1.å½“ AFURLSessionManagerTaskDelegate è¿™ä¸ªç±»æŠŠ AFURLSessionManager å¯¹è±¡ä½œä¸ºå±æ€§çš„æ—¶å€™ç”¨çš„æ˜¯ weak</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, weak) AFURLSessionManager *manager;</div></pre></td></tr></table></figure>
<p>åœ¨è‡ªå®šä¹‰çš„ä»£ç†æ–¹æ³•é‡Œï¼Œå› ä¸ºè¿™ä¸ªå±æ€§æ˜¯weakï¼Œæ‰€ä»¥è¿›è¡Œäº†ä¸‹é¢è¿™ä¸€æ­¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(__unused NSURLSession *)session</div><div class="line">              task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(NSError *)error</div><div class="line">&#123;</div><div class="line">	......</div><div class="line">    //å¼ºå¼•ç”¨self.managerï¼Œé˜²æ­¢è¢«æå‰é‡Šæ”¾ï¼›å› ä¸ºself.managerå£°æ˜ä¸ºweak</div><div class="line">    __strong AFURLSessionManager *manager = self.manager;</div><div class="line">    .......</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å…³äºè¿™ä¸ª weak å±æ€§ï¼Œæˆ‘çœ‹äº†ä¸‹ï¼Œå³ä½¿æ¢æˆ strong ä¹Ÿä¸ä¼šå‡ºç°å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œå› ä¸ºè¯·æ±‚å®Œæˆå AFURLSessionManager æŠŠ AFURLSessionManagerTaskDelegate å¯¹è±¡ä»å­—å…¸ä¸­ç§»é™¤äº†ã€‚å¹¶ä¸”åœ¨ä¸Šé¢çš„è¿™ä¸ªæ–¹æ³•é‡Œï¼Œä¹Ÿä¸ç”¨å¤šå»æ“ä½œä¸€æ­¥ã€‚æœ‰ç‚¹ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆç”¨weakã€‚</p>
<p>2.AFURLSessionManagerTaskDelegate è¿™ä¸ªç±»åœ¨å£°æ˜çš„æ—¶å€™åŒæ ·éµå¾ªäº† <code>NSURLSessionTaskDelegate, NSURLSessionDataDelegate, NSURLSessionDownloadDelegateåè®®</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@interface AFURLSessionManagerTaskDelegate : NSObject &lt;NSURLSessionTaskDelegate, </div><div class="line">NSURLSessionDataDelegate, </div><div class="line">NSURLSessionDownloadDelegate&gt;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸éµå¾ªåè®®ä¸€æ ·æ˜¯å¯ä»¥çš„ã€‚å¯èƒ½æ˜¯ä½œè€…ä¸ºäº†ä½¿è¿™ä¸ªç±»æ›´è§„èŒƒä¸€äº›ï¼Œæ›´åƒå®˜æ–¹æ–‡æ¡£é‚£æ ·ï¼Œæ‰€ä»¥è¿™æ ·å†™</p>
<p>3.åœ¨åˆ›å»º NSURLSession å¯¹è±¡æ—¶ï¼ŒæŒ‡å®šäº†å›è°ƒä»£ç†çš„queque</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">self.operationQueue.maxConcurrentOperationCount = 1;</div><div class="line">self.session = [NSURLSession sessionWithConfiguration:self.sessionConfiguration </div><div class="line">delegate:self delegateQueue:self.operationQueue];</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘æ³¨æ„åˆ°äº†ï¼Œè®¾ç½®äº†queueçš„æœ€å¤§operationå¹¶å‘ä¸ªæ•°ä¸º1ï¼Œå®ç°ä¼¼äºä¸²è¡Œé˜Ÿåˆ—çš„æ•ˆæœã€‚éš¾é“æ˜¯ä½œè€…ä¸ºäº†èŠ‚çœå†…å­˜èµ„æºè¿™æ ·åšçš„ï¼Œå› ä¸ºå³ä½¿è®¾ç½®äº†å¹¶å‘ä¸ªæ•°ä¸º1ï¼ŒNSOperationä¹Ÿæ˜¯å¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/12/ä¸€æ¬¡ç”±performSelectorå¼•å‘çš„BUG/" itemprop="url">
                  ä¸€æ¬¡ç”±performSelectorå¼•å‘çš„BUG
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2017-11-12T12:15:01+08:00" content="2017-11-12">
              2017-11-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/11/12/ä¸€æ¬¡ç”±performSelectorå¼•å‘çš„BUG/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/12/ä¸€æ¬¡ç”±performSelectorå¼•å‘çš„BUG/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/11/12/ä¸€æ¬¡ç”±performSelectorå¼•å‘çš„BUG/" class="leancloud_visitors" data-flag-title="ä¸€æ¬¡ç”±performSelectorå¼•å‘çš„BUG">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æˆ‘ä»¬çš„APPåœ¨æ‰“åŒ…åæµ‹è¯•è¿‡ç¨‹è¿‡å‘ç°ï¼Œæ‰€æœ‰çš„æŒ‰é’®ç‚¹å‡»æ•ˆæœä¸çµæ•äº†ï¼Œå°±æ˜¯æœ‰æ—¶å€™æŒ‰é’®ç‚¹å‡»ä¸€æ¬¡åå†ç‚¹å°±æ— æ•ˆäº†ï¼Œä¸ä¼šå“åº”ç”¨æˆ·çš„æ“ä½œã€‚è¿™ä¸ªbugæˆ‘è§‰å¾—éå¸¸ä¸å¯æ€è®®ï¼Œå¹¶ä¸”æˆ‘åœ¨æ¨¡æ‹Ÿå™¨ä¸Šï¼Œå³å¼€å‘ç¯å¢ƒä¸‹æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« å°±è¿™ä¸ªbugï¼Œæ¥è®°å½•ä¸€ä¸‹è§£å†³é—®é¢˜çš„è¿‡ç¨‹ã€‚</p>
<h3 id="æ‰¾åˆ°è§£å†³bugçš„åŸå› "><a href="#æ‰¾åˆ°è§£å†³bugçš„åŸå› " class="headerlink" title="æ‰¾åˆ°è§£å†³bugçš„åŸå› "></a>æ‰¾åˆ°è§£å†³bugçš„åŸå› </h3><p>åˆšæ‰è¯´äº†ï¼Œæ˜¯æ‰€æœ‰çš„æŒ‰é’®ï¼Œå¹¶ä¸”æ˜¯åœ¨ Release æ¨¡å¼ä¸‹ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚ç”±äºæ˜¯æ‰€æœ‰çš„æŒ‰é’®ï¼Œæ‰€ä»¥æƒ³åˆ°äº†æ˜¯å…¨å±€çš„è®¾ç½®ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä¸€è¡Œä»£ç å…¨å±€è®¾ç½®APPå†…çš„å¯¼èˆªæ æ•ˆæœç­‰ã€‚æˆ‘åœ¨æˆ‘ä»¬APPå·¥ç¨‹é‡Œæ‰¾äº†ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±æ˜¯ UIButton çš„åˆ†ç±»ï¼Œè¿™ä¸ªåˆ†ç±»çš„ä½œç”¨æ˜¯é˜²æ­¢æŒ‰é’®é‡å¤ç‚¹å‡»ï¼Œæ¯”å¦‚æ§åˆ¶APPå†…æ‰€æœ‰çš„æŒ‰é’®0.5ç§’å†…åªèƒ½ç‚¹å‡»ä¸€æ¬¡ï¼Œå¯æ˜¯è¿™ä¹Ÿä¸ä¼šå‡ºç°å¯¼è‡´ç‚¹å‡»ä¸€æ¬¡åå°±æ— æ³•ç‚¹å‡»çš„é—®é¢˜å•Šã€‚æˆ‘å¸¦ç€ç–‘é—®å»çœ‹è¿™ä¸ªåˆ†ç±»çš„æºç ï¼Œå¹¶ä¸”æˆ‘å•ç‹¬æŠŠè¿™ä¸ªåˆ†ç±»æ‹·è´å‡ºæ¥ï¼Œå¼€ä¸€ä¸ªDemoå·¥ç¨‹,ç„¶ååˆ†åˆ«åœ¨ Debugï¼ŒReleaseæ¨¡å¼ä¸‹è¿›è¡Œæµ‹è¯•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">+ (void)load &#123;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        SEL selA = @selector(sendAction:to:forEvent:);</div><div class="line">        SEL selB = @selector(zj_sendAction:to:forEvent:);</div><div class="line">        Method methodA =   class_getInstanceMethod(self,selA);</div><div class="line">        Method methodB = class_getInstanceMethod(self, selB);</div><div class="line">        BOOL isAdd = class_addMethod(self, selA, method_getImplementation(methodB), method_getTypeEncoding(methodB));</div><div class="line">        if (isAdd) &#123;</div><div class="line">            class_replaceMethod(self, selB, method_getImplementation(methodA), method_getTypeEncoding(methodA));</div><div class="line">        &#125;else&#123;</div><div class="line">            method_exchangeImplementations(methodA, methodB);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (void)zj_sendAction:(SEL)action to:(id)target forEvent:(UIEvent *)event &#123;</div><div class="line">    </div><div class="line">    if (self.zj_ignoreEvent)&#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    if (self.zj_timeInterval &gt; 0) &#123;</div><div class="line">        </div><div class="line">        self.zj_ignoreEvent = YES;</div><div class="line">        </div><div class="line">        </div><div class="line">        [self performSelector:@selector(setZj_ignoreEvent:) withObject:@(NO) afterDelay:self.zj_timeInterval];</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    [self zj_sendAction:action to:target forEvent:event];</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/buttonTest.jpg" alt=""></p>
<p>æˆ‘ä»¬åœ¨ load æ–¹æ³•é‡Œæ›¿æ¢ç³»ç»Ÿçš„ <code>sendAction:to:forEvent:</code>æ–¹æ³•ï¼Œæ”¹ä¸ºè‡ªå·±å®šä¹‰çš„ <code>zj_sendAction:to:forEvent:</code> æ–¹æ³•ã€‚åœ¨è‡ªå·±çš„æ–¹æ³•é‡Œå»ç”¨ç‚¹å‡»çš„é—´éš”æ—¶é—´æ¥æ§åˆ¶ï¼Œè¿™ä¸ªç‚¹å‡»æ˜¯å¦æœ‰æ•ˆã€‚æˆ‘åœ¨ Debug æ¨¡å¼ä¸‹è¯•äº†ï¼Œæ²¡é—®é¢˜ï¼Œå¯ä»¥åœ¨ Release æ¨¡å¼ç¡®å®ä¼šå‡ºç°ç‚¹å‡»ä¸€æ¬¡åå°±æ— æ³•ç‚¹å‡»çš„è¯¡å¼‚é—®é¢˜ã€‚æˆ‘ä»¬æ³¨æ„çœ‹è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (self.zj_ignoreEvent)&#123;</div><div class="line">        return;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ˜¯ç›´æ¥ä¸å“åº”ç”¨æˆ·çš„ç‚¹å‡»æ“ä½œï¼Œç›´æ¥è¿”å›ã€‚åªæœ‰ä¸‹ä¸€æ¬¡ç‚¹å‡»æ—¶é—´çš„é—´éš”ï¼Œå¤§äºæˆ‘ä»¬è®¾ç½®çš„ <code>zj_timeInterval</code>ï¼Œæ–¹æ³•æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚éš¾é“è¯´ï¼Œè¿™ä¸ªå±æ€§ <code>zj_zj_ignoreEvent</code> è¢«æ°¸ä¹…çš„è®¾ç½®ä¸ºäº†YESï¼Œæ°¸è¿œæ— æ³•ç»§ç»­æ‰§è¡Œï¼Ÿæˆ‘ä»¬é€šè¿‡æ‰“æ–­ç‚¹è°ƒè¯•å‘ç°ï¼Œäº‹å®ç¡®å®æ˜¯æˆ‘ä»¬è®¾æƒ³çš„é‚£æ ·ï¼Œç‚¹å‡»ä¸€æ¬¡ä¹‹åï¼Œè¿™ä¸ªå±æ€§ä¸€ç›´éƒ½ä¸ºYESã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå½“æ—¶é—´è¿‡äº†é—´éš”æ—¶é—´åï¼Œæˆ‘ä»¬ä¸æ˜¯ <code>performSelector</code> ä½¿è¿™ä¸ªå±æ€§è®¾ç½®ä¸º NO äº†å—</p>
<h3 id="è¯¡å¼‚çš„-performSelector-æ–¹æ³•"><a href="#è¯¡å¼‚çš„-performSelector-æ–¹æ³•" class="headerlink" title="è¯¡å¼‚çš„ performSelector æ–¹æ³•"></a>è¯¡å¼‚çš„ performSelector æ–¹æ³•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self performSelector:@selector(setZj_ignoreEvent:) withObject:@(NO) afterDelay:self.zj_timeInterval];</div></pre></td></tr></table></figure>
<p>ä¸ºæ­¤ï¼Œä¸“é—¨æµ‹è¯•äº†ä¸€ä¸‹ <code>performSelector: withObject:</code>æ–¹æ³•<br>æ¯”å¦‚æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å†™ä¸‹è¿™æ®µä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[self performSelector:@selector(test:) withObject:@(NO) afterDelay:1];</div><div class="line"></div><div class="line">-(void)test:(BOOL)boolTest &#123;</div><div class="line">    NSLog(@&quot;%d&quot;,boolTest);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå½“ Debug æ¨¡å¼ä¸‹ï¼ŒboolTestçš„å€¼ç¡®å®ä¸º0ï¼Œä½†æ˜¯ Release æ¨¡å¼ä¸‹å´ä¸º2ï¼Œä¸ä¸º0ï¼Œæ— è®ºåŠ ä¸åŠ å»¶è¿ŸåŠ è½½ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚éš¾é“ <code>performSelector</code> åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œå’Œç”Ÿäº§ç¯å¢ƒä¸‹å¯¹æ•°æ®çš„å¤„ç†å®Œå…¨ä¸ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œå°±æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´é¡¹ç›®ä¸­<code>zj_zj_ignoreEvent</code> è¢«æ°¸ä¹…çš„è®¾ç½®ä¸ºäº†YESï¼ŒæŒ‰é’®æ— æ³•æ­£å¸¸å“åº”ç”¨æˆ·ç‚¹å‡»æ“ä½œã€‚</p>
<p>æˆ‘ä»¬å»ç¿»äº†ä¸‹Runtimeçš„æºç ï¼Œé‡Œé¢å¯¹è¿™ä¸ªæ–¹æ³•çš„å†…éƒ¨å®ç°ä¹Ÿæ²¡æœ‰è¿‡å¤šçš„è§£é‡Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (id)performSelector:(SEL)sel &#123;</div><div class="line">    if (!sel) [self doesNotRecognizeSelector:sel];</div><div class="line">    return ((id(*)(id, SEL))objc_msgSend)(self, sel);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»…ä»…æ˜¯è°ƒç”¨ <code>objc_msgSend</code>ï¼Œè€Œ <code>objc_msgSend</code>å†…éƒ¨æ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼ŒæŸ¥é˜…èµ·æ¥æ¯”è¾ƒå›°éš¾ã€‚<br>æˆ‘ç°åœ¨çš„è§£å†³åŠæ³•æ˜¯ï¼Œä¸æ˜¯ç”¨è¿™ä¸ª <code>performSelector</code> æ–¹æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨ GCD å»¶è¿ŸåŠ è½½çš„æ–¹å¼æ¥å®ç°åŠŸèƒ½ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(self.zj_timeInterval * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">            self.zj_ignoreEvent = NO;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>å°†åŸæ¥é¡¹ç›®ä¸­çš„å»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œæ¢æˆè¿™ç§å°±OKäº†ã€‚</p>
<p>éœ€è¦é¢å¤–æä¸€ä¸‹ï¼Œæˆ‘åœ¨ç½‘ä¸Šæœé˜²æ­¢buttoné‡å¤ç‚¹å‡»çš„å¼€æºä»£ç ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨<code>performSelector</code> æ¥å»¶è¿Ÿè®¾ç½®å±æ€§ï¼Œä»¥æ­¤å‘Šè¯«å¤§å®¶ï¼Œä¸èƒ½ä¸€å‘³çš„æ‹·è´åˆ«äººçš„ä»£ç ï¼Œæˆ‘åœ¨è¿™é‡Œå°±åƒäº†ä¸€ä¸ªäºï¼Œè™½ç„¶çŸ¥é“äº†å®ç°åŸç†ï¼Œå´åœ¨å®ç°æ–¹æ³•ä¸Šå‡ºäº†é”™ï¼Œè¿˜æ˜¯è¦å¤šçœ‹çœ‹ä»£ç ï¼Œæ£€æŸ¥ä¸€ä¸‹ä»£ç çš„æ­£ç¡®æ€§ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/04/APPçš„å¯åŠ¨ç®€å•ä¼˜åŒ–/" itemprop="url">
                  APPçš„å¯åŠ¨ç®€å•ä¼˜åŒ–
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2017-11-04T18:33:28+08:00" content="2017-11-04">
              2017-11-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/åˆ†ç±»/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/11/04/APPçš„å¯åŠ¨ç®€å•ä¼˜åŒ–/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/04/APPçš„å¯åŠ¨ç®€å•ä¼˜åŒ–/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/11/04/APPçš„å¯åŠ¨ç®€å•ä¼˜åŒ–/" class="leancloud_visitors" data-flag-title="APPçš„å¯åŠ¨ç®€å•ä¼˜åŒ–">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>APPçš„å¯åŠ¨æ˜¯æŒ‡ä»ç”¨æˆ·ç‚¹å‡» APP é‚£ä¸€åˆ»å¼€å§‹åˆ°ç”¨æˆ·çœ‹åˆ°ç¬¬ä¸€ä¸ªç•Œé¢çš„æ•´ä¸ªè¿‡ç¨‹</p>
<h3 id="ä¸€ã€APPçš„å¯åŠ¨è¿‡ç¨‹"><a href="#ä¸€ã€APPçš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="ä¸€ã€APPçš„å¯åŠ¨è¿‡ç¨‹"></a>ä¸€ã€APPçš„å¯åŠ¨è¿‡ç¨‹</h3><h4 id="1-å¯åŠ¨è¿‡ç¨‹"><a href="#1-å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="1.å¯åŠ¨è¿‡ç¨‹"></a>1.å¯åŠ¨è¿‡ç¨‹</h4><p>ç®€å•çš„æ¥è¯´å°±æ˜¯ App è¿›è¡Œç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥ã€ä»£ç ç­¾åä»¥åŠå¯åŠ¨æ‰§è¡Œç­‰æ“ä½œ</p>
<h5 id="1-1-è§£æInfo-plist"><a href="#1-1-è§£æInfo-plist" class="headerlink" title="1.1 è§£æInfo.plist"></a>1.1 è§£æInfo.plist</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.åŠ è½½ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚å¦‚é—ªå±</div><div class="line"></div><div class="line">2.æ²™ç®±å»ºç«‹ã€æƒé™æ£€æŸ¥</div></pre></td></tr></table></figure>
<h5 id="1-2-Mach-OåŠ è½½"><a href="#1-2-Mach-OåŠ è½½" class="headerlink" title="1.2 Mach-OåŠ è½½"></a>1.2 Mach-OåŠ è½½</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">1.å¦‚æœæ˜¯èƒ–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯»æ‰¾åˆé€‚å½“å‰CPUç±»åˆ«çš„éƒ¨åˆ†</div><div class="line"></div><div class="line"> (ç”±äºéœ€è¦æ”¯æŒä¸åŒCPUæ¶æ„çš„iOSè®¾å¤‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¼–è¯‘æ‰“åŒ…å‡ºæ¥çš„æ‰§è¡Œæ–‡ä»¶æ˜¯ä¸€ä¸ªUniversal Binaryæ ¼å¼æ–‡ä»¶ï¼Œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿç§°èƒ–äºŒè¿›åˆ¶æ–‡ä»¶)</div><div class="line"> </div><div class="line">2.åŠ è½½æ‰€æœ‰ä¾èµ–çš„Mach-Oæ–‡ä»¶ï¼ˆé€’å½’è°ƒç”¨Mach-OåŠ è½½çš„æ–¹æ³•ï¼‰</div><div class="line"></div><div class="line">3.å®šä½å†…éƒ¨ã€å¤–éƒ¨æŒ‡é’ˆå¼•ç”¨ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€å‡½æ•°ç­‰</div><div class="line"></div><div class="line">4.æ‰§è¡Œå£°æ˜ä¸º__attribute__((constructor))çš„Cå‡½æ•°</div><div class="line"></div><div class="line">5.åŠ è½½ç±»æ‰©å±•ï¼ˆCategoryï¼‰ä¸­çš„æ–¹æ³•</div><div class="line"></div><div class="line">6.C++é™æ€å¯¹è±¡åŠ è½½ã€è°ƒç”¨ObjCçš„ +load å‡½æ•°</div><div class="line"></div><div class="line">å…³äºMach-Oæ–‡ä»¶çš„æ ¼å¼ä»¥åŠè¯¦ç»†çš„åŠ è½½è¿‡ç¨‹ï¼Œå¯çœ‹[è¿™ç¯‡æ–‡ç« ](http://www.jianshu.com/p/54d842db3f69)</div></pre></td></tr></table></figure>
<h5 id="1-3-ç¨‹åºæ‰§è¡Œ"><a href="#1-3-ç¨‹åºæ‰§è¡Œ" class="headerlink" title="1.3 ç¨‹åºæ‰§è¡Œ"></a>1.3 ç¨‹åºæ‰§è¡Œ</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">1.mainå‡½æ•°</div><div class="line"></div><div class="line">2.æ‰§è¡Œ UIApplicationMain å‡½æ•°</div><div class="line"></div><div class="line">3.åˆ›å»º UIApplication å¯¹è±¡</div><div class="line"></div><div class="line">4.åˆ›å»ºUIApplicationDelegateå¯¹è±¡</div><div class="line"></div><div class="line">5.è¯»å–é…ç½®æ–‡ä»¶info.plistï¼Œè®¾ç½®ç¨‹åºå¯åŠ¨çš„ä¸€äº›å±æ€§</div><div class="line"></div><div class="line">6.åˆ›å»ºåº”ç”¨ç¨‹åºçš„Main Runloopå¾ªç¯</div><div class="line"></div><div class="line">7.UIApplicationDelegateå¯¹è±¡å¼€å§‹å¤„ç†ç›‘å¬å¯¹è±¡</div><div class="line"></div><div class="line">8.è°ƒç”¨didFinishLaunchingWithOptionsæ–¹æ³•</div><div class="line"></div><div class="line">9.å¦‚æœinfo.plistä¸­é…ç½®äº†å¯åŠ¨çš„storyBoardçš„æ–‡ä»¶åï¼ŒåŠ è½½storyboardæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºUIWindow â€”&gt; rootViewController æ˜¾ç¤º</div></pre></td></tr></table></figure>
<h3 id="äºŒã€å¯åŠ¨æ—¶é—´çš„è®¡ç®—"><a href="#äºŒã€å¯åŠ¨æ—¶é—´çš„è®¡ç®—" class="headerlink" title="äºŒã€å¯åŠ¨æ—¶é—´çš„è®¡ç®—"></a>äºŒã€å¯åŠ¨æ—¶é—´çš„è®¡ç®—</h3><h4 id="2-1-main-å‡½æ•°ä¹‹å‰"><a href="#2-1-main-å‡½æ•°ä¹‹å‰" class="headerlink" title="2.1 main()å‡½æ•°ä¹‹å‰"></a>2.1 main()å‡½æ•°ä¹‹å‰</h4><p>è‹¹æœå·²ç»ç»™å‡ºäº†æ–¹æ³•æ¥å¸®æˆ‘ä»¬è®¡ç®—è¿™éƒ¨åˆ†çš„å¯åŠ¨æ—¶é—´ï¼š<br>åœ¨Xcodeçš„èœå•ä¸­é€‰æ‹©<code>Project</code> â†’ <code>Schemeâ†’Edit Scheme</code>ï¼Œç„¶åæ‰¾åˆ° <code>Run</code> â†’  <code>Environment Variables</code>ï¼Œæ·»åŠ nameä¸º <code>DYLD_PRINT_STATISTICS</code> ä¸º1çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åè¿è¡ŒAPPï¼Œä¼šåœ¨æ§åˆ¶å°æœ‰ä¸€ä¸ªè¾“å‡ºã€‚ä¾‹å¦‚ï¼Œæˆ‘åœ¨ä¹‹å‰çš„ä¸€ä¸ªé¡¹ç›®ä¸­åŠ å…¥ä»¥ä¸Šè®¾ç½®åï¼š</p>
<p><img src="http://ocauxqtbu.bkt.clouddn.com/blog_runTime.png" alt=""></p>
<p>1.main()å‡½æ•°ä¹‹å‰æ€»å…±ä½¿ç”¨äº†401.01ms</p>
<p>2.åœ¨401.01msä¸­ï¼ŒåŠ è½½åŠ¨æ€åº“ç”¨äº†112.08msï¼ŒæŒ‡é’ˆé‡å®šä½ä½¿ç”¨äº†161.83msï¼ŒObjCç±»åˆå§‹åŒ–ä½¿ç”¨äº†71.04msï¼Œå„ç§åˆå§‹åŒ–ä½¿ç”¨äº†55.93msã€‚</p>
<p>3.åœ¨åˆå§‹åŒ–è€—è´¹çš„55.93msä¸­ï¼Œç”¨æ—¶æœ€å¤šçš„ä¸‰ä¸ªåˆå§‹åŒ–æ˜¯libSystem.B.dylibã€libMainThreadChecker.dylibä»¥åŠXiaoBanBattery(è‡ªå·±çš„é¡¹ç›®åç§°)ã€‚</p>
<h4 id="2-2-main-å‡½æ•°ä¹‹å"><a href="#2-2-main-å‡½æ•°ä¹‹å" class="headerlink" title="2.2 main()å‡½æ•°ä¹‹å"></a>2.2 main()å‡½æ•°ä¹‹å</h4><p>ä»main()å‡½æ•°å¼€å§‹è‡³applicationWillFinishLaunchingç»“æŸï¼Œå†åˆ°å®Œæˆæ•°æ®çš„åŠ è½½å¹¶å±•ç¤ºç›¸å…³ä¿¡æ¯ç»™ç”¨æˆ·ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è‡ªå·±åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ’å…¥ä»£ç ï¼Œä»è€Œè·å¾—è¿™æ®µæ—¶é—´ã€‚æ¯”å¦‚åœ¨didFinishLaunchingWithOptionsè·å–ä¸€ä¸‹æ—¶é—´ï¼Œå†åœ¨ç¬¬ä¸€ä¸ªä¸»ç•Œé¢viewDidAppearè·å–ä¸€ä¸‹æ—¶é—´ï¼Œç®—å‡ºæ—¶é—´å·®ã€‚</p>
<h3 id="ä¸‰ã€å¯åŠ¨æ—¶é—´çš„ä¼˜åŒ–"><a href="#ä¸‰ã€å¯åŠ¨æ—¶é—´çš„ä¼˜åŒ–" class="headerlink" title="ä¸‰ã€å¯åŠ¨æ—¶é—´çš„ä¼˜åŒ–"></a>ä¸‰ã€å¯åŠ¨æ—¶é—´çš„ä¼˜åŒ–</h3><p>ä¸€ä¸ªAppå®Œæ•´çš„å¯åŠ¨æ—¶é—´åº”è¯¥ä¿è¯400msä¹‹å†…,è€Œè‹¥è¶…è¿‡20såè¿˜æœªå®Œå…¨å¯åŠ¨App,é‚£ä¹ˆAppè¿›ç¨‹å°±ä¼šè¢«ç³»ç»Ÿæ€æ­»ã€‚é‚£ä¹ˆå¦‚ä½•æ¥æå‡å¯åŠ¨é€Ÿåº¦å‘¢ï¼Ÿ</p>
<h4 id="1-ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„åŠ¨æ€åº“"><a href="#1-ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„åŠ¨æ€åº“" class="headerlink" title="1. ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„åŠ¨æ€åº“"></a>1. ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„åŠ¨æ€åº“</h4><p>æ¯ä¸ªAppéƒ½è¿›è¡ŒåŠ¨æ€åº“åŠ è½½,å…¶ä¸­ç³»ç»Ÿçº§åˆ«çš„åŠ¨æ€åº“å æ®äº†ç»å¤§æ•°,è€Œé’ˆå¯¹ç³»ç»Ÿçº§åˆ«çš„åŠ¨æ€åº“éƒ½æ˜¯ç»è¿‡ç³»ç»Ÿé«˜åº¦ä¼˜åŒ–çš„,ä¸ç”¨æ‹…å¿ƒæ—¶é—´çš„èŠ±è´¹.æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å…³æ³¨äºè‡ªå·±é›†æˆåˆ°Appçš„é‚£äº›åŠ¨æ€åº“,æœ‰äº›åº“é›†æˆè¿›æ¥äº†ï¼Œä½†æ˜¯æ²¡åœ¨ä»£ç ä¸­ç”¨åˆ°ï¼Œä¸€æ ·ä¼šéœ€è¦æ—¶é—´æ¥åŠ è½½å®ƒã€‚æ‰€ä»¥ç§»é™¤ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„åŠ¨æ€åº“æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p>
<h4 id="2-ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„ç±»"><a href="#2-ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„ç±»" class="headerlink" title="2. ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„ç±»"></a>2. ç§»é™¤ä¸éœ€è¦ç”¨åˆ°çš„ç±»</h4><p>æ—¥å¸¸ä»£ç çš„ç»´æŠ¤éå¸¸é‡è¦ï¼Œå¦‚æœä¸€ä¸ªä¸šåŠ¡å»æ‰äº†ï¼Œå°±åº”è¯¥åœ¨å½“æ—¶åˆ æ‰ç›¸å…³çš„ä»£ç ï¼Œå¦åˆ™çš„è¯æ— ç”¨çš„ä»£ç å°±ä¼šè¶Šæ¥è¶Šå¤šã€‚æ—¥åï¼Œå†å»æ‰¾è¿™äº›æ— ç”¨çš„ä»£ç ï¼Œåº”è¯¥æ²¡é‚£ä¹ˆæ–¹ä¾¿äº†ã€‚</p>
<h4 id="3-åˆå¹¶åŠŸèƒ½ç±»ä¼¼çš„ç±»å’Œåˆ†ç±»"><a href="#3-åˆå¹¶åŠŸèƒ½ç±»ä¼¼çš„ç±»å’Œåˆ†ç±»" class="headerlink" title="3. åˆå¹¶åŠŸèƒ½ç±»ä¼¼çš„ç±»å’Œåˆ†ç±»"></a>3. åˆå¹¶åŠŸèƒ½ç±»ä¼¼çš„ç±»å’Œåˆ†ç±»</h4><p>è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åŠ å¿«ç¨‹åºçš„æ•´ä¸ªåŠ¨æ€é“¾æ¥, åœ¨è¿›è¡ŒåŠ¨æ€åº“çš„é‡å®šä½å’Œç»‘å®šè¿‡ç¨‹ä¸­å‡å°‘æŒ‡é’ˆä¿®æ­£çš„ä½¿ç”¨,åŠ å¿«ç¨‹åºæœºå™¨ç çš„ç”Ÿæˆã€‚æ‰€ä»¥è¦åˆå¹¶ä¸€äº›åœ¨å·¥ç¨‹ã€æ¶æ„ä¸Šæ²¡æœ‰å¤ªå¤§æ„ä¹‰çš„ç±»å’Œåˆ†ç±»ã€‚</p>
<h4 id="4-ä½¿ç”¨initializeæ–¹æ³•è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–å·¥ä½œ"><a href="#4-ä½¿ç”¨initializeæ–¹æ³•è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="4. ä½¿ç”¨initializeæ–¹æ³•è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–å·¥ä½œ"></a>4. ä½¿ç”¨initializeæ–¹æ³•è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–å·¥ä½œ</h4><p>å¦‚æœä¸æ˜¯éå¿…é¡»çš„ï¼Œæˆ‘ä»¬è¦ç”¨+initializeæ–¹æ³•æ›¿æ¢è°ƒç”¨åŸå…ˆåœ¨OCçš„+loadæ–¹æ³•ä¸­æ‰§è¡Œåˆå§‹ä»£ç å·¥ä½œ,ä»è€ŒåŠ å¿«æ‰€æœ‰ç±»æ–‡ä»¶çš„åŠ è½½é€Ÿåº¦ã€‚</p>
<h4 id="5-å‹ç¼©èµ„æºå›¾ç‰‡"><a href="#5-å‹ç¼©èµ„æºå›¾ç‰‡" class="headerlink" title="5. å‹ç¼©èµ„æºå›¾ç‰‡"></a>5. å‹ç¼©èµ„æºå›¾ç‰‡</h4><p>å¯åŠ¨çš„æ—¶å€™åŠ è½½å›¾ç‰‡ï¼Œå›¾ç‰‡å°äº†ï¼ŒIOæ“ä½œé‡å°±å°äº†ï¼Œå¯åŠ¨å½“ç„¶å°±ä¼šå¿«äº†ï¼Œä½†æ˜¯è¿˜æ˜¯è¦ä»¥å›¾ç‰‡çš„è´¨é‡ï¼Œæ¸…æ™°åº¦ä¸ºå‰æä¸‹ã€‚</p>
<h4 id="6-ä¼˜åŒ–rootViewControlleråŠ è½½"><a href="#6-ä¼˜åŒ–rootViewControlleråŠ è½½" class="headerlink" title="6. ä¼˜åŒ–rootViewControlleråŠ è½½"></a>6. ä¼˜åŒ–rootViewControlleråŠ è½½</h4><p>åœ¨didFinishLaunchingWithOptionsæ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¸€èˆ¬è¿›è¡Œåˆå§‹åŒ–ç¬¬ä¸‰æ–¹SDKã€è‡ªå·±çš„ä¸€äº›å·¥å…·ç±»çš„åˆå§‹åŒ–ã€ç„¶åå†åˆ°ç¬¬ä¸€ä¸ªç•Œé¢çš„æ¸²æŸ“ã€‚å…¶å®è¿™äº›ä¸œè¥¿ä¹Ÿå¯ä»¥åˆ†å¼€æ¥åšï¼š</p>
<p>1.æœ€å…ˆé…ç½®çš„äº‹ä»¶ï¼Œæ¯”å¦‚æ—¥å¿—ï¼Œç»Ÿè®¡ç­‰å¯ä»¥åœ¨æ²¡æœ‰è®¾ç½®rootViewControllerå‰è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<p>2.ç¬¬ä¸‰æ–¹SDKï¼Œæ¯”å¦‚æ¨é€ï¼Œæ”¯ä»˜SDkï¼Œç›´æ’­SDkçš„é›†æˆï¼Œå¯ä»¥åœ¨è®¾ç½®rootViewControlleråè¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸ä¼šå½±å“ç¬¬ä¸€ä¸ªè§†å›¾çš„åŠ è½½ï¼Œæ¯•ç«Ÿäººçš„è§†è§‰çœ‹åˆ°è§†å›¾å‡ºç°å¾ˆå¿«ï¼Œå°±ä¼šè§‰å¾—åŠ è½½å¾ˆå¿«ã€‚</p>
<p>3.å·¥å…·ç±»çš„åˆå§‹åŒ–é…ç½®ã€‚æ¯”å¦‚é›†æˆäº†IQKeyboardManager,éœ€è¦å¯åŠ¨çš„æ—¶å€™è¿›è¡Œå…¨å±€è®¾ç½®ï¼Œè¿™ä¸ªæ“ä½œå¯ä»¥æ”¾åœ¨ç¬¬ä¸€ä¸ªç•Œé¢çš„viewDidAppearï¼Œè¿™é‡Œå®Œå…¨ä¸ä¼šå½±å“åˆ°å¯åŠ¨æ—¶é—´ã€‚</p>
<p>æœ¬æ–‡åªæ˜¯ç®€å•ç®€è¿°äº†APPçš„å¯åŠ¨ï¼Œæ¯”å¦‚ç‚¹å‡»APPå›¾æ ‡åï¼ŒåŠ¨æ€åº“æ˜¯å¦‚ä½•é“¾æ¥åˆ°å†…å­˜ä¸­çš„ï¼Œä»£ç çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦‚ä½•åŠ è½½çš„ç­‰è¿™äº›è¿‡ç¨‹è¿˜éœ€æ›´æ·±å±‚æ¬¡çš„æ¢ç©¶ã€‚å¯¹äºä¼˜åŒ–å¯åŠ¨æ—¶é—´è¿™ä¸ªæ–¹é¢ï¼Œæˆ‘ä»¬åªèƒ½åšçš„å°±æ˜¯å†™å‡ºæ›´å¥½çš„ä»£ç ï¼Œä¼˜åŒ–é¡¹ç›®ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ocauxqtbu.bkt.clouddn.com/27563317749u=2381918280,2871499884&fm=21&gp=0.jpg"
               alt="Zhou Jian" />
          <p class="site-author-name" itemprop="name">Zhou Jian</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/coderZhou10496" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhou Jian</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"coderzhou"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Bw40KBIPanRkt0iqTr7NLT6I-gzGzoHsz", "MQjFPSYkEazqnUv2rS7TOsui");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
